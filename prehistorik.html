<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prehistorik - ê³ ì¸ëŒ1 ìŠ¤íƒ€ì¼ ì›¹ ê²Œì„</title>
    <style>
        /* ========== ê¸°ë³¸ ìŠ¤íƒ€ì¼ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(180deg, #2d1b0e 0%, #1a0f08 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }
        
        /* ê²Œì„ ì»¨í…Œì´ë„ˆ */
        #game-container {
            position: relative;
            border: 4px solid #8B4513;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8), inset 0 0 10px rgba(139,69,19,0.5);
        }
        
        canvas {
            display: block;
            background: #87CEEB;
        }
        
        /* HUD ì˜¤ë²„ë ˆì´ */
        #hud {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(0,0,0,0.7) 0%, transparent 100%);
            color: #FFD700;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
        }
        
        .hud-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .hud-label {
            color: #FFA500;
        }
        
        #food-bar-container {
            width: 100px;
            height: 12px;
            background: #333;
            border: 2px solid #FFD700;
            border-radius: 3px;
            overflow: hidden;
        }
        
        #food-bar {
            height: 100%;
            background: linear-gradient(90deg, #FF6B6B, #FF8E53);
            transition: width 0.3s;
        }
        
        /* ê²Œì„ ì˜¤ë²„ë ˆì´ (ì‹œì‘, ê²Œì„ì˜¤ë²„, ìŠ¤í…Œì´ì§€ ì „í™˜ ë“±) */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #FFD700;
            text-align: center;
        }
        
        #overlay.hidden {
            display: none;
        }
        
        #overlay h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 3px 3px 0 #8B4513;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        #overlay p {
            font-size: 18px;
            margin: 10px 0;
            color: #FFA500;
        }
        
        #overlay .subtitle {
            font-size: 14px;
            color: #CD853F;
            margin-top: 30px;
        }
        
        .btn {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 20px;
            background: linear-gradient(180deg, #8B4513 0%, #654321 100%);
            color: #FFD700;
            border: 3px solid #DAA520;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: linear-gradient(180deg, #A0522D 0%, #8B4513 100%);
            transform: translateY(-2px);
        }
        
        /* ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ */
        #mobile-controls {
            display: none;
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            padding: 0 20px;
            justify-content: space-between;
        }
        
        .mobile-btn {
            width: 60px;
            height: 60px;
            background: rgba(139,69,19,0.7);
            border: 3px solid #DAA520;
            border-radius: 50%;
            color: #FFD700;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .mobile-btn-group {
            display: flex;
            gap: 10px;
        }
        
        @media (max-width: 800px) {
            #mobile-controls {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game"></canvas>
        
        <!-- HUD -->
        <div id="hud">
            <div class="hud-item">
                <span class="hud-label">STAGE</span>
                <span id="stage-num">1</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">TIME</span>
                <span id="time-display">120</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">FOOD</span>
                <div id="food-bar-container">
                    <div id="food-bar" style="width: 0%"></div>
                </div>
            </div>
            <div class="hud-item">
                <span class="hud-label">LIVES</span>
                <span id="lives-display">â¤ï¸â¤ï¸â¤ï¸</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">SCORE</span>
                <span id="score-display">0</span>
            </div>
        </div>
        
        <!-- ì˜¤ë²„ë ˆì´ (ì‹œì‘í™”ë©´, ê²Œì„ì˜¤ë²„ ë“±) -->
        <div id="overlay">
            <h1>ğŸ¦´ PREHISTORIK ğŸ¦´</h1>
            <p>ì›ì‹œì¸ì˜ ëŒ€ëª¨í—˜!</p>
            <p>â† â†’ : ì´ë™ | â†‘ or Space : ì í”„</p>
            <p>ì ì„ ë°Ÿê±°ë‚˜ ë¶€ë”ªí˜€ì„œ ê³µê²©í•˜ì„¸ìš”!</p>
            <button class="btn" id="start-btn">ê²Œì„ ì‹œì‘</button>
            <p class="subtitle">TITUS 1991 ìŠ¤íƒ€ì¼ ì›¹ ë¦¬ë©”ì´í¬</p>
        </div>
        
        <!-- ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ -->
        <div id="mobile-controls">
            <div class="mobile-btn-group">
                <div class="mobile-btn" id="btn-left">â—€</div>
                <div class="mobile-btn" id="btn-right">â–¶</div>
            </div>
            <div class="mobile-btn" id="btn-jump">â–²</div>
        </div>
    </div>

    <script>
    // ==========================================
    // PREHISTORIK - ê³ ì¸ëŒ1 ìŠ¤íƒ€ì¼ ì›¹ ê²Œì„
    // Canvas ê¸°ë°˜ ì‚¬ì´ë“œìŠ¤í¬ë¡¤ ì•¡ì…˜ í”Œë«í¬ë¨¸
    // ==========================================

    (function() {
        'use strict';

        // ========== ìº”ë²„ìŠ¤ ì„¤ì • ==========
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        
        // ê²Œì„ í•´ìƒë„
        const GAME_WIDTH = 800;
        const GAME_HEIGHT = 500;
        canvas.width = GAME_WIDTH;
        canvas.height = GAME_HEIGHT;

        // ========== ê²Œì„ ìƒìˆ˜ ==========
        const GRAVITY = 0.6;           // ì¤‘ë ¥
        const PLAYER_SPEED = 5;        // í”Œë ˆì´ì–´ ì´ë™ ì†ë„
        const JUMP_FORCE = -14;        // ì í”„ë ¥
        const TILE_SIZE = 40;          // íƒ€ì¼ í¬ê¸°
        
        // ========== ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (ì›ì‹œì‹œëŒ€ í…Œë§ˆ) ==========
        const COLORS = {
            sky: '#87CEEB',            // í•˜ëŠ˜
            skyDark: '#4A90A4',        // ì–´ë‘ìš´ í•˜ëŠ˜
            ground: '#8B4513',         // ë•… (ê°ˆìƒ‰)
            groundDark: '#654321',     // ì–´ë‘ìš´ ë•…
            grass: '#228B22',          // í’€
            rock: '#808080',           // ë°”ìœ„
            rockDark: '#696969',       // ì–´ë‘ìš´ ë°”ìœ„
            wood: '#D2691E',           // ë‚˜ë¬´
            player: '#FFD39B',         // í”Œë ˆì´ì–´ í”¼ë¶€ìƒ‰
            playerHair: '#4A2000',     // í”Œë ˆì´ì–´ ë¨¸ë¦¬ì¹´ë½
            playerCloth: '#8B4513',    // í”Œë ˆì´ì–´ ì˜·
            enemy: '#FF6347',          // ì  (í† ë§ˆí† ìƒ‰)
            enemyDark: '#DC143C',      // ì–´ë‘ìš´ ì 
            dino: '#228B22',           // ê³µë£¡ (ë…¹ìƒ‰)
            dinoDark: '#006400',       // ì–´ë‘ìš´ ê³µë£¡
            boss: '#800080',           // ë³´ìŠ¤ (ë³´ë¼ìƒ‰)
            food: '#FF4500',           // ìŒì‹
            item: '#FFD700',           // ì•„ì´í…œ
            platform: '#A0522D',       // í”Œë«í¼
            cave: '#2F1810',           // ë™êµ´
            lava: '#FF4500',           // ìš©ì•”
            water: '#4169E1',          // ë¬¼
            goal: '#FFD700'            // ê³¨ì¸ ì§€ì 
        };

        // ========== ê²Œì„ ìƒíƒœ ==========
        let gameState = {
            screen: 'title',           // title, playing, paused, stageClear, gameOver, ending
            stage: 1,                  // í˜„ì¬ ìŠ¤í…Œì´ì§€ (1-7)
            score: 0,                  // ì ìˆ˜
            lives: 3,                  // ë‚¨ì€ ìƒëª…
            time: 120,                 // ë‚¨ì€ ì‹œê°„ (ì´ˆ)
            food: 0,                   // ìˆ˜ì§‘í•œ ìŒì‹
            foodRequired: 50,          // í´ë¦¬ì–´ì— í•„ìš”í•œ ìŒì‹
            cameraX: 0,                // ì¹´ë©”ë¼ X ìœ„ì¹˜
            lastTime: 0,               // ë§ˆì§€ë§‰ í”„ë ˆì„ ì‹œê°„
            deltaTime: 0,              // í”„ë ˆì„ ê°„ ì‹œê°„ì°¨
            timeAccumulator: 0,        // ì‹œê°„ ëˆ„ì ê¸°
            bossHP: 0,                 // ë³´ìŠ¤ HP
            bossMaxHP: 0,              // ë³´ìŠ¤ ìµœëŒ€ HP
            powerUpTimer: 0,           // íŒŒì›Œì—… íƒ€ì´ë¨¸
            hasPowerUp: false          // íŒŒì›Œì—… ìƒíƒœ
        };

        // ========== í”Œë ˆì´ì–´ ê°ì²´ ==========
        let player = {
            x: 100,
            y: 300,
            width: 32,
            height: 48,
            vx: 0,
            vy: 0,
            onGround: false,
            facing: 1,                 // 1: ì˜¤ë¥¸ìª½, -1: ì™¼ìª½
            attacking: false,
            attackTimer: 0,
            invincible: false,
            invincibleTimer: 0,
            animFrame: 0,
            animTimer: 0
        };

        // ========== ì…ë ¥ ìƒíƒœ ==========
        let keys = {
            left: false,
            right: false,
            up: false,
            space: false
        };

        // ========== ë ˆë²¨ ë°ì´í„° ==========
        let currentLevel = {
            width: 0,
            height: 0,
            tiles: [],
            platforms: [],
            enemies: [],
            items: [],
            goal: null,
            boss: null
        };

        // ========== íŒŒí‹°í´ ì‹œìŠ¤í…œ ==========
        let particles = [];

        // ========== UI ìš”ì†Œ ì°¸ì¡° ==========
        const overlay = document.getElementById('overlay');
        const startBtn = document.getElementById('start-btn');
        const stageNumEl = document.getElementById('stage-num');
        const timeDisplayEl = document.getElementById('time-display');
        const foodBarEl = document.getElementById('food-bar');
        const livesDisplayEl = document.getElementById('lives-display');
        const scoreDisplayEl = document.getElementById('score-display');

        // ==========================================
        // ë ˆë²¨ ìƒì„± í•¨ìˆ˜ë“¤
        // ==========================================

        /**
         * ëŸ° ìŠ¤í…Œì´ì§€ ìƒì„± (1, 3, 5, 7)
         * ì‚¬ì´ë“œìŠ¤í¬ë¡¤ í”Œë«í¼ ë ˆë²¨
         */
        function generateRunStage(stageNum) {
            const levelWidth = 3000 + stageNum * 500;  // ìŠ¤í…Œì´ì§€ê°€ ë†’ì„ìˆ˜ë¡ ê¸¸ì–´ì§
            const levelHeight = GAME_HEIGHT;
            
            currentLevel = {
                width: levelWidth,
                height: levelHeight,
                tiles: [],
                platforms: [],
                enemies: [],
                items: [],
                goal: { x: levelWidth - 100, y: levelHeight - 150, width: 60, height: 100 },
                boss: null,
                background: stageNum <= 3 ? 'jungle' : (stageNum === 5 ? 'cave' : 'mountain')
            };

            // ë°”ë‹¥ íƒ€ì¼ ìƒì„±
            const groundY = levelHeight - TILE_SIZE;
            for (let x = 0; x < levelWidth; x += TILE_SIZE) {
                // ê°€ë” êµ¬ë© ë§Œë“¤ê¸° (ì²« ë¶€ë¶„ê³¼ ë ë¶€ë¶„ ì œì™¸)
                if (x > 200 && x < levelWidth - 300 && Math.random() < 0.08) {
                    continue; // êµ¬ë©
                }
                currentLevel.tiles.push({
                    x: x,
                    y: groundY,
                    width: TILE_SIZE,
                    height: TILE_SIZE,
                    type: 'ground'
                });
            }

            // í”Œë«í¼ ìƒì„±
            const platformCount = Math.floor(levelWidth / 300);
            for (let i = 0; i < platformCount; i++) {
                const px = 300 + i * 300 + Math.random() * 100;
                const py = groundY - 80 - Math.random() * 150;
                const pWidth = 80 + Math.random() * 120;
                
                currentLevel.platforms.push({
                    x: px,
                    y: py,
                    width: pWidth,
                    height: 20,
                    type: Math.random() < 0.5 ? 'rock' : 'wood'
                });

                // í”Œë«í¼ ìœ„ì— ì•„ì´í…œ ë°°ì¹˜
                if (Math.random() < 0.6) {
                    spawnItem(px + pWidth / 2, py - 30);
                }
            }

            // ì  ìƒì„±
            const enemyCount = 5 + stageNum * 3;
            for (let i = 0; i < enemyCount; i++) {
                const ex = 400 + Math.random() * (levelWidth - 600);
                const ey = groundY - 40;
                const type = Math.random() < 0.7 ? 'caveman' : 'dino';
                
                currentLevel.enemies.push(createEnemy(ex, ey, type));
            }

            // ë°”ë‹¥ ì•„ì´í…œ ìƒì„±
            const itemCount = 15 + stageNum * 5;
            for (let i = 0; i < itemCount; i++) {
                const ix = 200 + Math.random() * (levelWidth - 400);
                const iy = groundY - 30;
                spawnItem(ix, iy);
            }

            // í”Œë ˆì´ì–´ ì´ˆê¸° ìœ„ì¹˜
            player.x = 100;
            player.y = groundY - player.height - 10;
            player.vx = 0;
            player.vy = 0;
            player.onGround = false;

            // ì¹´ë©”ë¼ ì´ˆê¸°í™”
            gameState.cameraX = 0;
            
            // ìŒì‹ ìš”êµ¬ëŸ‰ ì„¤ì •
            gameState.foodRequired = 40 + stageNum * 10;
            gameState.food = 0;
            gameState.time = 120 + stageNum * 10;
        }

        /**
         * ë³´ìŠ¤ ìŠ¤í…Œì´ì§€ ìƒì„± (2, 4, 6)
         * ê³ ì •ëœ ì•„ë ˆë‚˜ì—ì„œ ë³´ìŠ¤ì „
         */
        function generateBossStage(stageNum) {
            const levelWidth = GAME_WIDTH;
            const levelHeight = GAME_HEIGHT;
            
            currentLevel = {
                width: levelWidth,
                height: levelHeight,
                tiles: [],
                platforms: [],
                enemies: [],
                items: [],
                goal: null,
                boss: null,
                background: stageNum === 2 ? 'cave' : (stageNum === 4 ? 'volcano' : 'castle')
            };

            // ë°”ë‹¥ ìƒì„±
            const groundY = levelHeight - TILE_SIZE;
            for (let x = 0; x < levelWidth; x += TILE_SIZE) {
                currentLevel.tiles.push({
                    x: x,
                    y: groundY,
                    width: TILE_SIZE,
                    height: TILE_SIZE,
                    type: 'ground'
                });
            }

            // ì¸¡ë©´ ë²½
            for (let y = 0; y < levelHeight; y += TILE_SIZE) {
                currentLevel.tiles.push({ x: 0, y: y, width: TILE_SIZE, height: TILE_SIZE, type: 'wall' });
                currentLevel.tiles.push({ x: levelWidth - TILE_SIZE, y: y, width: TILE_SIZE, height: TILE_SIZE, type: 'wall' });
            }

            // í”Œë«í¼ ëª‡ ê°œ ì¶”ê°€
            currentLevel.platforms.push({ x: 150, y: groundY - 100, width: 100, height: 20, type: 'rock' });
            currentLevel.platforms.push({ x: 550, y: groundY - 100, width: 100, height: 20, type: 'rock' });
            currentLevel.platforms.push({ x: 350, y: groundY - 180, width: 100, height: 20, type: 'rock' });

            // ë³´ìŠ¤ ìƒì„±
            const bossType = stageNum === 2 ? 'mammoth' : (stageNum === 4 ? 'trex' : 'giant');
            currentLevel.boss = createBoss(levelWidth - 150, groundY - 100, bossType, stageNum);
            
            gameState.bossHP = currentLevel.boss.hp;
            gameState.bossMaxHP = currentLevel.boss.hp;

            // í”Œë ˆì´ì–´ ìœ„ì¹˜
            player.x = 100;
            player.y = groundY - player.height - 10;
            player.vx = 0;
            player.vy = 0;

            gameState.cameraX = 0;
            gameState.time = 180; // ë³´ìŠ¤ì „ì€ ì‹œê°„ ë„‰ë„‰í•˜ê²Œ
            gameState.food = gameState.foodRequired; // ë³´ìŠ¤ì „ì€ ìŒì‹ í•„ìš” ì—†ìŒ
        }

        /**
         * ì  ìƒì„±
         */
        function createEnemy(x, y, type) {
            const enemy = {
                x: x,
                y: y,
                width: type === 'dino' ? 50 : 32,
                height: type === 'dino' ? 40 : 40,
                vx: (Math.random() < 0.5 ? -1 : 1) * (1 + Math.random()),
                vy: 0,
                type: type,
                hp: type === 'dino' ? 2 : 1,
                alive: true,
                stunned: false,
                stunTimer: 0,
                animFrame: 0,
                animTimer: 0,
                patrolLeft: x - 100,
                patrolRight: x + 100
            };
            return enemy;
        }

        /**
         * ë³´ìŠ¤ ìƒì„±
         */
        function createBoss(x, y, type, stageNum) {
            const boss = {
                x: x,
                y: y,
                width: 80,
                height: 80,
                vx: 0,
                vy: 0,
                type: type,
                hp: 10 + stageNum * 5,
                maxHP: 10 + stageNum * 5,
                alive: true,
                phase: 1,
                attackTimer: 0,
                attackCooldown: 120,
                pattern: 0,
                animFrame: 0,
                animTimer: 0,
                invincible: false,
                invincibleTimer: 0
            };
            
            // ë³´ìŠ¤ íƒ€ì…ë³„ í¬ê¸° ì¡°ì •
            if (type === 'mammoth') {
                boss.width = 100;
                boss.height = 80;
            } else if (type === 'trex') {
                boss.width = 120;
                boss.height = 100;
            } else if (type === 'giant') {
                boss.width = 90;
                boss.height = 120;
            }
            
            return boss;
        }

        /**
         * ì•„ì´í…œ ìƒì„±
         */
        function spawnItem(x, y) {
            const rand = Math.random();
            let type;
            
            if (rand < 0.5) {
                type = 'food';      // 50% ìŒì‹
            } else if (rand < 0.65) {
                type = 'clock';     // 15% ì‹œê³„
            } else if (rand < 0.75) {
                type = 'life';      // 10% ìƒëª…
            } else if (rand < 0.85) {
                type = 'bomb';      // 10% í­íƒ„
            } else if (rand < 0.95) {
                type = 'axe';       // 10% ë„ë¼
            } else {
                type = 'spring';    // 5% ìŠ¤í”„ë§
            }
            
            currentLevel.items.push({
                x: x,
                y: y,
                width: 24,
                height: 24,
                type: type,
                collected: false,
                animTimer: Math.random() * Math.PI * 2
            });
        }

        // ==========================================
        // ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
        // ==========================================

        /**
         * ë©”ì¸ ê²Œì„ ì—…ë°ì´íŠ¸
         */
        function update(deltaTime) {
            if (gameState.screen !== 'playing') return;

            // ì‹œê°„ ì—…ë°ì´íŠ¸
            gameState.timeAccumulator += deltaTime;
            if (gameState.timeAccumulator >= 1000) {
                gameState.timeAccumulator -= 1000;
                gameState.time--;
                
                if (gameState.time <= 0) {
                    loseLife();
                }
            }

            // íŒŒì›Œì—… íƒ€ì´ë¨¸
            if (gameState.hasPowerUp) {
                gameState.powerUpTimer -= deltaTime;
                if (gameState.powerUpTimer <= 0) {
                    gameState.hasPowerUp = false;
                }
            }

            // í”Œë ˆì´ì–´ ì—…ë°ì´íŠ¸
            updatePlayer(deltaTime);
            
            // ì  ì—…ë°ì´íŠ¸
            updateEnemies(deltaTime);
            
            // ë³´ìŠ¤ ì—…ë°ì´íŠ¸
            if (currentLevel.boss && currentLevel.boss.alive) {
                updateBoss(deltaTime);
            }
            
            // ì•„ì´í…œ ì—…ë°ì´íŠ¸
            updateItems(deltaTime);
            
            // íŒŒí‹°í´ ì—…ë°ì´íŠ¸
            updateParticles(deltaTime);
            
            // ì¹´ë©”ë¼ ì—…ë°ì´íŠ¸
            updateCamera();
            
            // í´ë¦¬ì–´ ì²´í¬
            checkStageClear();
            
            // HUD ì—…ë°ì´íŠ¸
            updateHUD();
        }

        /**
         * í”Œë ˆì´ì–´ ì—…ë°ì´íŠ¸
         */
        function updatePlayer(deltaTime) {
            // ì´ë™ ì…ë ¥ ì²˜ë¦¬
            if (keys.left) {
                player.vx = -PLAYER_SPEED;
                player.facing = -1;
            } else if (keys.right) {
                player.vx = PLAYER_SPEED;
                player.facing = 1;
            } else {
                player.vx *= 0.8; // ë§ˆì°°
                if (Math.abs(player.vx) < 0.1) player.vx = 0;
            }

            // ì í”„
            if ((keys.up || keys.space) && player.onGround) {
                player.vy = gameState.hasPowerUp ? JUMP_FORCE * 1.3 : JUMP_FORCE;
                player.onGround = false;
                spawnParticles(player.x + player.width / 2, player.y + player.height, 'dust', 5);
            }

            // ì¤‘ë ¥ ì ìš©
            player.vy += GRAVITY;
            if (player.vy > 15) player.vy = 15; // ìµœëŒ€ ë‚™í•˜ ì†ë„

            // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            player.x += player.vx;
            player.y += player.vy;

            // ì¶©ëŒ ê²€ì‚¬
            player.onGround = false;
            
            // íƒ€ì¼ ì¶©ëŒ
            for (const tile of currentLevel.tiles) {
                resolveCollision(player, tile);
            }
            
            // í”Œë«í¼ ì¶©ëŒ
            for (const platform of currentLevel.platforms) {
                resolvePlatformCollision(player, platform);
            }

            // í™”ë©´ ê²½ê³„
            if (player.x < 0) player.x = 0;
            if (player.x > currentLevel.width - player.width) {
                player.x = currentLevel.width - player.width;
            }
            
            // ë‚™ì‚¬ ì²˜ë¦¬
            if (player.y > currentLevel.height + 100) {
                loseLife();
            }

            // ë¬´ì  íƒ€ì´ë¨¸
            if (player.invincible) {
                player.invincibleTimer -= deltaTime;
                if (player.invincibleTimer <= 0) {
                    player.invincible = false;
                }
            }

            // ê³µê²© íƒ€ì´ë¨¸
            if (player.attacking) {
                player.attackTimer -= deltaTime;
                if (player.attackTimer <= 0) {
                    player.attacking = false;
                }
            }

            // ì• ë‹ˆë©”ì´ì…˜
            player.animTimer += deltaTime;
            if (player.animTimer > 100) {
                player.animTimer = 0;
                player.animFrame = (player.animFrame + 1) % 4;
            }
        }

        /**
         * ì  ì—…ë°ì´íŠ¸
         */
        function updateEnemies(deltaTime) {
            for (const enemy of currentLevel.enemies) {
                if (!enemy.alive) continue;

                // ê¸°ì ˆ ìƒíƒœ
                if (enemy.stunned) {
                    enemy.stunTimer -= deltaTime;
                    if (enemy.stunTimer <= 0) {
                        enemy.stunned = false;
                    }
                    continue;
                }

                // ì´ë™ (íŒ¨íŠ¸ë¡¤)
                enemy.x += enemy.vx;
                
                // íŒ¨íŠ¸ë¡¤ ë²”ìœ„ ì²´í¬
                if (enemy.x < enemy.patrolLeft || enemy.x > enemy.patrolRight) {
                    enemy.vx *= -1;
                }

                // ì¤‘ë ¥
                enemy.vy += GRAVITY;
                enemy.y += enemy.vy;

                // ë°”ë‹¥ ì¶©ëŒ
                for (const tile of currentLevel.tiles) {
                    if (checkCollision(enemy, tile)) {
                        if (enemy.vy > 0) {
                            enemy.y = tile.y - enemy.height;
                            enemy.vy = 0;
                        }
                    }
                }

                // í”Œë ˆì´ì–´ì™€ ì¶©ëŒ
                if (checkCollision(player, enemy) && !player.invincible) {
                    // ìœ„ì—ì„œ ë°Ÿìœ¼ë©´ ì  ê³µê²©
                    if (player.vy > 0 && player.y + player.height < enemy.y + enemy.height / 2) {
                        hitEnemy(enemy);
                        player.vy = JUMP_FORCE * 0.6; // ë°Ÿê³  íŠ•ê¹€
                    } else {
                        // í”¼ê²©
                        loseLife();
                    }
                }

                // ì• ë‹ˆë©”ì´ì…˜
                enemy.animTimer += deltaTime;
                if (enemy.animTimer > 150) {
                    enemy.animTimer = 0;
                    enemy.animFrame = (enemy.animFrame + 1) % 2;
                }
            }
        }

        /**
         * ë³´ìŠ¤ ì—…ë°ì´íŠ¸
         */
        function updateBoss(deltaTime) {
            const boss = currentLevel.boss;
            if (!boss || !boss.alive) return;

            // ë¬´ì  íƒ€ì´ë¨¸
            if (boss.invincible) {
                boss.invincibleTimer -= deltaTime;
                if (boss.invincibleTimer <= 0) {
                    boss.invincible = false;
                }
            }

            // ê³µê²© ì¿¨ë‹¤ìš´
            boss.attackTimer += deltaTime;

            // ë³´ìŠ¤ AI íŒ¨í„´
            const distToPlayer = player.x - boss.x;
            
            // í˜ì´ì¦ˆ ì²´í¬ (HP 50% ì´í•˜ë©´ 2í˜ì´ì¦ˆ)
            if (boss.hp <= boss.maxHP / 2) {
                boss.phase = 2;
                boss.attackCooldown = 80; // ë” ë¹ ë¥¸ ê³µê²©
            }

            // íŒ¨í„´ ì‹¤í–‰
            if (boss.attackTimer >= boss.attackCooldown) {
                boss.attackTimer = 0;
                executeBossPattern(boss);
            }

            // í”Œë ˆì´ì–´ ìª½ìœ¼ë¡œ ì²œì²œíˆ ì´ë™
            if (Math.abs(distToPlayer) > 100) {
                boss.vx = distToPlayer > 0 ? 1.5 : -1.5;
            } else {
                boss.vx *= 0.9;
            }

            boss.x += boss.vx;
            boss.y += boss.vy;

            // ê²½ê³„ ì²´í¬
            if (boss.x < TILE_SIZE) boss.x = TILE_SIZE;
            if (boss.x > GAME_WIDTH - boss.width - TILE_SIZE) {
                boss.x = GAME_WIDTH - boss.width - TILE_SIZE;
            }

            // ë°”ë‹¥ ì¶©ëŒ
            const groundY = GAME_HEIGHT - TILE_SIZE - boss.height;
            if (boss.y > groundY) {
                boss.y = groundY;
                boss.vy = 0;
            }

            // í”Œë ˆì´ì–´ ì¶©ëŒ
            if (checkCollision(player, boss) && !player.invincible) {
                if (player.vy > 0 && player.y + player.height < boss.y + boss.height / 3 && !boss.invincible) {
                    hitBoss();
                    player.vy = JUMP_FORCE * 0.7;
                } else {
                    loseLife();
                }
            }

            // ì• ë‹ˆë©”ì´ì…˜
            boss.animTimer += deltaTime;
            if (boss.animTimer > 200) {
                boss.animTimer = 0;
                boss.animFrame = (boss.animFrame + 1) % 2;
            }
        }

        /**
         * ë³´ìŠ¤ ê³µê²© íŒ¨í„´ ì‹¤í–‰
         */
        function executeBossPattern(boss) {
            boss.pattern = (boss.pattern + 1) % 3;
            
            switch (boss.pattern) {
                case 0: // ëŒì§„
                    boss.vx = player.x > boss.x ? 8 : -8;
                    break;
                case 1: // ì í”„
                    boss.vy = -12;
                    break;
                case 2: // ë¯¸ë‹ˆì–¸ ì†Œí™˜ (2í˜ì´ì¦ˆ)
                    if (boss.phase === 2) {
                        const ex = boss.x + (Math.random() < 0.5 ? -50 : boss.width + 50);
                        const ey = GAME_HEIGHT - TILE_SIZE - 40;
                        currentLevel.enemies.push(createEnemy(ex, ey, 'caveman'));
                    }
                    break;
            }
        }

        /**
         * ì•„ì´í…œ ì—…ë°ì´íŠ¸
         */
        function updateItems(deltaTime) {
            for (const item of currentLevel.items) {
                if (item.collected) continue;

                // ë– ë‹¤ë‹ˆëŠ” ì• ë‹ˆë©”ì´ì…˜
                item.animTimer += deltaTime * 0.003;
                const floatY = Math.sin(item.animTimer) * 3;

                // í”Œë ˆì´ì–´ ì¶©ëŒ
                const itemBox = {
                    x: item.x,
                    y: item.y + floatY,
                    width: item.width,
                    height: item.height
                };

                if (checkCollision(player, itemBox)) {
                    collectItem(item);
                }
            }
        }

        /**
         * ì•„ì´í…œ ìˆ˜ì§‘
         */
        function collectItem(item) {
            item.collected = true;
            gameState.score += 100;
            
            spawnParticles(item.x + item.width / 2, item.y, 'sparkle', 8);

            switch (item.type) {
                case 'food':
                    gameState.food += 10;
                    gameState.score += 50;
                    break;
                case 'clock':
                    gameState.time += 15;
                    break;
                case 'life':
                    gameState.lives = Math.min(gameState.lives + 1, 5);
                    break;
                case 'bomb':
                    // ëª¨ë“  ì  ê¸°ì ˆ
                    for (const enemy of currentLevel.enemies) {
                        if (enemy.alive && !enemy.stunned) {
                            enemy.stunned = true;
                            enemy.stunTimer = 3000;
                        }
                    }
                    spawnParticles(player.x, player.y, 'explosion', 20);
                    break;
                case 'axe':
                    // ê°€ì¥ ê°€ê¹Œìš´ ì  ì²˜ì¹˜
                    let closest = null;
                    let minDist = Infinity;
                    for (const enemy of currentLevel.enemies) {
                        if (enemy.alive) {
                            const dist = Math.abs(enemy.x - player.x);
                            if (dist < minDist) {
                                minDist = dist;
                                closest = enemy;
                            }
                        }
                    }
                    if (closest) {
                        closest.alive = false;
                        gameState.score += 200;
                        spawnParticles(closest.x + closest.width / 2, closest.y, 'blood', 10);
                    }
                    break;
                case 'spring':
                    gameState.hasPowerUp = true;
                    gameState.powerUpTimer = 10000; // 10ì´ˆ
                    break;
            }
        }

        /**
         * ì  ê³µê²©
         */
        function hitEnemy(enemy) {
            enemy.hp--;
            enemy.stunned = true;
            enemy.stunTimer = 500;
            gameState.score += 100;
            
            spawnParticles(enemy.x + enemy.width / 2, enemy.y, 'blood', 5);
            
            if (enemy.hp <= 0) {
                enemy.alive = false;
                gameState.score += 200;
                
                // ê°€ë” ì•„ì´í…œ ë“œë¡­
                if (Math.random() < 0.3) {
                    spawnItem(enemy.x + enemy.width / 2, enemy.y);
                }
            }
        }

        /**
         * ë³´ìŠ¤ ê³µê²©
         */
        function hitBoss() {
            const boss = currentLevel.boss;
            if (boss.invincible) return;
            
            boss.hp--;
            boss.invincible = true;
            boss.invincibleTimer = 500;
            gameState.bossHP = boss.hp;
            gameState.score += 500;
            
            spawnParticles(boss.x + boss.width / 2, boss.y, 'blood', 10);
            
            if (boss.hp <= 0) {
                boss.alive = false;
                gameState.score += 5000;
                spawnParticles(boss.x + boss.width / 2, boss.y + boss.height / 2, 'explosion', 30);
            }
        }

        /**
         * ìƒëª… ìƒê¸°
         */
        function loseLife() {
            if (player.invincible) return;
            
            gameState.lives--;
            player.invincible = true;
            player.invincibleTimer = 2000;
            
            spawnParticles(player.x + player.width / 2, player.y + player.height / 2, 'blood', 10);
            
            if (gameState.lives <= 0) {
                gameOver();
            } else {
                // ë¦¬ìŠ¤í°
                player.x = 100;
                player.y = GAME_HEIGHT - TILE_SIZE - player.height - 10;
                player.vx = 0;
                player.vy = 0;
                gameState.cameraX = 0;
            }
        }

        /**
         * íŒŒí‹°í´ ì—…ë°ì´íŠ¸
         */
        function updateParticles(deltaTime) {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.2; // ì¤‘ë ¥
                p.life -= deltaTime;
                p.alpha = Math.max(0, p.life / p.maxLife);
                
                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }

        /**
         * íŒŒí‹°í´ ìƒì„±
         */
        function spawnParticles(x, y, type, count) {
            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 2 + Math.random() * 4;
                
                let color;
                switch (type) {
                    case 'dust': color = '#8B4513'; break;
                    case 'blood': color = '#FF0000'; break;
                    case 'sparkle': color = '#FFD700'; break;
                    case 'explosion': color = Math.random() < 0.5 ? '#FF4500' : '#FFD700'; break;
                    default: color = '#FFFFFF';
                }
                
                particles.push({
                    x: x,
                    y: y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 2,
                    size: 3 + Math.random() * 4,
                    color: color,
                    life: 500 + Math.random() * 500,
                    maxLife: 1000,
                    alpha: 1
                });
            }
        }

        /**
         * ì¹´ë©”ë¼ ì—…ë°ì´íŠ¸
         */
        function updateCamera() {
            // í”Œë ˆì´ì–´ë¥¼ í™”ë©´ ì¤‘ì•™ì— ìœ ì§€
            const targetX = player.x - GAME_WIDTH / 3;
            gameState.cameraX += (targetX - gameState.cameraX) * 0.1;
            
            // ê²½ê³„ ì œí•œ
            if (gameState.cameraX < 0) gameState.cameraX = 0;
            if (gameState.cameraX > currentLevel.width - GAME_WIDTH) {
                gameState.cameraX = currentLevel.width - GAME_WIDTH;
            }
        }

        /**
         * ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì²´í¬
         */
        function checkStageClear() {
            const isRunStage = gameState.stage % 2 === 1;
            
            if (isRunStage) {
                // ëŸ° ìŠ¤í…Œì´ì§€: ê³¨ì¸ ì§€ì  ë„ë‹¬ + ìŒì‹ ì¶©ë¶„
                const goal = currentLevel.goal;
                if (goal && checkCollision(player, goal)) {
                    if (gameState.food >= gameState.foodRequired) {
                        stageClear();
                    }
                }
            } else {
                // ë³´ìŠ¤ ìŠ¤í…Œì´ì§€: ë³´ìŠ¤ ì²˜ì¹˜
                if (currentLevel.boss && !currentLevel.boss.alive) {
                    stageClear();
                }
            }
        }

        /**
         * ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´
         */
        function stageClear() {
            gameState.score += gameState.time * 100; // ì‹œê°„ ë³´ë„ˆìŠ¤
            
            if (gameState.stage >= 7) {
                // ì—”ë”©
                gameState.screen = 'ending';
                showOverlay('ğŸ‰ CONGRATULATIONS! ğŸ‰', 
                    `ëª¨ë“  ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤!\nìµœì¢… ì ìˆ˜: ${gameState.score}`, 
                    'ë‹¤ì‹œ ì‹œì‘', startGame);
            } else {
                gameState.stage++;
                gameState.screen = 'stageClear';
                showOverlay(`STAGE ${gameState.stage - 1} CLEAR!`, 
                    `ì ìˆ˜: ${gameState.score}`, 
                    'ë‹¤ìŒ ìŠ¤í…Œì´ì§€', () => {
                        loadStage(gameState.stage);
                        gameState.screen = 'playing';
                        hideOverlay();
                    });
            }
        }

        /**
         * ê²Œì„ ì˜¤ë²„
         */
        function gameOver() {
            gameState.screen = 'gameOver';
            showOverlay('ğŸ’€ GAME OVER ğŸ’€', 
                `ìµœì¢… ì ìˆ˜: ${gameState.score}`, 
                'ë‹¤ì‹œ ì‹œì‘', startGame);
        }

        /**
         * HUD ì—…ë°ì´íŠ¸
         */
        function updateHUD() {
            stageNumEl.textContent = gameState.stage;
            timeDisplayEl.textContent = gameState.time;
            timeDisplayEl.style.color = gameState.time <= 30 ? '#FF0000' : '#FFD700';
            
            const foodPercent = Math.min(100, (gameState.food / gameState.foodRequired) * 100);
            foodBarEl.style.width = foodPercent + '%';
            foodBarEl.style.background = foodPercent >= 100 ? 
                'linear-gradient(90deg, #00FF00, #32CD32)' : 
                'linear-gradient(90deg, #FF6B6B, #FF8E53)';
            
            let hearts = '';
            for (let i = 0; i < gameState.lives; i++) hearts += 'â¤ï¸';
            for (let i = gameState.lives; i < 5; i++) hearts += 'ğŸ–¤';
            livesDisplayEl.textContent = hearts;
            
            scoreDisplayEl.textContent = gameState.score;
        }

        // ==========================================
        // ì¶©ëŒ ê²€ì‚¬ í•¨ìˆ˜ë“¤
        // ==========================================

        /**
         * AABB ì¶©ëŒ ê²€ì‚¬
         */
        function checkCollision(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }

        /**
         * íƒ€ì¼ ì¶©ëŒ í•´ê²°
         */
        function resolveCollision(entity, tile) {
            if (!checkCollision(entity, tile)) return;

            const overlapX = Math.min(
                entity.x + entity.width - tile.x,
                tile.x + tile.width - entity.x
            );
            const overlapY = Math.min(
                entity.y + entity.height - tile.y,
                tile.y + tile.height - entity.y
            );

            if (overlapX < overlapY) {
                // ìˆ˜í‰ ì¶©ëŒ
                if (entity.x < tile.x) {
                    entity.x = tile.x - entity.width;
                } else {
                    entity.x = tile.x + tile.width;
                }
                entity.vx = 0;
            } else {
                // ìˆ˜ì§ ì¶©ëŒ
                if (entity.y < tile.y) {
                    entity.y = tile.y - entity.height;
                    entity.vy = 0;
                    entity.onGround = true;
                } else {
                    entity.y = tile.y + tile.height;
                    entity.vy = 0;
                }
            }
        }

        /**
         * í”Œë«í¼ ì¶©ëŒ (ìœ„ì—ì„œë§Œ ì°©ì§€)
         */
        function resolvePlatformCollision(entity, platform) {
            if (entity.vy < 0) return; // ìœ„ë¡œ ì˜¬ë¼ê°ˆ ë•ŒëŠ” í†µê³¼
            
            if (entity.x + entity.width > platform.x && 
                entity.x < platform.x + platform.width &&
                entity.y + entity.height > platform.y &&
                entity.y + entity.height < platform.y + platform.height + entity.vy + 5) {
                
                entity.y = platform.y - entity.height;
                entity.vy = 0;
                entity.onGround = true;
            }
        }

        // ==========================================
        // ë Œë”ë§ í•¨ìˆ˜ë“¤
        // ==========================================

        /**
         * ë©”ì¸ ë Œë”ë§
         */
        function render() {
            // ë°°ê²½ ê·¸ë¦¬ê¸°
            drawBackground();
            
            // ì¹´ë©”ë¼ ë³€í™˜ ì ìš©
            ctx.save();
            ctx.translate(-gameState.cameraX, 0);
            
            // íƒ€ì¼ ê·¸ë¦¬ê¸°
            drawTiles();
            
            // í”Œë«í¼ ê·¸ë¦¬ê¸°
            drawPlatforms();
            
            // ì•„ì´í…œ ê·¸ë¦¬ê¸°
            drawItems();
            
            // ì  ê·¸ë¦¬ê¸°
            drawEnemies();
            
            // ë³´ìŠ¤ ê·¸ë¦¬ê¸°
            if (currentLevel.boss) {
                drawBoss();
            }
            
            // ê³¨ì¸ ì§€ì  ê·¸ë¦¬ê¸°
            if (currentLevel.goal) {
                drawGoal();
            }
            
            // í”Œë ˆì´ì–´ ê·¸ë¦¬ê¸°
            drawPlayer();
            
            // íŒŒí‹°í´ ê·¸ë¦¬ê¸°
            drawParticles();
            
            ctx.restore();
            
            // ë³´ìŠ¤ì „ HPë°”
            if (currentLevel.boss && currentLevel.boss.alive) {
                drawBossHPBar();
            }
        }

        /**
         * ë°°ê²½ ê·¸ë¦¬ê¸°
         */
        function drawBackground() {
            const bg = currentLevel.background || 'jungle';
            
            // í•˜ëŠ˜ ê·¸ë¼ë°ì´ì…˜
            const gradient = ctx.createLinearGradient(0, 0, 0, GAME_HEIGHT);
            
            switch (bg) {
                case 'jungle':
                    gradient.addColorStop(0, '#87CEEB');
                    gradient.addColorStop(0.7, '#90EE90');
                    gradient.addColorStop(1, '#228B22');
                    break;
                case 'cave':
                    gradient.addColorStop(0, '#1a0a00');
                    gradient.addColorStop(0.5, '#2d1810');
                    gradient.addColorStop(1, '#3d2820');
                    break;
                case 'volcano':
                    gradient.addColorStop(0, '#4A0000');
                    gradient.addColorStop(0.5, '#8B0000');
                    gradient.addColorStop(1, '#FF4500');
                    break;
                case 'mountain':
                    gradient.addColorStop(0, '#4A90A4');
                    gradient.addColorStop(0.5, '#87CEEB');
                    gradient.addColorStop(1, '#808080');
                    break;
                case 'castle':
                    gradient.addColorStop(0, '#2F2F4F');
                    gradient.addColorStop(0.5, '#4F4F6F');
                    gradient.addColorStop(1, '#696969');
                    break;
                default:
                    gradient.addColorStop(0, '#87CEEB');
                    gradient.addColorStop(1, '#E0F7FA');
            }
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            
            // ë°°ê²½ ì‚° (íŒ¨ëŸ´ë™ìŠ¤)
            drawBackgroundMountains();
            
            // êµ¬ë¦„ (íŒ¨ëŸ´ë™ìŠ¤)
            drawClouds();
        }

        /**
         * ë°°ê²½ ì‚° ê·¸ë¦¬ê¸°
         */
        function drawBackgroundMountains() {
            const offsetX = gameState.cameraX * 0.3;
            
            ctx.fillStyle = '#6B8E6B';
            for (let i = 0; i < 5; i++) {
                const x = i * 300 - (offsetX % 300);
                ctx.beginPath();
                ctx.moveTo(x, GAME_HEIGHT - 100);
                ctx.lineTo(x + 150, GAME_HEIGHT - 250);
                ctx.lineTo(x + 300, GAME_HEIGHT - 100);
                ctx.fill();
            }
            
            ctx.fillStyle = '#4A654A';
            for (let i = 0; i < 6; i++) {
                const x = i * 250 - 100 - (offsetX * 0.5 % 250);
                ctx.beginPath();
                ctx.moveTo(x, GAME_HEIGHT - 80);
                ctx.lineTo(x + 100, GAME_HEIGHT - 180);
                ctx.lineTo(x + 200, GAME_HEIGHT - 80);
                ctx.fill();
            }
        }

        /**
         * êµ¬ë¦„ ê·¸ë¦¬ê¸°
         */
        function drawClouds() {
            const offsetX = gameState.cameraX * 0.1;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            
            for (let i = 0; i < 8; i++) {
                const x = i * 200 - (offsetX % 200);
                const y = 30 + (i % 3) * 40;
                
                ctx.beginPath();
                ctx.arc(x, y, 25, 0, Math.PI * 2);
                ctx.arc(x + 25, y - 10, 20, 0, Math.PI * 2);
                ctx.arc(x + 50, y, 25, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        /**
         * íƒ€ì¼ ê·¸ë¦¬ê¸°
         */
        function drawTiles() {
            for (const tile of currentLevel.tiles) {
                // í™”ë©´ ë°– íƒ€ì¼ ìŠ¤í‚µ
                if (tile.x + tile.width < gameState.cameraX || 
                    tile.x > gameState.cameraX + GAME_WIDTH) continue;
                
                if (tile.type === 'ground') {
                    // ë•…
                    ctx.fillStyle = COLORS.ground;
                    ctx.fillRect(tile.x, tile.y, tile.width, tile.height);
                    
                    // í’€
                    ctx.fillStyle = COLORS.grass;
                    ctx.fillRect(tile.x, tile.y, tile.width, 8);
                    
                    // í…ìŠ¤ì²˜
                    ctx.fillStyle = COLORS.groundDark;
                    for (let i = 0; i < 3; i++) {
                        const dx = tile.x + 5 + i * 12;
                        const dy = tile.y + 15 + (i % 2) * 10;
                        ctx.fillRect(dx, dy, 6, 4);
                    }
                } else if (tile.type === 'wall') {
                    // ë²½
                    ctx.fillStyle = COLORS.rock;
                    ctx.fillRect(tile.x, tile.y, tile.width, tile.height);
                    
                    // ë²½ëŒ íŒ¨í„´
                    ctx.strokeStyle = COLORS.rockDark;
                    ctx.lineWidth = 2;
                    ctx.strokeRect(tile.x + 2, tile.y + 2, tile.width - 4, tile.height / 2 - 2);
                    ctx.strokeRect(tile.x + 2, tile.y + tile.height / 2 + 2, tile.width - 4, tile.height / 2 - 4);
                }
            }
        }

        /**
         * í”Œë«í¼ ê·¸ë¦¬ê¸°
         */
        function drawPlatforms() {
            for (const platform of currentLevel.platforms) {
                if (platform.x + platform.width < gameState.cameraX || 
                    platform.x > gameState.cameraX + GAME_WIDTH) continue;
                
                if (platform.type === 'rock') {
                    ctx.fillStyle = COLORS.rock;
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    ctx.fillStyle = COLORS.rockDark;
                    ctx.fillRect(platform.x + 3, platform.y + 5, platform.width - 6, platform.height - 8);
                } else {
                    ctx.fillStyle = COLORS.wood;
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    // ë‚˜ë¬´ ê²°
                    ctx.strokeStyle = '#8B4513';
                    ctx.lineWidth = 1;
                    for (let i = 0; i < platform.width; i += 15) {
                        ctx.beginPath();
                        ctx.moveTo(platform.x + i, platform.y);
                        ctx.lineTo(platform.x + i, platform.y + platform.height);
                        ctx.stroke();
                    }
                }
            }
        }

        /**
         * ì•„ì´í…œ ê·¸ë¦¬ê¸°
         */
        function drawItems() {
            for (const item of currentLevel.items) {
                if (item.collected) continue;
                if (item.x + item.width < gameState.cameraX || 
                    item.x > gameState.cameraX + GAME_WIDTH) continue;
                
                const floatY = Math.sin(item.animTimer) * 3;
                const x = item.x;
                const y = item.y + floatY;
                
                ctx.save();
                ctx.translate(x + item.width / 2, y + item.height / 2);
                
                // ì•„ì´í…œ íƒ€ì…ë³„ ê·¸ë¦¬ê¸°
                switch (item.type) {
                    case 'food':
                        // ê³ ê¸°
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(-8, -3, 16, 6);
                        ctx.fillStyle = COLORS.food;
                        ctx.beginPath();
                        ctx.ellipse(-6, 0, 6, 8, 0, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.fillStyle = '#FFF8DC';
                        ctx.beginPath();
                        ctx.arc(-6, 0, 3, 0, Math.PI * 2);
                        ctx.fill();
                        break;
                    case 'clock':
                        // ì‹œê³„
                        ctx.fillStyle = COLORS.item;
                        ctx.beginPath();
                        ctx.arc(0, 0, 10, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.fillStyle = '#FFF';
                        ctx.beginPath();
                        ctx.arc(0, 0, 7, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.lineTo(0, -4);
                        ctx.moveTo(0, 0);
                        ctx.lineTo(3, 0);
                        ctx.stroke();
                        break;
                    case 'life':
                        // ì‹­ìê°€
                        ctx.fillStyle = '#FF69B4';
                        ctx.fillRect(-3, -10, 6, 20);
                        ctx.fillRect(-8, -5, 16, 6);
                        break;
                    case 'bomb':
                        // í­íƒ„
                        ctx.fillStyle = '#333';
                        ctx.beginPath();
                        ctx.arc(0, 2, 8, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.strokeStyle = '#FF4500';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(0, -6);
                        ctx.lineTo(0, -10);
                        ctx.stroke();
                        ctx.fillStyle = '#FF4500';
                        ctx.beginPath();
                        ctx.arc(0, -12, 3, 0, Math.PI * 2);
                        ctx.fill();
                        break;
                    case 'axe':
                        // ë„ë¼
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(-2, -8, 4, 18);
                        ctx.fillStyle = '#C0C0C0';
                        ctx.beginPath();
                        ctx.moveTo(-2, -8);
                        ctx.lineTo(-10, -4);
                        ctx.lineTo(-10, 2);
                        ctx.lineTo(-2, 0);
                        ctx.fill();
                        break;
                    case 'spring':
                        // ìŠ¤í”„ë§
                        ctx.strokeStyle = '#00FF00';
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        for (let i = 0; i < 4; i++) {
                            ctx.moveTo(-6, -8 + i * 5);
                            ctx.lineTo(6, -6 + i * 5);
                            ctx.moveTo(6, -6 + i * 5);
                            ctx.lineTo(-6, -4 + i * 5);
                        }
                        ctx.stroke();
                        break;
                }
                
                ctx.restore();
            }
        }

        /**
         * ì  ê·¸ë¦¬ê¸°
         */
        function drawEnemies() {
            for (const enemy of currentLevel.enemies) {
                if (!enemy.alive) continue;
                if (enemy.x + enemy.width < gameState.cameraX || 
                    enemy.x > gameState.cameraX + GAME_WIDTH) continue;
                
                ctx.save();
                ctx.translate(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
                
                // ê¸°ì ˆ íš¨ê³¼
                if (enemy.stunned) {
                    ctx.globalAlpha = 0.5 + Math.sin(Date.now() * 0.02) * 0.3;
                }
                
                // ë°©í–¥
                ctx.scale(enemy.vx > 0 ? 1 : -1, 1);
                
                if (enemy.type === 'caveman') {
                    // ì›ì‹œì¸ ì 
                    // ëª¸
                    ctx.fillStyle = COLORS.enemy;
                    ctx.fillRect(-12, -5, 24, 25);
                    
                    // ë¨¸ë¦¬
                    ctx.fillStyle = '#FFD39B';
                    ctx.beginPath();
                    ctx.arc(0, -15, 12, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ë¨¸ë¦¬ì¹´ë½
                    ctx.fillStyle = '#333';
                    ctx.beginPath();
                    ctx.arc(0, -20, 8, Math.PI, 0);
                    ctx.fill();
                    
                    // ëˆˆ
                    ctx.fillStyle = '#000';
                    ctx.fillRect(3, -17, 4, 4);
                    
                    // ë‹¤ë¦¬ (ì• ë‹ˆë©”ì´ì…˜)
                    const legOffset = enemy.animFrame * 5 - 2.5;
                    ctx.fillStyle = '#FFD39B';
                    ctx.fillRect(-8, 18, 6, 12);
                    ctx.fillRect(2 + legOffset, 18, 6, 12);
                } else if (enemy.type === 'dino') {
                    // ê³µë£¡
                    ctx.fillStyle = COLORS.dino;
                    
                    // ëª¸í†µ
                    ctx.beginPath();
                    ctx.ellipse(0, 0, 20, 15, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ë¨¸ë¦¬
                    ctx.beginPath();
                    ctx.ellipse(18, -5, 10, 8, 0.3, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ê¼¬ë¦¬
                    ctx.beginPath();
                    ctx.moveTo(-15, 0);
                    ctx.lineTo(-30, -5);
                    ctx.lineTo(-25, 5);
                    ctx.fill();
                    
                    // ëˆˆ
                    ctx.fillStyle = '#FF0000';
                    ctx.beginPath();
                    ctx.arc(22, -8, 3, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ë‹¤ë¦¬
                    ctx.fillStyle = COLORS.dinoDark;
                    const legOff = enemy.animFrame * 4 - 2;
                    ctx.fillRect(-8, 12, 6, 10);
                    ctx.fillRect(4 + legOff, 12, 6, 10);
                }
                
                ctx.restore();
            }
        }

        /**
         * ë³´ìŠ¤ ê·¸ë¦¬ê¸°
         */
        function drawBoss() {
            const boss = currentLevel.boss;
            if (!boss.alive) return;
            
            ctx.save();
            ctx.translate(boss.x + boss.width / 2, boss.y + boss.height / 2);
            
            // ë¬´ì  ê¹œë¹¡ì„
            if (boss.invincible) {
                ctx.globalAlpha = 0.5 + Math.sin(Date.now() * 0.03) * 0.3;
            }
            
            // ë°©í–¥
            const dir = player.x > boss.x ? 1 : -1;
            ctx.scale(dir, 1);
            
            if (boss.type === 'mammoth') {
                // ë§¤ë¨¸ë“œ
                ctx.fillStyle = '#8B4513';
                
                // ëª¸í†µ
                ctx.beginPath();
                ctx.ellipse(0, 10, 45, 35, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // ë¨¸ë¦¬
                ctx.beginPath();
                ctx.ellipse(35, -10, 25, 25, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // ì½”
                ctx.fillStyle = '#6B4513';
                ctx.beginPath();
                ctx.moveTo(50, 0);
                ctx.quadraticCurveTo(70, 20, 55, 50);
                ctx.quadraticCurveTo(45, 40, 45, 0);
                ctx.fill();
                
                // ìƒì•„
                ctx.fillStyle = '#FFFFF0';
                ctx.beginPath();
                ctx.moveTo(45, -5);
                ctx.quadraticCurveTo(70, -15, 60, -35);
                ctx.lineTo(55, -30);
                ctx.quadraticCurveTo(60, -15, 40, -5);
                ctx.fill();
                
                // ëˆˆ
                ctx.fillStyle = '#FF0000';
                ctx.beginPath();
                ctx.arc(45, -15, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // ë‹¤ë¦¬
                ctx.fillStyle = '#6B4513';
                const lo = boss.animFrame * 4;
                ctx.fillRect(-30, 35, 15, 25);
                ctx.fillRect(-5 + lo, 35, 15, 25);
                ctx.fillRect(15, 35, 15, 25);
                ctx.fillRect(35 - lo, 35, 15, 25);
                
            } else if (boss.type === 'trex') {
                // í‹°ë¼ë…¸ì‚¬ìš°ë£¨ìŠ¤
                ctx.fillStyle = '#228B22';
                
                // ëª¸í†µ
                ctx.beginPath();
                ctx.ellipse(0, 10, 40, 30, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // ë¨¸ë¦¬
                ctx.fillStyle = '#2E8B2E';
                ctx.beginPath();
                ctx.ellipse(45, -15, 30, 20, 0.2, 0, Math.PI * 2);
                ctx.fill();
                
                // ì…
                ctx.fillStyle = '#8B0000';
                ctx.beginPath();
                ctx.moveTo(55, -10);
                ctx.lineTo(75, -5);
                ctx.lineTo(55, 5);
                ctx.fill();
                
                // ì´ë¹¨
                ctx.fillStyle = '#FFF';
                for (let i = 0; i < 4; i++) {
                    ctx.beginPath();
                    ctx.moveTo(58 + i * 4, -8);
                    ctx.lineTo(60 + i * 4, 0);
                    ctx.lineTo(56 + i * 4, -8);
                    ctx.fill();
                }
                
                // ëˆˆ
                ctx.fillStyle = '#FF0000';
                ctx.beginPath();
                ctx.arc(50, -25, 6, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(52, -25, 3, 0, Math.PI * 2);
                ctx.fill();
                
                // ì‘ì€ íŒ”
                ctx.fillStyle = '#228B22';
                ctx.fillRect(20, -5, 8, 15);
                
                // ê¼¬ë¦¬
                ctx.beginPath();
                ctx.moveTo(-35, 5);
                ctx.quadraticCurveTo(-60, 0, -70, -20);
                ctx.quadraticCurveTo(-55, 5, -35, 15);
                ctx.fill();
                
                // ë‹¤ë¦¬
                ctx.fillStyle = '#1E7B1E';
                const lo2 = boss.animFrame * 5;
                ctx.fillRect(-20, 35, 18, 30);
                ctx.fillRect(10 + lo2, 35, 18, 30);
                
            } else if (boss.type === 'giant') {
                // ê±°ì¸
                ctx.fillStyle = '#8B0000';
                
                // ëª¸í†µ
                ctx.fillRect(-25, -20, 50, 70);
                
                // ë¨¸ë¦¬
                ctx.fillStyle = '#CD853F';
                ctx.beginPath();
                ctx.arc(0, -45, 30, 0, Math.PI * 2);
                ctx.fill();
                
                // ë¨¸ë¦¬ì¹´ë½
                ctx.fillStyle = '#333';
                ctx.beginPath();
                ctx.arc(0, -55, 25, Math.PI, 0);
                ctx.fill();
                
                // ëˆˆ
                ctx.fillStyle = '#FFF';
                ctx.beginPath();
                ctx.arc(-10, -50, 8, 0, Math.PI * 2);
                ctx.arc(10, -50, 8, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(-8, -50, 4, 0, Math.PI * 2);
                ctx.arc(12, -50, 4, 0, Math.PI * 2);
                ctx.fill();
                
                // ëˆˆì¹ (ë¶„ë…¸)
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(-20, -62);
                ctx.lineTo(-5, -58);
                ctx.moveTo(20, -62);
                ctx.lineTo(5, -58);
                ctx.stroke();
                
                // ì…
                ctx.fillStyle = '#000';
                ctx.fillRect(-12, -35, 24, 8);
                
                // íŒ”
                ctx.fillStyle = '#CD853F';
                ctx.fillRect(-45, -15, 20, 50);
                ctx.fillRect(25, -15, 20, 50);
                
                // ê³¤ë´‰
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(35, -30, 10, 80);
                ctx.fillStyle = '#654321';
                ctx.beginPath();
                ctx.ellipse(40, -35, 15, 20, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // ë‹¤ë¦¬
                ctx.fillStyle = '#8B4513';
                const lo3 = boss.animFrame * 6;
                ctx.fillRect(-20, 48, 16, 35);
                ctx.fillRect(5 + lo3, 48, 16, 35);
            }
            
            ctx.restore();
        }

        /**
         * ë³´ìŠ¤ HPë°” ê·¸ë¦¬ê¸°
         */
        function drawBossHPBar() {
            const barWidth = 300;
            const barHeight = 20;
            const x = (GAME_WIDTH - barWidth) / 2;
            const y = 60;
            
            // ë°°ê²½
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(x - 5, y - 5, barWidth + 10, barHeight + 10);
            
            // HPë°” ë°°ê²½
            ctx.fillStyle = '#333';
            ctx.fillRect(x, y, barWidth, barHeight);
            
            // HPë°”
            const hpPercent = gameState.bossHP / gameState.bossMaxHP;
            const hpColor = hpPercent > 0.5 ? '#00FF00' : (hpPercent > 0.25 ? '#FFFF00' : '#FF0000');
            ctx.fillStyle = hpColor;
            ctx.fillRect(x, y, barWidth * hpPercent, barHeight);
            
            // í…Œë‘ë¦¬
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, barWidth, barHeight);
            
            // í…ìŠ¤íŠ¸
            ctx.fillStyle = '#FFF';
            ctx.font = 'bold 14px Courier New';
            ctx.textAlign = 'center';
            ctx.fillText('BOSS', GAME_WIDTH / 2, y - 10);
        }

        /**
         * ê³¨ì¸ ì§€ì  ê·¸ë¦¬ê¸°
         */
        function drawGoal() {
            const goal = currentLevel.goal;
            
            // ê¹ƒë°œ ê¸°ë‘¥
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(goal.x + 25, goal.y, 10, goal.height);
            
            // ê¹ƒë°œ
            const waveOffset = Math.sin(Date.now() * 0.005) * 5;
            ctx.fillStyle = gameState.food >= gameState.foodRequired ? '#00FF00' : '#FFD700';
            ctx.beginPath();
            ctx.moveTo(goal.x + 35, goal.y);
            ctx.lineTo(goal.x + 35 + 50 + waveOffset, goal.y + 25);
            ctx.lineTo(goal.x + 35, goal.y + 50);
            ctx.fill();
            
            // GOAL í…ìŠ¤íŠ¸
            ctx.fillStyle = '#FFF';
            ctx.font = 'bold 16px Courier New';
            ctx.textAlign = 'center';
            ctx.fillText('GOAL', goal.x + 45, goal.y - 10);
            
            // í´ë¦¬ì–´ ì¡°ê±´ ë¯¸ì¶©ì¡± ì‹œ ê²½ê³ 
            if (gameState.food < gameState.foodRequired) {
                ctx.fillStyle = '#FF0000';
                ctx.font = '12px Courier New';
                ctx.fillText('FOOD ë¶€ì¡±!', goal.x + 45, goal.y + goal.height + 20);
            }
        }

        /**
         * í”Œë ˆì´ì–´ ê·¸ë¦¬ê¸°
         */
        function drawPlayer() {
            ctx.save();
            ctx.translate(player.x + player.width / 2, player.y + player.height / 2);
            
            // ë¬´ì  ê¹œë¹¡ì„
            if (player.invincible) {
                ctx.globalAlpha = 0.5 + Math.sin(Date.now() * 0.02) * 0.3;
            }
            
            // íŒŒì›Œì—… íš¨ê³¼
            if (gameState.hasPowerUp) {
                ctx.shadowColor = '#00FF00';
                ctx.shadowBlur = 15;
            }
            
            // ë°©í–¥
            ctx.scale(player.facing, 1);
            
            // ë‹¤ë¦¬ (ì• ë‹ˆë©”ì´ì…˜)
            ctx.fillStyle = COLORS.player;
            const legOffset = player.onGround && Math.abs(player.vx) > 0.5 ? 
                Math.sin(player.animFrame * Math.PI / 2) * 8 : 0;
            ctx.fillRect(-10, 10, 8, 18);
            ctx.fillRect(2 + legOffset, 10, 8, 18);
            
            // ëª¸í†µ (ì›ì‹œì¸ ì˜·)
            ctx.fillStyle = COLORS.playerCloth;
            ctx.beginPath();
            ctx.moveTo(-14, -5);
            ctx.lineTo(14, -5);
            ctx.lineTo(12, 15);
            ctx.lineTo(-12, 15);
            ctx.fill();
            
            // ì˜· ë¬´ëŠ¬ (ì )
            ctx.fillStyle = '#654321';
            ctx.beginPath();
            ctx.arc(-5, 3, 3, 0, Math.PI * 2);
            ctx.arc(5, 7, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // íŒ”
            ctx.fillStyle = COLORS.player;
            const armAngle = player.attacking ? -0.5 : 0.3;
            ctx.save();
            ctx.translate(12, -2);
            ctx.rotate(armAngle);
            ctx.fillRect(0, -3, 15, 8);
            ctx.restore();
            
            // ë¨¸ë¦¬
            ctx.fillStyle = COLORS.player;
            ctx.beginPath();
            ctx.arc(0, -18, 14, 0, Math.PI * 2);
            ctx.fill();
            
            // ë¨¸ë¦¬ì¹´ë½
            ctx.fillStyle = COLORS.playerHair;
            ctx.beginPath();
            ctx.arc(0, -24, 10, Math.PI, 0);
            ctx.fill();
            // ì‚ì£½ ë¨¸ë¦¬ì¹´ë½
            ctx.beginPath();
            ctx.moveTo(-5, -32);
            ctx.lineTo(0, -40);
            ctx.lineTo(5, -32);
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(5, -30);
            ctx.lineTo(12, -36);
            ctx.lineTo(10, -28);
            ctx.fill();
            
            // ëˆˆ
            ctx.fillStyle = '#FFF';
            ctx.beginPath();
            ctx.ellipse(5, -20, 5, 6, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(6, -19, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // ì½”
            ctx.fillStyle = '#DEB887';
            ctx.beginPath();
            ctx.arc(12, -15, 4, 0, Math.PI * 2);
            ctx.fill();
            
            // ì… (í‘œì •)
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            if (player.onGround) {
                ctx.arc(8, -10, 4, 0, Math.PI); // ì›ƒìŒ
            } else {
                ctx.arc(8, -8, 4, Math.PI, 0); // ë†€ëŒ
            }
            ctx.stroke();
            
            ctx.restore();
        }

        /**
         * íŒŒí‹°í´ ê·¸ë¦¬ê¸°
         */
        function drawParticles() {
            for (const p of particles) {
                ctx.save();
                ctx.globalAlpha = p.alpha;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        // ==========================================
        // UI í•¨ìˆ˜ë“¤
        // ==========================================

        /**
         * ì˜¤ë²„ë ˆì´ í‘œì‹œ
         */
        function showOverlay(title, message, buttonText, buttonCallback) {
            overlay.classList.remove('hidden');
            overlay.innerHTML = `
                <h1>${title}</h1>
                <p>${message.replace(/\n/g, '<br>')}</p>
                <button class="btn" id="overlay-btn">${buttonText}</button>
            `;
            document.getElementById('overlay-btn').addEventListener('click', buttonCallback);
        }

        /**
         * ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
         */
        function hideOverlay() {
            overlay.classList.add('hidden');
        }

        /**
         * ìŠ¤í…Œì´ì§€ ë¡œë“œ
         */
        function loadStage(stageNum) {
            particles = [];
            
            if (stageNum % 2 === 1) {
                // í™€ìˆ˜: ëŸ° ìŠ¤í…Œì´ì§€
                generateRunStage(stageNum);
            } else {
                // ì§ìˆ˜: ë³´ìŠ¤ ìŠ¤í…Œì´ì§€
                generateBossStage(stageNum);
            }
        }

        /**
         * ê²Œì„ ì‹œì‘
         */
        function startGame() {
            gameState = {
                screen: 'playing',
                stage: 1,
                score: 0,
                lives: 3,
                time: 120,
                food: 0,
                foodRequired: 50,
                cameraX: 0,
                lastTime: 0,
                deltaTime: 0,
                timeAccumulator: 0,
                bossHP: 0,
                bossMaxHP: 0,
                powerUpTimer: 0,
                hasPowerUp: false
            };
            
            player = {
                x: 100,
                y: 300,
                width: 32,
                height: 48,
                vx: 0,
                vy: 0,
                onGround: false,
                facing: 1,
                attacking: false,
                attackTimer: 0,
                invincible: false,
                invincibleTimer: 0,
                animFrame: 0,
                animTimer: 0
            };
            
            loadStage(1);
            hideOverlay();
        }

        // ==========================================
        // ì…ë ¥ ì²˜ë¦¬
        // ==========================================

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = true;
            if (e.key === 'ArrowRight' || e.key === 'd') keys.right = true;
            if (e.key === 'ArrowUp' || e.key === 'w') keys.up = true;
            if (e.key === ' ') keys.space = true;
            
            // ìŠ¤í˜ì´ìŠ¤ë°” ìŠ¤í¬ë¡¤ ë°©ì§€
            if (e.key === ' ') e.preventDefault();
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = false;
            if (e.key === 'ArrowRight' || e.key === 'd') keys.right = false;
            if (e.key === 'ArrowUp' || e.key === 'w') keys.up = false;
            if (e.key === ' ') keys.space = false;
        });

        // ëª¨ë°”ì¼ í„°ì¹˜ ì»¨íŠ¸ë¡¤
        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');
        const btnJump = document.getElementById('btn-jump');

        if (btnLeft) {
            btnLeft.addEventListener('touchstart', (e) => { e.preventDefault(); keys.left = true; });
            btnLeft.addEventListener('touchend', () => keys.left = false);
        }
        if (btnRight) {
            btnRight.addEventListener('touchstart', (e) => { e.preventDefault(); keys.right = true; });
            btnRight.addEventListener('touchend', () => keys.right = false);
        }
        if (btnJump) {
            btnJump.addEventListener('touchstart', (e) => { e.preventDefault(); keys.space = true; });
            btnJump.addEventListener('touchend', () => keys.space = false);
        }

        // ì‹œì‘ ë²„íŠ¼
        startBtn.addEventListener('click', startGame);

        // ==========================================
        // ê²Œì„ ë£¨í”„
        // ==========================================

        function gameLoop(timestamp) {
            // ë¸íƒ€ íƒ€ì„ ê³„ì‚°
            if (gameState.lastTime === 0) gameState.lastTime = timestamp;
            gameState.deltaTime = timestamp - gameState.lastTime;
            gameState.lastTime = timestamp;
            
            // í”„ë ˆì„ ì œí•œ (ë„ˆë¬´ í° ë¸íƒ€ ë°©ì§€)
            if (gameState.deltaTime > 100) gameState.deltaTime = 16;
            
            // ì—…ë°ì´íŠ¸
            update(gameState.deltaTime);
            
            // ë Œë”ë§
            render();
            
            // ë‹¤ìŒ í”„ë ˆì„
            requestAnimationFrame(gameLoop);
        }

        // ê²Œì„ ì‹œì‘
        requestAnimationFrame(gameLoop);
        
        // ì´ˆê¸° HUD ì—…ë°ì´íŠ¸
        updateHUD();

    })();
    </script>
</body>
</html>
