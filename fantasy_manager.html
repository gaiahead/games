<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>íŒíƒ€ì§€ ë§¤ë‹ˆì € v4 ìµœì¢…íŒ</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #e0e0e0;
    font-family: 'Georgia', serif;
    min-height: 100vh;
    padding: 20px;
  }

  .container { max-width: 1400px; margin: 0 auto; }

  h1 {
    text-align: center;
    font-size: 36px;
    color: #f0c040;
    text-shadow: 0 0 15px rgba(240, 192, 64, 0.5);
    margin-bottom: 20px;
    letter-spacing: 3px;
  }

  /* íƒ­ */
  .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .tab {
    padding: 12px 24px;
    background: rgba(30, 40, 60, 0.8);
    border: 2px solid #2a4a6a;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 15px;
    color: #a0b0c0;
  }

  .tab:hover { background: rgba(40, 60, 90, 0.9); }
  .tab.active {
    background: #2a5a8a;
    border-color: #4a8ab5;
    color: #fff;
    box-shadow: 0 0 15px rgba(74, 138, 181, 0.3);
  }

  /* ìŠ¤í¬ë¦° */
  .screen { display: none; }
  .screen.active { display: block; }

  /* ë¦¬ì†ŒìŠ¤ ë°” */
  .resources {
    display: flex;
    gap: 25px;
    justify-content: center;
    margin-bottom: 25px;
    padding: 15px;
    background: rgba(20, 30, 50, 0.6);
    border-radius: 10px;
    flex-wrap: wrap;
  }

  .resource {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 18px;
    font-weight: bold;
  }

  .resource .icon { font-size: 22px; }
  .resource .value { color: #f0c040; }

  /* ê¸¸ë“œ ë°°ì§€ */
  .guild-badge {
    background: linear-gradient(135deg, #4a3a1a 0%, #6a5a2a 100%);
    border: 2px solid #b59a4a;
    border-radius: 6px;
    padding: 5px 12px;
    font-size: 14px;
    color: #f0c040;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  /* ì˜ì›… ì¹´ë“œ */
  .hero-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
  }

  .hero-card {
    background: linear-gradient(135deg, #1e2a3a 0%, #2a3a4a 100%);
    border: 2px solid #3a5a7a;
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
  }

  .hero-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 20px rgba(74, 138, 181, 0.3);
    border-color: #5a8aba;
  }

  .hero-card.selected {
    border-color: #f0c040;
    background: linear-gradient(135deg, #2a3a1a 0%, #3a4a2a 100%);
  }

  .hero-card.evolved {
    border-color: #f0a040;
    background: linear-gradient(135deg, #3a2a1a 0%, #4a3a2a 100%);
    box-shadow: 0 0 20px rgba(240, 160, 64, 0.4);
  }

  .hero-card.mercenary {
    border-color: #f0c040;
    background: linear-gradient(135deg, #3a3a1a 0%, #4a4a2a 100%);
    box-shadow: 0 0 15px rgba(240, 192, 64, 0.3);
  }

  .hero-name {
    font-size: 16px;
    font-weight: bold;
    color: #f0e0a0;
    margin-bottom: 5px;
  }

  .hero-class {
    font-size: 12px;
    color: #a0b0d0;
    margin-bottom: 5px;
  }

  .hero-level {
    font-size: 11px;
    color: #8090a0;
  }

  .hero-stats {
    margin-top: 10px;
    font-size: 11px;
    color: #c0d0e0;
    line-height: 1.6;
  }

  /* ì¥ë¹„ ì•„ì´ì½˜ ë° ë“±ê¸‰ ìƒ‰ìƒ */
  .equipment-icons {
    display: flex;
    gap: 5px;
    margin-top: 8px;
    font-size: 14px;
  }

  .equipment-icon {
    padding: 2px 4px;
    border-radius: 3px;
    font-size: 12px;
  }

  .eq-common { background: rgba(150, 150, 150, 0.4); border: 1px solid #999; }
  .eq-rare { background: rgba(50, 100, 200, 0.4); border: 1px solid #4a8af0; color: #8ac0ff; }
  .eq-epic { background: rgba(150, 50, 200, 0.4); border: 1px solid #a040f0; color: #d080ff; }
  .eq-legendary { background: rgba(200, 150, 50, 0.4); border: 1px solid #f0a040; color: #ffd040; }

  /* ë²„íŠ¼ */
  button {
    padding: 10px 20px;
    background: linear-gradient(135deg, #2a5a8a 0%, #1a4a7a 100%);
    border: 2px solid #4a8ab5;
    border-radius: 6px;
    color: #fff;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
  }

  button:hover {
    background: linear-gradient(135deg, #3a6a9a 0%, #2a5a8a 100%);
    box-shadow: 0 0 15px rgba(74, 138, 181, 0.4);
  }

  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  button.small {
    padding: 5px 10px;
    font-size: 12px;
  }

  button.danger {
    background: linear-gradient(135deg, #8a2a2a 0%, #7a1a1a 100%);
    border-color: #b54a4a;
  }

  button.success {
    background: linear-gradient(135deg, #2a8a5a 0%, #1a7a4a 100%);
    border-color: #4ab58a;
  }

  button.warning {
    background: linear-gradient(135deg, #8a6a2a 0%, #7a5a1a 100%);
    border-color: #b59a4a;
  }

  button.purple {
    background: linear-gradient(135deg, #6a2a8a 0%, #5a1a7a 100%);
    border-color: #9a4ab5;
  }

  /* ì „íˆ¬ ì˜ì—­ */
  .battle-area {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
  }

  .team-side {
    background: rgba(20, 30, 50, 0.6);
    padding: 20px;
    border-radius: 10px;
  }

  .team-side h3 {
    font-size: 20px;
    color: #f0c040;
    margin-bottom: 15px;
    text-align: center;
  }

  .battle-hero {
    background: rgba(30, 40, 60, 0.8);
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 6px;
    border: 2px solid #3a5a7a;
    position: relative;
  }

  .battle-hero.active {
    border-color: #f0c040;
    box-shadow: 0 0 15px rgba(240, 192, 64, 0.3);
  }

  .battle-hero.dead {
    opacity: 0.4;
    border-color: #5a3a3a;
  }

  .status-effects {
    display: flex;
    gap: 5px;
    margin-top: 5px;
    font-size: 16px;
  }

  .status-icon {
    padding: 2px 5px;
    background: rgba(50, 50, 80, 0.8);
    border-radius: 3px;
    font-size: 14px;
  }

  .hp-bar {
    width: 100%;
    height: 8px;
    background: #2a2a3a;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 5px;
  }

  .hp-fill {
    height: 100%;
    background: linear-gradient(90deg, #4a8a4a 0%, #6aba6a 100%);
    transition: width 0.3s;
  }

  /* ì „íˆ¬ ë¡œê·¸ */
  .battle-log {
    background: rgba(10, 10, 20, 0.8);
    padding: 15px;
    border-radius: 10px;
    max-height: 300px;
    overflow-y: auto;
    font-size: 13px;
    line-height: 1.8;
    color: #c0d0e0;
  }

  .log-entry { margin-bottom: 5px; }
  .log-entry.attack { color: #f08080; }
  .log-entry.skill { color: #80b0f0; font-weight: bold; text-shadow: 0 0 5px rgba(128, 176, 240, 0.5); }
  .log-entry.heal { color: #80f080; }
  .log-entry.ultimate { color: #f0a040; font-weight: bold; text-shadow: 0 0 10px rgba(240, 160, 64, 0.8); font-size: 14px; }
  .log-entry.special { color: #d080ff; font-weight: bold; }
  .log-entry.formation { color: #a0d0f0; font-style: italic; }

  /* ë¦¬ê·¸ í™”ë©´ */
  .league-status {
    background: rgba(20, 30, 50, 0.6);
    padding: 30px;
    border-radius: 10px;
    text-align: center;
  }

  .league-status h2 {
    font-size: 28px;
    color: #f0c040;
    margin-bottom: 20px;
  }

  .league-info {
    font-size: 18px;
    line-height: 2;
    color: #d0e0f0;
  }

  /* ì•¡ì…˜ ì˜ì—­ */
  .actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    overflow-y: auto;
  }

  .modal.active { display: flex; }

  .modal-content {
    background: linear-gradient(135deg, #1e2a3a 0%, #2a3a4a 100%);
    padding: 30px;
    border-radius: 15px;
    border: 2px solid #4a8ab5;
    max-width: 700px;
    max-height: 85vh;
    overflow-y: auto;
    margin: 20px;
  }

  .modal-content.wide {
    max-width: 900px;
  }

  .modal-title {
    font-size: 24px;
    color: #f0c040;
    margin-bottom: 20px;
    text-align: center;
  }

  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .equipment-slot {
    background: rgba(30, 40, 60, 0.8);
    padding: 12px;
    border-radius: 8px;
    border: 2px solid #3a5a7a;
    margin-bottom: 10px;
  }

  .equipment-slot.empty { opacity: 0.5; font-style: italic; }

  /* ìŠ¤í‚¬ íŠ¸ë¦¬ */
  .skill-tree {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin: 20px 0;
  }

  .skill-path {
    background: rgba(30, 40, 60, 0.8);
    padding: 15px;
    border-radius: 8px;
    border: 2px solid #3a5a7a;
    cursor: pointer;
    transition: all 0.3s;
  }

  .skill-path:hover { border-color: #5a8aba; transform: scale(1.02); }
  .skill-path.selected { border-color: #f0c040; background: rgba(60, 50, 30, 0.8); }
  .skill-path.locked { opacity: 0.5; cursor: not-allowed; }

  /* ì—…ì  */
  .achievement-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
  }

  .achievement-card {
    background: rgba(30, 40, 60, 0.8);
    padding: 15px;
    border-radius: 8px;
    border: 2px solid #3a5a7a;
  }

  .achievement-card.unlocked { border-color: #4ab58a; background: rgba(30, 60, 40, 0.8); }

  .achievement-title { font-size: 16px; font-weight: bold; color: #f0e0a0; margin-bottom: 5px; }
  .achievement-desc { font-size: 12px; color: #a0b0c0; margin-bottom: 10px; }
  .achievement-progress { font-size: 11px; color: #8090a0; }

  /* í†µê³„ í™”ë©´ */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin-top: 20px;
  }

  .stat-card {
    background: rgba(30, 40, 60, 0.8);
    padding: 20px;
    border-radius: 8px;
    border: 2px solid #3a5a7a;
    text-align: center;
  }

  .stat-value { font-size: 28px; font-weight: bold; color: #f0c040; margin-bottom: 10px; }
  .stat-label { font-size: 13px; color: #a0b0c0; }

  /* Formation ì„ íƒ */
  .formation-select {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin: 20px 0;
    flex-wrap: wrap;
  }

  .formation-option {
    background: rgba(30, 40, 60, 0.8);
    padding: 15px 25px;
    border-radius: 8px;
    border: 2px solid #3a5a7a;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s;
    min-width: 140px;
  }

  .formation-option:hover { border-color: #5a8aba; transform: scale(1.05); }
  .formation-option.selected { border-color: #f0c040; background: rgba(60, 50, 30, 0.8); }

  .formation-name { font-size: 16px; font-weight: bold; color: #f0e0a0; margin-bottom: 5px; }
  .formation-bonus { font-size: 11px; color: #a0b0c0; }

  /* PvP */
  .pvp-setup {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
  }

  .pvp-player {
    background: rgba(20, 30, 50, 0.6);
    padding: 20px;
    border-radius: 10px;
  }

  .pvp-player h3 {
    font-size: 20px;
    color: #f0c040;
    margin-bottom: 15px;
    text-align: center;
  }

  /* ìš©ë³‘ ì¹´ë“œ */
  .mercenary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
  }

  .mercenary-card {
    background: linear-gradient(135deg, #3a3a1a 0%, #4a4a2a 100%);
    border: 2px solid #b59a4a;
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s;
  }

  .mercenary-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 20px rgba(240, 192, 64, 0.3);
  }

  /* ê¸¸ë“œ */
  .guild-panel {
    background: rgba(20, 30, 50, 0.6);
    padding: 25px;
    border-radius: 10px;
    text-align: center;
  }

  .guild-buffs {
    display: flex;
    gap: 20px;
    justify-content: center;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .guild-buff {
    background: rgba(50, 60, 30, 0.6);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #6a8a3a;
    min-width: 150px;
  }

  /* ìŠ¤í† ë¦¬ ëª¨ë‹¬ */
  .story-modal .modal-content {
    background: linear-gradient(135deg, #1a1a2e 0%, #2a2a3e 100%);
    border-color: #5a4a8a;
  }

  .story-text {
    font-size: 16px;
    line-height: 2;
    color: #d0d0f0;
    text-align: center;
    padding: 20px;
    font-style: italic;
  }

  .story-chapter {
    font-size: 28px;
    color: #f0c040;
    text-align: center;
    margin-bottom: 20px;
    text-shadow: 0 0 20px rgba(240, 192, 64, 0.5);
  }

  /* ì—”ë”© í™”ë©´ */
  .ending-screen {
    text-align: center;
    padding: 40px;
  }

  .ending-title {
    font-size: 42px;
    color: #f0c040;
    text-shadow: 0 0 30px rgba(240, 192, 64, 0.8);
    margin-bottom: 30px;
    animation: glow 2s infinite alternate;
  }

  @keyframes glow {
    from { text-shadow: 0 0 20px rgba(240, 192, 64, 0.5); }
    to { text-shadow: 0 0 40px rgba(240, 192, 64, 1), 0 0 60px rgba(240, 160, 64, 0.5); }
  }

  /* íŠœí† ë¦¬ì–¼ */
  .tutorial-step {
    background: rgba(40, 50, 70, 0.9);
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 15px;
    border-left: 4px solid #f0c040;
  }

  .tutorial-step h4 {
    color: #f0c040;
    margin-bottom: 10px;
  }

  /* ë„ì›€ë§ */
  .help-section {
    margin-bottom: 25px;
    padding: 20px;
    background: rgba(30, 40, 60, 0.6);
    border-radius: 10px;
  }

  .help-section h4 {
    color: #f0c040;
    margin-bottom: 15px;
    font-size: 18px;
  }

  /* ëª…ì˜ˆì˜ ì „ë‹¹ */
  .hall-of-fame {
    background: linear-gradient(135deg, #2a2a1a 0%, #3a3a2a 100%);
    border: 2px solid #b59a4a;
    border-radius: 10px;
    padding: 25px;
    margin-top: 30px;
  }

  .hall-of-fame h3 {
    color: #f0c040;
    text-align: center;
    margin-bottom: 20px;
    font-size: 22px;
  }

  .hof-record {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    border-bottom: 1px solid #4a4a3a;
  }

  /* ì• ë‹ˆë©”ì´ì…˜ */
  @keyframes levelUp {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); }
  }

  @keyframes evolve {
    0% { transform: scale(1) rotate(0deg); opacity: 1; }
    50% { transform: scale(1.3) rotate(180deg); opacity: 0.5; }
    100% { transform: scale(1) rotate(360deg); opacity: 1; }
  }

  @keyframes victoryFlash {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; background: rgba(100, 200, 100, 0.2); }
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  .level-up-animation { animation: levelUp 0.5s ease-in-out; }
  .evolve-animation { animation: evolve 1s ease-in-out; }
  .victory-animation { animation: victoryFlash 0.5s ease-in-out 3; }
  .shake-animation { animation: shake 0.3s ease-in-out; }

  /* ì „íˆ¬ ì†ë„ ì»¨íŠ¸ë¡¤ */
  .battle-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: center;
    margin: 15px 0;
    flex-wrap: wrap;
  }

  /* ë°˜ì‘í˜• */
  @media (max-width: 768px) {
    .battle-area, .pvp-setup { grid-template-columns: 1fr; }
    .hero-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
    .skill-tree, .formation-select { grid-template-columns: 1fr; }
    .tabs { gap: 5px; }
    .tab { padding: 10px 15px; font-size: 13px; }
  }

  /* íˆ´íŒ */
  .tooltip {
    position: relative;
    cursor: help;
  }

  .tooltip::after {
    content: attr(data-tip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.9);
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    z-index: 100;
  }

  .tooltip:hover::after { opacity: 1; }

  /* Help ë²„íŠ¼ ê³ ì • */
  .help-btn-fixed {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    font-size: 24px;
    z-index: 999;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>
</head>
<body>

<div class="container">
  <h1>âš”ï¸ íŒíƒ€ì§€ ë§¤ë‹ˆì € v4 ìµœì¢…íŒ âš”ï¸</h1>

  <div class="resources">
    <div class="resource">
      <span class="icon">ğŸ’°</span>
      <span>ê³¨ë“œ: <span class="value" id="goldVal">1000</span></span>
    </div>
    <div class="resource">
      <span class="icon">ğŸ†</span>
      <span>ëª…ì˜ˆ: <span class="value" id="gloryVal">0</span></span>
    </div>
    <div class="resource">
      <span class="icon">ğŸ¯</span>
      <span>ì‹œì¦Œ: <span class="value" id="seasonVal">1</span></span>
    </div>
    <div class="resource">
      <span class="icon">âš”ï¸</span>
      <span>ê²½ê¸°: <span class="value" id="matchVal">0</span>/10</span>
    </div>
    <div class="guild-badge" id="guildBadge" style="display:none;">
      <span>ğŸ›ï¸</span>
      <span id="guildName">-</span>
      <span>Lv.<span id="guildLevel">1</span></span>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('management')">ğŸ° ê²½ì˜</div>
    <div class="tab" onclick="switchTab('battle')">âš”ï¸ ì „íˆ¬</div>
    <div class="tab" onclick="switchTab('league')">ğŸ† ë¦¬ê·¸</div>
    <div class="tab" onclick="switchTab('pvp')">ğŸ‘¥ ëŒ€ì „</div>
    <div class="tab" onclick="switchTab('achievements')">ğŸ–ï¸ ì—…ì </div>
    <div class="tab" onclick="switchTab('stats')">ğŸ“Š í†µê³„</div>
  </div>

  <!-- Management Screen -->
  <div class="screen active" id="management">
    <h2 style="color:#f0c040; margin-bottom:20px; text-align:center;">ë¡œìŠ¤í„°</h2>
    <div class="actions">
      <button onclick="showMarket()" class="tooltip" data-tip="ìƒˆ ì˜ì›… ëª¨ì§‘">ğŸ›’ ì‹œì¥ (200ê³¨ë“œ)</button>
      <button onclick="showMercenaries()" class="warning tooltip" data-tip="í•œ ë²ˆì˜ ì „íˆ¬ì— ê°•ë ¥í•œ ìš©ë³‘ ê³ ìš©">ğŸ’° ìš©ë³‘</button>
      <button onclick="showGuildPanel()" class="purple tooltip" data-tip="ê¸¸ë“œ ê°€ì…/ìƒì„±ìœ¼ë¡œ ë²„í”„ íšë“">ğŸ›ï¸ ê¸¸ë“œ</button>
      <button onclick="autoSelectTeam()">âš¡ ìë™ì„ íƒ</button>
    </div>
    <div id="rosterGrid" class="hero-grid" style="margin-top:30px;"></div>

    <h2 style="color:#f0c040; margin:40px 0 20px; text-align:center;">ì „íˆ¬ íŒ€ (5ëª… ì„ íƒ)</h2>
    <div id="teamGrid" class="hero-grid"></div>
  </div>

  <!-- Battle Screen -->
  <div class="screen" id="battle">
    <div class="battle-controls">
      <span style="color:#a0b0c0;">ì†ë„:</span>
      <button class="small" onclick="setBattleSpeed(1)" id="speed1x">1x</button>
      <button class="small" onclick="setBattleSpeed(2)" id="speed2x">2x</button>
      <button class="small" onclick="setBattleSpeed(4)" id="speed4x">4x</button>
      <button class="small" onclick="toggleMusic()" id="musicBtn">ğŸµ ì¼¬</button>
      <button class="small" onclick="toggleSound()" id="soundBtn">ğŸ”Š ì¼¬</button>
    </div>

    <!-- Formation ì„ íƒ -->
    <div class="formation-select" id="formationSelect">
      <div class="formation-option" data-formation="offensive" onclick="selectFormation('offensive')">
        <div class="formation-name">âš”ï¸ ê³µê²©í˜•</div>
        <div class="formation-bonus">ê³µê²© +10%, ë°©ì–´ -5%</div>
      </div>
      <div class="formation-option selected" data-formation="balanced" onclick="selectFormation('balanced')">
        <div class="formation-name">âš–ï¸ ê· í˜•í˜•</div>
        <div class="formation-bonus">ë³´ë„ˆìŠ¤/í˜ë„í‹° ì—†ìŒ</div>
      </div>
      <div class="formation-option" data-formation="defensive" onclick="selectFormation('defensive')">
        <div class="formation-name">ğŸ›¡ï¸ ìˆ˜ë¹„í˜•</div>
        <div class="formation-bonus">ë°©ì–´ +10%, ê³µê²© -5%</div>
      </div>
    </div>

    <div class="battle-area">
      <div class="team-side">
        <h3>ì•„êµ° íŒ€</h3>
        <div id="yourTeamBattle"></div>
      </div>
      <div class="team-side">
        <h3>ì êµ° íŒ€</h3>
        <div id="enemyTeamBattle"></div>
      </div>
    </div>

    <div class="actions">
      <button id="startBattleBtn" onclick="startBattle()">âš”ï¸ ì „íˆ¬ ì‹œì‘</button>
      <button id="autoBattleBtn" onclick="autoBattle()" style="display:none;">âš¡ ìë™ ì „íˆ¬</button>
    </div>

    <h3 style="color:#f0c040; margin:30px 0 15px; text-align:center;">ì „íˆ¬ ê¸°ë¡</h3>
    <div class="battle-log" id="battleLog"></div>
  </div>

  <!-- League Screen -->
  <div class="screen" id="league">
    <div class="league-status">
      <h2>ë¦¬ê·¸ í˜„í™©</h2>
      <div class="league-info">
        <p>ì‹œì¦Œ: <span id="seasonInfo">1</span></p>
        <p>ì§„í–‰í•œ ê²½ê¸°: <span id="matchInfo">0/10</span></p>
        <p>ìŠ¹ë¦¬: <span id="winInfo">0</span> | íŒ¨ë°°: <span id="lossInfo">0</span></p>
        <p>ì´ ëª…ì˜ˆ: <span id="gloryInfo">0</span></p>
      </div>
      <div class="actions" style="margin-top:40px;">
        <button onclick="nextSeason()" id="nextSeasonBtn" disabled>ğŸ¯ ë‹¤ìŒ ì‹œì¦Œ</button>
        <button onclick="showTournament()" id="tournamentBtn" class="warning">ğŸ… í† ë„ˆë¨¼íŠ¸ (500ê³¨ë“œ)</button>
      </div>
    </div>
  </div>

  <!-- PvP Screen -->
  <div class="screen" id="pvp">
    <h2 style="color:#f0c040; margin-bottom:20px; text-align:center;">ğŸ‘¥ ëŒ€ì „ ëª¨ë“œ</h2>
    <p style="text-align:center; color:#a0b0c0; margin-bottom:30px;">ë‘ í”Œë ˆì´ì–´ê°€ ê°™ì€ ê¸°ê¸°ì—ì„œ ì°¨ë¡€ëŒ€ë¡œ í”Œë ˆì´!</p>
    
    <div class="pvp-setup" id="pvpSetup">
      <div class="pvp-player">
        <h3>ğŸ”µ í”Œë ˆì´ì–´ 1</h3>
        <div id="pvpPlayer1Roster"></div>
        <p style="text-align:center; margin-top:15px;">
          ì„ íƒ: <span id="pvpP1Count">0</span>/5
        </p>
      </div>
      <div class="pvp-player">
        <h3>ğŸ”´ í”Œë ˆì´ì–´ 2</h3>
        <div id="pvpPlayer2Roster"></div>
        <p style="text-align:center; margin-top:15px;">
          ì„ íƒ: <span id="pvpP2Count">0</span>/5
        </p>
      </div>
    </div>

    <div class="actions" style="margin-top:30px;">
      <button onclick="startPvPBattle()" id="startPvPBtn">âš”ï¸ ëŒ€ì „ ì‹œì‘</button>
    </div>

    <div id="pvpStats" style="margin-top:40px; text-align:center;">
      <h3 style="color:#f0c040;">ëŒ€ì „ ê¸°ë¡</h3>
      <p style="color:#d0e0f0; margin-top:10px;">
        í”Œë ˆì´ì–´ 1 ìŠ¹ë¦¬: <span id="p1Wins">0</span> | í”Œë ˆì´ì–´ 2 ìŠ¹ë¦¬: <span id="p2Wins">0</span>
      </p>
    </div>
  </div>

  <!-- Achievements Screen -->
  <div class="screen" id="achievements">
    <h2 style="color:#f0c040; margin-bottom:20px; text-align:center;">ì—…ì </h2>
    <div id="achievementGrid" class="achievement-grid"></div>
  </div>

  <!-- Statistics Screen -->
  <div class="screen" id="stats">
    <h2 style="color:#f0c040; margin-bottom:20px; text-align:center;">ê²Œì„ í†µê³„</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="statPlayTime">0ì‹œê°„</div>
        <div class="stat-label">í”Œë ˆì´ ì‹œê°„</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statTotalBattles">0</div>
        <div class="stat-label">ì´ ì „íˆ¬</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statWinRate">0%</div>
        <div class="stat-label">ìŠ¹ë¥ </div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statWinStreak">0</div>
        <div class="stat-label">ìµœê³  ì—°ìŠ¹</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statTotalGold">0</div>
        <div class="stat-label">íšë“ ê³¨ë“œ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statHighestSeason">1</div>
        <div class="stat-label">ìµœê³  ì‹œì¦Œ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statHeroesRecruited">0</div>
        <div class="stat-label">ëª¨ì§‘í•œ ì˜ì›…</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statMaxLevel">1</div>
        <div class="stat-label">ìµœê³  ì˜ì›… ë ˆë²¨</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statLegendaryItems">0</div>
        <div class="stat-label">ì „ì„¤ ì•„ì´í…œ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statAchievements">0</div>
        <div class="stat-label">ì—…ì </div>
      </div>
    </div>

    <!-- Hall of Fame -->
    <div class="hall-of-fame">
      <h3>ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h3>
      <div class="hof-record">
        <span>ìµœê³  ëª…ì˜ˆ:</span>
        <span id="hofGlory">0</span>
      </div>
      <div class="hof-record">
        <span>ìµœê³  ì—°ìŠ¹:</span>
        <span id="hofWinStreak">0</span>
      </div>
      <div class="hof-record">
        <span>ì‹œì¦Œ 20 ìµœë‹¨ ê¸°ë¡:</span>
        <span id="hofFastestS20">-</span>
      </div>
      <div class="hof-record">
        <span>ë‰´ê²Œì„+ í´ë¦¬ì–´:</span>
        <span id="hofNGPlus">0</span>
      </div>
    </div>
  </div>
</div>

<!-- Help Button Fixed -->
<button class="help-btn-fixed" onclick="showHelp()">â“</button>

<!-- Hero Detail Modal -->
<div class="modal" id="heroModal">
  <div class="modal-content">
    <div class="modal-title" id="modalHeroName"></div>
    <div id="modalHeroDetails"></div>
    <div class="modal-actions">
      <button class="success" onclick="showTrainHero()">ğŸ“š í›ˆë ¨</button>
      <button class="warning" onclick="showSkillTree()" id="skillTreeBtn">ğŸŒ³ ìŠ¤í‚¬</button>
      <button class="warning" onclick="showEvolveHero()" id="evolveBtn">â­ ì§„í™”</button>
      <button onclick="showEquipmentManager()">ğŸ’ ì¥ë¹„</button>
      <button class="danger" onclick="showSellHero()">ğŸ’° ë§¤ê°</button>
      <button onclick="closeModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- Tournament Modal -->
<div class="modal" id="tournamentModal">
  <div class="modal-content">
    <div class="modal-title">ğŸ… í† ë„ˆë¨¼íŠ¸</div>
    <div id="tournamentContent"></div>
    <div class="modal-actions">
      <button onclick="closeTournamentModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- Mercenary Modal -->
<div class="modal" id="mercenaryModal">
  <div class="modal-content wide">
    <div class="modal-title">ğŸ’° ìš©ë³‘ ì‹œì¥</div>
    <p style="text-align:center; color:#a0b0c0; margin-bottom:20px;">
      ë‹¨ í•œ ë²ˆì˜ ì „íˆ¬ì— ê°•ë ¥í•œ ìš©ë³‘ ê³ ìš©!
    </p>
    <div id="mercenaryList" class="mercenary-grid"></div>
    <div class="modal-actions">
      <button onclick="closeMercenaryModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- Guild Modal -->
<div class="modal" id="guildModal">
  <div class="modal-content">
    <div class="modal-title">ğŸ›ï¸ ê¸¸ë“œ</div>
    <div id="guildContent"></div>
    <div class="modal-actions" id="guildActions">
      <button onclick="closeGuildModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- Story Modal -->
<div class="modal story-modal" id="storyModal">
  <div class="modal-content">
    <div class="story-chapter" id="storyChapter"></div>
    <div class="story-text" id="storyText"></div>
    <div class="modal-actions">
      <button onclick="closeStoryModal()">ê³„ì†</button>
    </div>
  </div>
</div>

<!-- Ending Modal -->
<div class="modal" id="endingModal">
  <div class="modal-content wide">
    <div class="ending-screen">
      <div class="ending-title">ğŸŠ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸŠ</div>
      <div id="endingContent"></div>
      <div class="modal-actions" style="margin-top:40px;">
        <button class="success" onclick="startNewGamePlus()">ğŸ”„ ë‰´ê²Œì„+</button>
        <button onclick="closeEndingModal()">ê³„ì† í”Œë ˆì´</button>
      </div>
    </div>
  </div>
</div>

<!-- Tutorial Modal -->
<div class="modal" id="tutorialModal">
  <div class="modal-content wide">
    <div class="modal-title">ğŸ“– íŒíƒ€ì§€ ë§¤ë‹ˆì €ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</div>
    <div id="tutorialContent"></div>
    <div class="modal-actions">
      <button onclick="closeTutorialModal()">ì•Œê² ìŠµë‹ˆë‹¤!</button>
    </div>
  </div>
</div>

<!-- Help Modal -->
<div class="modal" id="helpModal">
  <div class="modal-content wide">
    <div class="modal-title">â“ ë„ì›€ë§ & ê°€ì´ë“œ</div>
    <div id="helpContent"></div>
    <div class="modal-actions">
      <button onclick="closeHelpModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// íŒíƒ€ì§€ ë§¤ë‹ˆì € v4 ìµœì¢…íŒ - ê²Œì„ ì—”ì§„
// ============================================================

// --- í´ë˜ìŠ¤ ì •ì˜ (ë°¸ëŸ°ìŠ¤ ì¬ì¡°ì •) ---
const CLASSES = {
  ì „ì‚¬: { hp: 160, atk: 28, def: 18, spd: 10, skill: 'ë°©íŒ¨ ê°•íƒ€' },
  ë§ˆë²•ì‚¬: { hp: 85, atk: 38, def: 6, spd: 9, skill: 'í™”ì—¼êµ¬' },
  ê¶ìˆ˜: { hp: 105, atk: 32, def: 10, spd: 16, skill: 'ë…í™”ì‚´' },
  ì‚¬ì œ: { hp: 95, atk: 18, def: 12, spd: 13, skill: 'ì¹˜ìœ ' },
  íƒ±ì»¤: { hp: 220, atk: 22, def: 28, spd: 6, skill: 'ë„ë°œ' }
};

const RACES = {
  ì¸ê°„: { hp: 10, atk: 5, def: 5, spd: 5 },
  ì—˜í”„: { hp: 0, atk: 10, def: 0, spd: 10 },
  ë“œì›Œí”„: { hp: 20, atk: 5, def: 10, spd: -5 },
  ì˜¤í¬: { hp: 15, atk: 10, def: 5, spd: -5 },
  ìš©ì¡±: { hp: 10, atk: 10, def: 10, spd: 0 }
};

const CLASS_KEYS = Object.keys(CLASSES);
const RACE_KEYS = Object.keys(RACES);

// --- ì¥ë¹„ ë“±ê¸‰ ì‹œìŠ¤í…œ ---
const EQUIPMENT_GRADES = {
  common: { color: '#999', multiplier: 1.0, dropRate: 0.60, name: 'ì¼ë°˜' },
  rare: { color: '#4a8af0', multiplier: 1.5, dropRate: 0.25, name: 'í¬ê·€' },
  epic: { color: '#a040f0', multiplier: 2.0, dropRate: 0.12, hasEffect: true, name: 'ì˜ì›…' },
  legendary: { color: '#f0a040', multiplier: 2.5, dropRate: 0.03, hasEffect: true, name: 'ì „ì„¤' }
};

// --- íŠ¹ìˆ˜ íš¨ê³¼ ---
const SPECIAL_EFFECTS = {
  vampire: { name: 'í¡í˜ˆ', desc: 'ì…íŒ í”¼í•´ì˜ 20% ì¹˜ìœ ', epic: true },
  lightning: { name: 'ë²ˆê°œ', desc: 'ê³µê²© ì‹œ ì¶”ê°€ ê´‘ì—­ í”¼í•´', epic: true },
  phoenix: { name: 'ë¶ˆì‚¬ì¡°', desc: 'HP 50%ë¡œ í•œ ë²ˆ ë¶€í™œ', legendary: true },
  frost: { name: 'ëƒ‰ê¸°', desc: 'ê³µê²© ì‹œ 30% í™•ë¥ ë¡œ ë¹™ê²°', epic: true },
  berserk: { name: 'ê´‘ì „ì‚¬', desc: 'HP 50% ë¯¸ë§Œì¼ ë•Œ ê³µê²© +30%', legendary: true },
  guardian: { name: 'ìˆ˜í˜¸ì', desc: 'ë°›ëŠ” í”¼í•´ 15% ê°ì†Œ', epic: true }
};

// --- ì¥ë¹„ íƒ€ì… ì •ì˜ ---
const EQUIPMENT_TYPES = {
  ë¬´ê¸°: { 
    icon: 'âš”ï¸',
    baseStats: () => ({ atk: 8 + Math.floor(Math.random() * 12) })
  },
  ê°‘ì˜·: { 
    icon: 'ğŸ›¡ï¸',
    baseStats: () => ({ def: 6 + Math.floor(Math.random() * 8), hp: 15 + Math.floor(Math.random() * 35) })
  },
  ì•…ì„¸ì„œë¦¬: { 
    icon: 'ğŸ’',
    baseStats: () => ({ spd: 3 + Math.floor(Math.random() * 7), crit: 6 + Math.floor(Math.random() * 10) })
  }
};

// --- ìŠ¤í‚¬ íŠ¸ë¦¬ ì •ì˜ ---
const SKILL_TREES = {
  ì „ì‚¬: {
    10: {
      A: { name: 'ê´‘ì „ì‚¬', desc: 'ê³µê²© +50%, ë°©ì–´ -30%', bonus: { atk: 0.5, def: -0.3 } },
      B: { name: 'ìˆ˜í˜¸ì', desc: 'ë°©ì–´ +50%, HP +30%', bonus: { def: 0.5, hp: 0.3 } }
    },
    20: {
      A: { name: 'ì „ìŸêµ°ì£¼', desc: 'ê³µê²© +100%, ë°©ì–´ -50%', bonus: { atk: 1.0, def: -0.5 } },
      B: { name: 'ìš”ìƒˆ', desc: 'ë°©ì–´ +100%, HP +50%', bonus: { def: 1.0, hp: 0.5 } }
    }
  },
  ë§ˆë²•ì‚¬: {
    10: {
      A: { name: 'í™”ì—¼ìˆ ì‚¬', desc: 'í™”ì—¼ í”¼í•´ +50%', bonus: { atk: 0.3 } },
      B: { name: 'ëƒ‰ê¸°ìˆ ì‚¬', desc: 'ëƒ‰ê¸° ìŠ¤í‚¬, ì  ë‘”í™”', bonus: { atk: 0.2 } }
    },
    20: {
      A: { name: 'ëŒ€ë§ˆë²•ì‚¬', desc: 'ê³µê²© +80%, ë‹¤ì¤‘ ëŒ€ìƒ', bonus: { atk: 0.8 } },
      B: { name: 'ë¹™ê²°ìˆ ì‚¬', desc: 'ë¹™ê²° + ë°©ì–´ +40%', bonus: { atk: 0.4, def: 0.4 } }
    }
  },
  ê¶ìˆ˜: {
    10: {
      A: { name: 'ì•”ì‚´ì', desc: 'ì¹˜ëª…íƒ€ +20%, ë… +50%', bonus: { crit: 20 } },
      B: { name: 'ì €ê²©ìˆ˜', desc: 'ë‹¨ì¼ ëŒ€ìƒ ê³µê²© x2.5', bonus: { atk: 0.5 } }
    },
    20: {
      A: { name: 'ê·¸ë¦¼ìì¹¼ë‚ ', desc: 'ì¹˜ëª…íƒ€ +40%, ê³µê²© +60%', bonus: { crit: 40, atk: 0.6 } },
      B: { name: 'ëª…ì‚¬ìˆ˜', desc: 'ê³µê²© +100%, ì„ ì œê³µê²©', bonus: { atk: 1.0, spd: 0.3 } }
    }
  },
  ì‚¬ì œ: {
    10: {
      A: { name: 'ì„±ì§ì', desc: 'ì¹˜ìœ  +50%, ê´‘ì—­ ì¹˜ìœ ', bonus: { atk: 0.3 } },
      B: { name: 'ì„±ê¸°ì‚¬', desc: 'ê³µê²© +15, ê³µê²© ê°€ëŠ¥', bonus: { atk: 15 } }
    },
    20: {
      A: { name: 'ëŒ€ì‚¬ì œ', desc: 'ì¹˜ìœ  +100%, ë¶€í™œ', bonus: { atk: 0.5 } },
      B: { name: 'ì‹­ìêµ°', desc: 'ê³µê²© +25, ë°©ì–´ +30%', bonus: { atk: 25, def: 0.3 } }
    }
  },
  íƒ±ì»¤: {
    10: {
      A: { name: 'ì „ìŸêµ°ì£¼', desc: 'ë„ë°œ + ë°˜ê²© í”¼í•´', bonus: { atk: 0.3 } },
      B: { name: 'ìš”ìƒˆ', desc: 'HP +100%, ë°©ì–´ +30%', bonus: { hp: 1.0, def: 0.3 } }
    },
    20: {
      A: { name: 'ê´‘ì „íƒ±ì»¤', desc: 'ê³µê²© +50%, ë°˜ê²© x2', bonus: { atk: 0.5 } },
      B: { name: 'ì² ë²½', desc: 'HP +150%, ë°©ì–´ +60%', bonus: { hp: 1.5, def: 0.6 } }
    }
  }
};

// --- ê¶ê·¹ê¸° ì •ì˜ ---
const ULTIMATE_SKILLS = {
  ì „ì‚¬: { name: 'íƒ€ì´íƒ„ì˜ ì¼ê²©', desc: 'ë§‰ëŒ€í•œ ê´‘ì—­ í”¼í•´' },
  ë§ˆë²•ì‚¬: { name: 'ë©”í…Œì˜¤ ìŠ¤í†°', desc: 'ë‹¤ì¤‘ í™”ì—¼ í”¼í•´' },
  ê¶ìˆ˜: { name: 'ì£½ìŒì˜ í™”ì‚´', desc: 'ë‚®ì€ HP ëŒ€ìƒ ì¦‰ì‚¬' },
  ì‚¬ì œ: { name: 'ì‹ ì„±í•œ ì¶•ë³µ', desc: 'ì „ì²´ íŒ€ ì¹˜ìœ  + ë²„í”„' },
  íƒ±ì»¤: { name: 'ë¶ˆêµ´', desc: 'ë¬´ì  + ë°˜ì‚¬' }
};

// --- ìŠ¤í† ë¦¬ ì±•í„° ---
const STORY_CHAPTERS = {
  1: {
    title: 'ì œ1ì¥: ì‹œì‘',
    text: 'ì „ìŸìœ¼ë¡œ ì°¢ê¸´ ëŒ€ë¥™ì—ì„œ, ë‹¹ì‹ ì€ ì˜ì›…ë“¤ì˜ ìƒˆë¡œìš´ ë§¤ë‹ˆì €ë¡œ ë– ì˜¤ë¦…ë‹ˆë‹¤...\n\nëª…ì˜ˆë¥¼ í–¥í•œ ì—¬ì •ì´ ì§€ê¸ˆ ì‹œì‘ë©ë‹ˆë‹¤. ì „ì‚¬ë“¤ì„ ëª¨ì§‘í•˜ê³ , ì˜ í›ˆë ¨ì‹œì¼œ, ìŠ¹ë¦¬ë¡œ ì´ë„ì‹­ì‹œì˜¤!'
  },
  5: {
    title: 'ì œ2ì¥: ëª…ì„±ì˜ ìƒìŠ¹',
    text: 'ë‹¹ì‹ ì˜ ì´ë¦„ì´ ì™•êµ­ ì „ì—­ì— í¼ì§‘ë‹ˆë‹¤. ë‹¤ë¥¸ ë§¤ë‹ˆì €ë“¤ì´ ë¶€ëŸ¬ìš´ ëˆˆìœ¼ë¡œ ë‹¹ì‹ ì˜ ì§„ë³´ë¥¼ ì§€ì¼œë´…ë‹ˆë‹¤...\n\ní•˜ì§€ë§Œ ì¡°ì‹¬í•˜ì„¸ìš”, ë” ê°•í•œ ì ë“¤ì´ ê¸°ë‹¤ë¦½ë‹ˆë‹¤. ì•ìœ¼ë¡œì˜ ê¸¸ì€ í—˜ë‚œí•©ë‹ˆë‹¤!'
  },
  10: {
    title: 'ì œ3ì¥: ë„ì „',
    text: 'ëŒ€í† ë„ˆë¨¼íŠ¸ê°€ ì†ì§“í•©ë‹ˆë‹¤. ë¨¼ ë•…ì—ì„œ ì˜¨ ì±”í”¼ì–¸ë“¤ì´ ìì‹ ì˜ í˜ì„ ì‹œí—˜í•˜ëŸ¬ ì™”ìŠµë‹ˆë‹¤...\n\nì˜¤ì§ ê°€ì¥ ê°•í•œ ìë§Œì´ ì‚´ì•„ë‚¨ì„ ê²ƒì…ë‹ˆë‹¤. ìµœí›„ì˜ ì‹œí—˜ì„ ìœ„í•´ ì˜ì›…ë“¤ì„ ì¤€ë¹„ì‹œí‚¤ì‹­ì‹œì˜¤!'
  },
  15: {
    title: 'ì œ4ì¥: ì–´ë‘ìš´ êµ¬ë¦„',
    text: 'ëŒ€ë¥™ì— ê·¸ë¦¼ìê°€ ë“œë¦¬ì›ë‹ˆë‹¤. ìŠí˜€ì§„ ë˜ì „ì—ì„œ ê³ ëŒ€ì˜ ì•…ì´ ê¹¨ì–´ë‚©ë‹ˆë‹¤...\n\nì˜ì›…ë“¤ì€ ë”ìš± ê°•í•´ì ¸ì•¼ í•©ë‹ˆë‹¤. ìµœí›„ì˜ ì „íˆ¬ê°€ ë‹¤ê°€ì˜µë‹ˆë‹¤!'
  },
  20: {
    title: 'ì œ5ì¥: ìµœí›„ì˜ ì „íˆ¬',
    text: 'ì•”í‘êµ°ì£¼ê°€ ê¹¨ì–´ë‚¬ìŠµë‹ˆë‹¤! ì˜¤ì§ ë‹¹ì‹ ë§Œì´ ì¢…ë§ì„ ë§‰ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤...\n\nê°€ì¥ ê°•í•œ ì˜ì›…ë“¤ì„ ëª¨ìœ¼ì‹­ì‹œì˜¤. ì´ê²ƒì€ ë‹¹ì‹  ì¸ìƒì˜ ì „íˆ¬ì…ë‹ˆë‹¤!'
  }
};

// --- ì—…ì  ì •ì˜ ---
const ACHIEVEMENTS = [
  { id: 'firstVictory', name: 'ì²« ìŠ¹ë¦¬', desc: 'ì²« ì „íˆ¬ ìŠ¹ë¦¬', reward: { gold: 100 } },
  { id: 'seasonMaster', name: 'ì‹œì¦Œ ë§ˆìŠ¤í„°', desc: 'ì‹œì¦Œ 10 ë„ë‹¬', reward: { gold: 500, glory: 100 } },
  { id: 'perfectSeason', name: 'ì™„ë²½í•œ ì‹œì¦Œ', desc: '10ê²½ê¸° ëª¨ë‘ ìŠ¹ë¦¬', reward: { gold: 1000 } },
  { id: 'tournamentChamp', name: 'í† ë„ˆë¨¼íŠ¸ ì±”í”¼ì–¸', desc: 'í† ë„ˆë¨¼íŠ¸ ìš°ìŠ¹', reward: { gold: 2000, glory: 500 } },
  { id: 'collector', name: 'ìˆ˜ì§‘ê°€', desc: '15ëª…ì˜ ì˜ì›… ë³´ìœ ', reward: { gold: 300 } },
  { id: 'legendaryHero', name: 'ì „ì„¤ì˜ ì˜ì›…', desc: 'ì˜ì›…ì„ ë ˆë²¨ 30ê¹Œì§€ ì„±ì¥', reward: { gold: 1500 } },
  { id: 'evolved', name: 'ì§„í™”', desc: 'ì˜ì›… ì§„í™”', reward: { gold: 500, glory: 100 } },
  { id: 'rich', name: 'ë¶€ì', desc: 'ê³¨ë“œ 5000 ë³´ìœ ', reward: { glory: 200 } },
  { id: 'gloryHunter', name: 'ëª…ì˜ˆ ì‚¬ëƒ¥ê¾¼', desc: 'ëª…ì˜ˆ 1000 íšë“', reward: { gold: 1000 } },
  { id: 'equipmentMaster', name: 'ì¥ë¹„ ë§ˆìŠ¤í„°', desc: 'ì „ì„¤ ì¥ë¹„ íšë“', reward: { gold: 800 } },
  { id: 'guildMaster', name: 'ê¸¸ë“œ ë§ˆìŠ¤í„°', desc: 'ê¸¸ë“œ ë ˆë²¨ 5 ë‹¬ì„±', reward: { gold: 1500, glory: 300 } },
  { id: 'pvpChampion', name: 'ëŒ€ì „ ì±”í”¼ì–¸', desc: 'ëŒ€ì „ 10ìŠ¹', reward: { gold: 1000, glory: 200 } },
  { id: 'mercenaryLord', name: 'ìš©ë³‘ êµ°ì£¼', desc: 'ìš©ë³‘ 10íšŒ ê³ ìš©', reward: { gold: 500 } },
  { id: 'storyComplete', name: 'ìŠ¤í† ë¦¬ ì™„ë£Œ', desc: 'ìŠ¤í† ë¦¬ ì™„ë£Œ', reward: { gold: 3000, glory: 1000 } },
  { id: 'newGamePlus', name: 'ì „ì„¤', desc: 'ë‰´ê²Œì„+ ì™„ë£Œ', reward: { gold: 5000, glory: 2000 } }
];

// --- AI íŒ€ ì´ë¦„ ---
const AI_TEAM_NAMES = [
  'í˜ˆì¡± ê¹Œë§ˆê·€ë‹¨', 'ê·¸ë¦¼ì êµ°ë‹¨', 'ê°•ì²  ëŠ‘ëŒ€ë‹¨', 'í­í’ì¸ë„ì', 'ì•”í‘ê¸°ì‚¬ë‹¨',
  'í™©ê¸ˆ ì‚¬ìë‹¨', 'ì§„í™ ì¹¼ë‚ ë‹¨', 'ì„œë¦¬ ê±°ì¸ë‹¨', 'ë¶ˆì‚¬ì¡° ê·¼ìœ„ëŒ€', 'ìš©ì¡±',
  'ë°¤ì˜ ì¶”ì ì', 'ì²œë‘¥ì£¼ë¨¹ë‹¨', 'ê³µí—ˆ ë°©ë‘ì', 'ë³„ì˜ ì‹­ìêµ°', 'ì•…ë§ˆ ì‚¬ëƒ¥ê¾¼'
];

// --- ê²Œì„ ìƒíƒœ ---
let gameState = {
  gold: 1000,
  glory: 0,
  season: 1,
  matchesPlayed: 0,
  wins: 0,
  losses: 0,
  roster: [],
  team: [],
  enemyTeam: [],
  battleInProgress: false,
  inventory: [],
  selectedHero: null,
  achievements: {},
  statistics: {
    totalBattles: 0,
    totalWins: 0,
    totalGoldEarned: 0,
    highestSeason: 1,
    heroesRecruited: 0,
    maxHeroLevel: 1,
    currentWinStreak: 0,
    bestWinStreak: 0,
    legendaryItemsFound: 0,
    playStartTime: Date.now(),
    playTimeMs: 0,
    fastestSeason20: null,
    ngPlusClears: 0,
    mercsHired: 0
  },
  tournament: {
    active: false,
    enteredThisSeason: false,
    round: 0,
    bracket: [],
    currentMatch: null
  },
  settings: {
    battleSpeed: 1,
    musicEnabled: true,
    soundEnabled: true
  },
  // v4: ìƒˆ ì†ì„±
  guild: null,
  pvp: {
    p1Wins: 0,
    p2Wins: 0,
    p1Team: [],
    p2Team: []
  },
  mercenaries: [],
  formation: 'balanced',
  storyProgress: [],
  ngPlusLevel: 0,
  tutorialShown: false,
  lastSeason20Clear: null
};

// ì „íˆ¬ ìƒíƒœ
let battleState = {
  effects: {},
  turnCount: 0,
  isPvP: false,
  isTournament: false
};

let heroIdCounter = 1;
let equipmentIdCounter = 1;

// --- ì´ˆê¸°í™” ---
function init() {
  loadGame();
  
  // ì²« ì‹¤í–‰ ì‹œ ì‹œì‘ ë¡œìŠ¤í„° ìƒì„±
  if (gameState.roster.length === 0) {
    for (let i = 0; i < 8; i++) {
      gameState.roster.push(generateHero(1));
    }
    gameState.statistics.heroesRecruited = 8;
  }
  
  // í•˜ìœ„ í˜¸í™˜ì„± ì²˜ë¦¬
  migrateGameState();
  
  updateUI();
  renderRoster();
  renderTeam();
  renderAchievements();
  updateStatistics();
  renderPvPRosters();
  
  // ë°°ê²½ìŒì•… ì´ˆê¸°í™”
  initAudio();
  
  // íŠœí† ë¦¬ì–¼
  if (!gameState.tutorialShown) {
    showTutorial();
    gameState.tutorialShown = true;
    saveGame();
  }
  
  // ìŠ¤í† ë¦¬ ì²´í¬
  checkStoryProgress();
  
  // í”Œë ˆì´ íƒ€ì„ ì¶”ì 
  setInterval(updatePlayTime, 60000);
}

function migrateGameState() {
  // v3 -> v4 ë§ˆì´ê·¸ë ˆì´ì…˜
  gameState.roster.forEach(hero => {
    if (!hero.equipment) hero.equipment = { weapon: null, armor: null, accessory: null };
    if (hero.maxLevel === undefined) hero.maxLevel = 30;
    if (hero.skillPath === undefined) hero.skillPath = { 10: null, 20: null };
    if (hero.evolved === undefined) hero.evolved = false;
    if (hero.ultimateSkill === undefined) hero.ultimateSkill = null;
  });
  
  if (!gameState.inventory) gameState.inventory = [];
  if (!gameState.achievements) gameState.achievements = {};
  if (!gameState.statistics) {
    gameState.statistics = {
      totalBattles: 0, totalWins: 0, totalGoldEarned: 0,
      highestSeason: 1, heroesRecruited: gameState.roster.length,
      maxHeroLevel: Math.max(...gameState.roster.map(h => h.level), 1),
      currentWinStreak: 0, bestWinStreak: 0, legendaryItemsFound: 0,
      playStartTime: Date.now(), playTimeMs: 0, fastestSeason20: null, ngPlusClears: 0, mercsHired: 0
    };
  }
  if (!gameState.tournament) {
    gameState.tournament = { active: false, enteredThisSeason: false, round: 0, bracket: [], currentMatch: null };
  }
  if (!gameState.settings) gameState.settings = { battleSpeed: 1, musicEnabled: true, soundEnabled: true };
  if (!gameState.guild) gameState.guild = null;
  if (!gameState.pvp) gameState.pvp = { p1Wins: 0, p2Wins: 0, p1Team: [], p2Team: [] };
  if (!gameState.mercenaries) gameState.mercenaries = [];
  if (!gameState.formation) gameState.formation = 'balanced';
  if (!gameState.storyProgress) gameState.storyProgress = [];
  if (gameState.ngPlusLevel === undefined) gameState.ngPlusLevel = 0;
  if (gameState.tutorialShown === undefined) gameState.tutorialShown = false;
  
  // ì¥ë¹„ ë“±ê¸‰ ë§ˆì´ê·¸ë ˆì´ì…˜
  [...gameState.inventory, ...gameState.roster.flatMap(h => Object.values(h.equipment).filter(e => e))].forEach(eq => {
    if (!eq.grade) eq.grade = eq.legendary ? 'legendary' : 'common';
    if (!eq.enhanceLevel) eq.enhanceLevel = 0;
  });
}

// --- ì˜ì›… ìƒì„± ---
function generateHero(level) {
  const classKey = CLASS_KEYS[Math.floor(Math.random() * CLASS_KEYS.length)];
  const raceKey = RACE_KEYS[Math.floor(Math.random() * RACE_KEYS.length)];
  const classData = CLASSES[classKey];
  const raceData = RACES[raceKey];

  const baseHp = classData.hp + raceData.hp;
  const baseAtk = classData.atk + raceData.atk;
  const baseDef = classData.def + raceData.def;
  const baseSpd = classData.spd + raceData.spd;

  const hero = {
    id: heroIdCounter++,
    name: generateName(raceKey),
    class: classKey,
    race: raceKey,
    level,
    baseHp, baseAtk, baseDef, baseSpd,
    hp: baseHp + (level - 1) * 12,
    atk: baseAtk + (level - 1) * 2.5,
    def: baseDef + (level - 1) * 1.2,
    spd: baseSpd + Math.floor((level - 1) * 0.6),
    skill: classData.skill,
    equipment: { weapon: null, armor: null, accessory: null },
    maxLevel: 30,
    skillPath: { 10: null, 20: null },
    evolved: false,
    ultimateSkill: null
  };
  hero.maxHp = hero.hp;
  return hero;
}

function generateName(race) {
  const prefixes = {
    ì¸ê°„: ['ì•„ì„œ', 'ì„¸ë“œë¦­', 'ì—ë“œë¨¼ë“œ', 'ë¡¤ë‘', 'íŠ¸ë¦¬ìŠ¤íƒ„', 'ê°ˆë¼í•˜ë“œ', 'í¼ì‹œë²Œ', 'ë§ˆë¥´ì¿ ìŠ¤', 'í—¬ë ˆë‚˜', 'ë””ì•„ë‚˜'],
    ì—˜í”„: ['ë ˆê³¨ë¼ìŠ¤', 'ê°ˆë¼ë“œë¦¬ì—˜', 'ìŠ¤ë€ë‘ì¼', 'ì•„ë¥´ì›¬', 'ì¼ˆë ˆë³´ë¥¸', 'ì—˜ë¡ ë“œ', 'íƒ€ìš°ë¦¬ì—˜', 'í•€ë¡œë“œ'],
    ë“œì›Œí”„: ['ê¹€ë¦¬', 'ì†Œë¦°', 'ë°œë¦°', 'ë“œì™ˆë¦°', 'í•„ë¦¬', 'í‚¬ë¦¬', 'ë´„ë¶€ë¥´', 'ë³´í‘¸ë¥´'],
    ì˜¤í¬: ['ê·¸ë¡¬', 'ë“€ë¡œíƒ„', 'ìŠ¤ë„', 'ê°€ë¡œì‰¬', 'ê·¸ë¡¬ë§ˆì‰¬', 'ì˜¤ê·¸ë¦¼', 'ë‚˜ì¦ˆê·¸ë '],
    ìš©ì¡±: ['ë“œë¼ì¹´ë¦¬ì˜¨', 'íŒŒì´ë¡œí† ë¥´', 'ìŠ¤ì¼€ì¼ëª¨', 'í“Œë½ì‹œìŠ¤', 'ë“œë¼ì½”ëˆ„ìŠ¤', 'ì´ê·¸ë‹ˆìŠ¤', 'ì— ë²„í´ë¡œ']
  };
  const pool = prefixes[race] || ['ì˜ì›…'];
  return pool[Math.floor(Math.random() * pool.length)];
}

// --- ì¥ë¹„ ìƒì„± (4ë“±ê¸‰ ì‹œìŠ¤í…œ) ---
function generateEquipment(forceGrade = null) {
  const types = Object.keys(EQUIPMENT_TYPES);
  const type = types[Math.floor(Math.random() * types.length)];
  const typeData = EQUIPMENT_TYPES[type];
  
  // ë“±ê¸‰ ê²°ì •
  let grade = forceGrade;
  if (!grade) {
    const roll = Math.random();
    let cumulative = 0;
    for (const [g, data] of Object.entries(EQUIPMENT_GRADES)) {
      cumulative += data.dropRate;
      if (roll < cumulative) { grade = g; break; }
    }
  }
  
  const gradeData = EQUIPMENT_GRADES[grade];
  let stats = typeData.baseStats();
  
  // ë“±ê¸‰ ë°°ìœ¨ ì ìš©
  Object.keys(stats).forEach(key => {
    stats[key] = Math.floor(stats[key] * gradeData.multiplier);
  });
  
  // íŠ¹ìˆ˜ íš¨ê³¼ (Epic, Legendary)
  let effect = null;
  if (gradeData.hasEffect) {
    const possibleEffects = Object.entries(SPECIAL_EFFECTS)
      .filter(([_, e]) => grade === 'legendary' ? true : e.epic);
    if (possibleEffects.length > 0) {
      const [effectKey, effectData] = possibleEffects[Math.floor(Math.random() * possibleEffects.length)];
      effect = effectKey;
    }
  }
  
  let totalValue = Object.values(stats).reduce((a, b) => a + b, 0);
  const price = Math.floor(50 + totalValue * 3 * gradeData.multiplier);
  
  return {
    id: equipmentIdCounter++,
    type,
    name: generateEquipmentName(type, grade),
    stats,
    price: Math.min(500, price),
    grade,
    effect,
    enhanceLevel: 0
  };
}

function generateEquipmentName(type, grade) {
  const prefixes = {
    common: { ë¬´ê¸°: ['ì² ', 'ê°•ì² ', 'ì²­ë™'], ê°‘ì˜·: ['ê°€ì£½', 'ì‚¬ìŠ¬', 'íŒê¸ˆ'], ì•…ì„¸ì„œë¦¬: ['ì€', 'êµ¬ë¦¬', 'í‰ë²”í•œ'] },
    rare: { ë¬´ê¸°: ['ë‚ ì¹´ë¡œìš´', 'ê°•ë ¥í•œ', 'ì˜ˆë¦¬í•œ'], ê°‘ì˜·: ['ì¤‘ì¥', 'ë§ˆë²•ë¶€ì—¬ëœ', 'ê²¬ê³ í•œ'], ì•…ì„¸ì„œë¦¬: ['ì‹ ì†í•œ', 'í–‰ìš´ì˜', 'ì¶•ë³µë°›ì€'] },
    epic: { ë¬´ê¸°: ['ê³ ëŒ€ì˜', 'ì €ì£¼ë°›ì€', 'ìš©ì˜'], ê°‘ì˜·: ['ì˜í˜¼ì˜', 'ê·¸ë¦¼ì', 'ìˆ˜ì •'], ì•…ì„¸ì„œë¦¬: ['ë¹„ì „ì˜', 'ì‹ ë¹„í•œ', 'ì •ë ¹ì˜'] },
    legendary: { ë¬´ê¸°: ['ì‹ ì„ ë² ëŠ”', 'ì˜ì›í•œ', 'ì‹ ì„±í•œ'], ê°‘ì˜·: ['ë¶ˆë©¸ì˜', 'ì²œìƒì˜', 'íƒ€ì´íƒ„'], ì•…ì„¸ì„œë¦¬: ['ìµœê³ ì˜', 'ìš°ì£¼ì˜', 'íƒœê³ ì˜'] }
  };
  
  const suffixes = {
    ë¬´ê¸°: ['ê²€', 'ì¹¼ë‚ ', 'ë„ë¼', 'ì°½', 'ë§ì¹˜'],
    ê°‘ì˜·: ['íŒê¸ˆ', 'ê°‘ì˜·', 'ë°©íŒ¨', 'ì¡°ë¼', 'ë°©ë²½'],
    ì•…ì„¸ì„œë¦¬: ['ë°˜ì§€', 'ëª©ê±¸ì´', 'íœë˜íŠ¸', 'ë¶€ì ', 'ì¸ì¥']
  };
  
  const prefix = prefixes[grade]?.[type]?.[Math.floor(Math.random() * 3)] || 'ê¸°ë³¸';
  const suffix = suffixes[type][Math.floor(Math.random() * suffixes[type].length)];
  
  return `${prefix} ${suffix}`;
}

// --- ìš©ë³‘ ìƒì„± ---
function generateMercenary() {
  const level = gameState.season * 2;
  const hero = generateHero(level);
  hero.isMercenary = true;
  hero.name = 'ğŸ’° ' + hero.name;
  
  // ì „ì„¤ ì¥ë¹„ ì°©ìš©
  hero.equipment.weapon = generateEquipment('legendary');
  hero.equipment.armor = generateEquipment('epic');
  
  const baseCost = 300 + gameState.season * 20;
  hero.hireCost = Math.min(500, baseCost);
  
  // ê¸¸ë“œ í• ì¸
  if (gameState.guild) {
    const discount = 0.1 * gameState.guild.level;
    hero.hireCost = Math.floor(hero.hireCost * (1 - discount));
  }
  
  return hero;
}

function showMercenaries() {
  // 3ëª…ì˜ ìš©ë³‘ ìƒì„±
  gameState.mercenaries = [generateMercenary(), generateMercenary(), generateMercenary()];
  
  const list = document.getElementById('mercenaryList');
  list.innerHTML = '';
  
  gameState.mercenaries.forEach((merc, idx) => {
    const stats = getHeroStats(merc);
    const card = document.createElement('div');
    card.className = 'mercenary-card';
    card.innerHTML = `
      <div class="hero-name">${merc.name}</div>
      <div class="hero-class">${merc.race} ${merc.class}</div>
      <div class="hero-level">ë ˆë²¨ ${merc.level}</div>
      <div class="hero-stats">
        HP: ${stats.maxHp} | ê³µê²©: ${stats.atk}<br>
        ë°©ì–´: ${stats.def} | ì†ë„: ${stats.spd}<br>
        ìŠ¤í‚¬: ${merc.skill}
      </div>
      <div style="margin-top:10px; text-align:center;">
        <button class="small warning" onclick="hireMercenary(${idx})">
          ê³ ìš© (${merc.hireCost}ê³¨ë“œ)
        </button>
      </div>
    `;
    list.appendChild(card);
  });
  
  document.getElementById('mercenaryModal').classList.add('active');
}

function hireMercenary(idx) {
  const merc = gameState.mercenaries[idx];
  if (!merc) return;
  
  if (gameState.gold < merc.hireCost) {
    alert('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
    return;
  }
  
  if (gameState.team.length >= 5) {
    alert('íŒ€ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤! ë¨¼ì € ì˜ì›…ì„ ì œê±°í•˜ì„¸ìš”.');
    return;
  }
  
  gameState.gold -= merc.hireCost;
  gameState.team.push(merc);
  gameState.statistics.mercsHired++;
  
  closeMercenaryModal();
  updateUI();
  renderTeam();
  saveGame();
  
  alert(`${merc.name}ì´(ê°€) í•œ ë²ˆì˜ ì „íˆ¬ë¥¼ ìœ„í•´ íŒ€ì— í•©ë¥˜í–ˆìŠµë‹ˆë‹¤!`);
}

function closeMercenaryModal() {
  document.getElementById('mercenaryModal').classList.remove('active');
}

// --- ê¸¸ë“œ ì‹œìŠ¤í…œ ---
function showGuildPanel() {
  const content = document.getElementById('guildContent');
  const actions = document.getElementById('guildActions');
  
  if (!gameState.guild) {
    content.innerHTML = `
      <div class="guild-panel">
        <h3 style="color:#f0c040; margin-bottom:20px;">ê¸¸ë“œ ìƒì„± ë˜ëŠ” ê°€ì…</h3>
        <p style="color:#a0b0c0; margin-bottom:20px;">
          ê¸¸ë“œëŠ” íŒ€ì„ ë„ìš¸ ê°•ë ¥í•œ ë²„í”„ë¥¼ ì œê³µí•©ë‹ˆë‹¤!
        </p>
        <div style="margin-bottom:20px;">
          <input type="text" id="guildNameInput" placeholder="ê¸¸ë“œ ì´ë¦„ ì…ë ¥" 
                 style="padding:10px; width:200px; border-radius:6px; border:2px solid #4a8ab5; background:#1a2a3a; color:#fff;">
        </div>
        <div class="guild-buffs">
          <div class="guild-buff">
            <div style="font-size:20px;">ğŸ“š</div>
            <div>í›ˆë ¨ ë¹„ìš©</div>
            <div style="color:#4ab58a;">-20%</div>
          </div>
          <div class="guild-buff">
            <div style="font-size:20px;">ğŸ’°</div>
            <div>ì „íˆ¬ ë³´ìƒ</div>
            <div style="color:#4ab58a;">+10%</div>
          </div>
          <div class="guild-buff">
            <div style="font-size:20px;">ğŸ’</div>
            <div>ìš©ë³‘ ë¹„ìš©</div>
            <div style="color:#4ab58a;">-10%</div>
          </div>
        </div>
      </div>
    `;
    actions.innerHTML = `
      <button class="success" onclick="createGuild()">ê¸¸ë“œ ìƒì„± (500ê³¨ë“œ)</button>
      <button onclick="closeGuildModal()">ë‹«ê¸°</button>
    `;
  } else {
    const g = gameState.guild;
    const nextLevelCost = g.level * 500;
    const buffMultiplier = 1 + (g.level - 1) * 0.2;
    
    content.innerHTML = `
      <div class="guild-panel">
        <h3 style="color:#f0c040; margin-bottom:10px;">ğŸ›ï¸ ${g.name}</h3>
        <p style="color:#a0b0c0;">ë ˆë²¨ ${g.level}</p>
        <p style="color:#8090a0; margin-top:5px;">íˆ¬ìí•œ ëª…ì˜ˆ: ${g.gloryInvested}</p>
        
        <div class="guild-buffs" style="margin-top:30px;">
          <div class="guild-buff">
            <div style="font-size:20px;">ğŸ“š</div>
            <div>í›ˆë ¨ ë¹„ìš©</div>
            <div style="color:#4ab58a;">-${Math.floor(20 * buffMultiplier)}%</div>
          </div>
          <div class="guild-buff">
            <div style="font-size:20px;">ğŸ’°</div>
            <div>ì „íˆ¬ ë³´ìƒ</div>
            <div style="color:#4ab58a;">+${Math.floor(10 * buffMultiplier)}%</div>
          </div>
          <div class="guild-buff">
            <div style="font-size:20px;">ğŸ’</div>
            <div>ìš©ë³‘ ë¹„ìš©</div>
            <div style="color:#4ab58a;">-${Math.floor(10 * buffMultiplier)}%</div>
          </div>
        </div>
        
        <div style="margin-top:30px;">
          <p>ë ˆë²¨ ${g.level + 1}ë¡œ ì—…ê·¸ë ˆì´ë“œ: ${nextLevelCost} ëª…ì˜ˆ</p>
        </div>
      </div>
    `;
    actions.innerHTML = `
      <button class="success" onclick="upgradeGuild()" ${gameState.glory < nextLevelCost ? 'disabled' : ''}>
        ì—…ê·¸ë ˆì´ë“œ (${nextLevelCost} ëª…ì˜ˆ)
      </button>
      <button onclick="closeGuildModal()">ë‹«ê¸°</button>
    `;
  }
  
  document.getElementById('guildModal').classList.add('active');
}

function createGuild() {
  const name = document.getElementById('guildNameInput').value.trim();
  if (!name) {
    alert('ê¸¸ë“œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!');
    return;
  }
  
  if (gameState.gold < 500) {
    alert('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! 500ê³¨ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }
  
  gameState.gold -= 500;
  gameState.guild = {
    name: name,
    level: 1,
    gloryInvested: 0
  };
  
  updateUI();
  showGuildPanel();
  saveGame();
  
  alert(`ê¸¸ë“œ "${name}"ì´(ê°€) ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
}

function upgradeGuild() {
  if (!gameState.guild) return;
  
  const cost = gameState.guild.level * 500;
  if (gameState.glory < cost) {
    alert('ëª…ì˜ˆê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
    return;
  }
  
  gameState.glory -= cost;
  gameState.guild.gloryInvested += cost;
  gameState.guild.level++;
  
  updateUI();
  showGuildPanel();
  saveGame();
  
  alert(`ê¸¸ë“œê°€ ë ˆë²¨ ${gameState.guild.level}ë¡œ ì—…ê·¸ë ˆì´ë“œë˜ì—ˆìŠµë‹ˆë‹¤!`);
  
  if (gameState.guild.level >= 5) {
    unlockAchievement('guildMaster');
  }
}

function closeGuildModal() {
  document.getElementById('guildModal').classList.remove('active');
}

// --- ì˜ì›… ìŠ¤íƒ¯ ê³„ì‚° ---
function getHeroStats(hero) {
  let stats = {
    hp: hero.hp,
    maxHp: hero.hp,
    atk: hero.atk,
    def: hero.def,
    spd: hero.spd,
    crit: 0,
    effects: []
  };
  
  // ì¥ë¹„ ë³´ë„ˆìŠ¤
  Object.values(hero.equipment).forEach(eq => {
    if (eq) {
      // ê¸°ë³¸ ìŠ¤íƒ¯
      Object.entries(eq.stats).forEach(([stat, value]) => {
        // ê°•í™” ë ˆë²¨ ì ìš©
        const enhanceBonus = 1 + (eq.enhanceLevel * 0.1);
        const finalValue = Math.floor(value * enhanceBonus);
        
        if (stat === 'hp') {
          stats.hp += finalValue;
          stats.maxHp += finalValue;
        } else if (stats[stat] !== undefined) {
          stats[stat] += finalValue;
        }
      });
      
      // íŠ¹ìˆ˜ íš¨ê³¼
      if (eq.effect) {
        stats.effects.push(eq.effect);
      }
    }
  });
  
  // ìŠ¤í‚¬ íŠ¸ë¦¬ ë³´ë„ˆìŠ¤
  if (SKILL_TREES[hero.class]) {
    [10, 20].forEach(level => {
      const path = hero.skillPath[level];
      if (path && SKILL_TREES[hero.class][level]?.[path]) {
        const bonus = SKILL_TREES[hero.class][level][path].bonus;
        Object.entries(bonus).forEach(([stat, value]) => {
          if (stat === 'hp') {
            const hpBonus = Math.floor(stats.hp * value);
            stats.hp += hpBonus;
            stats.maxHp += hpBonus;
          } else if (stat === 'crit') {
            stats.crit += value;
          } else if (stats[stat] !== undefined) {
            if (value < 1 && value > -1) {
              stats[stat] += Math.floor(stats[stat] * value);
            } else {
              stats[stat] += value;
            }
          }
        });
      }
    });
  }
  
  // ì§„í™” ë³´ë„ˆìŠ¤ (+30%)
  if (hero.evolved) {
    stats.hp = Math.floor(stats.hp * 1.3);
    stats.maxHp = Math.floor(stats.maxHp * 1.3);
    stats.atk = Math.floor(stats.atk * 1.3);
    stats.def = Math.floor(stats.def * 1.3);
    stats.spd = Math.floor(stats.spd * 1.3);
  }
  
  return stats;
}

// --- UI ì—…ë°ì´íŠ¸ ---
function updateUI() {
  document.getElementById('goldVal').textContent = gameState.gold;
  document.getElementById('gloryVal').textContent = gameState.glory;
  document.getElementById('seasonVal').textContent = gameState.season;
  document.getElementById('matchVal').textContent = `${gameState.matchesPlayed}/10`;

  document.getElementById('seasonInfo').textContent = gameState.season;
  document.getElementById('matchInfo').textContent = `${gameState.matchesPlayed}/10`;
  document.getElementById('winInfo').textContent = gameState.wins;
  document.getElementById('lossInfo').textContent = gameState.losses;
  document.getElementById('gloryInfo').textContent = gameState.glory;

  document.getElementById('nextSeasonBtn').disabled = gameState.matchesPlayed < 10;
  
  // í† ë„ˆë¨¼íŠ¸ ë²„íŠ¼
  const tournamentBtn = document.getElementById('tournamentBtn');
  if (gameState.tournament.enteredThisSeason) {
    tournamentBtn.disabled = true;
    tournamentBtn.textContent = 'ğŸ… í† ë„ˆë¨¼íŠ¸ (ì‚¬ìš©ë¨)';
  } else {
    tournamentBtn.disabled = false;
    tournamentBtn.textContent = 'ğŸ… í† ë„ˆë¨¼íŠ¸ (500ê³¨ë“œ)';
  }
  
  // ê¸¸ë“œ ë°°ì§€
  const guildBadge = document.getElementById('guildBadge');
  if (gameState.guild) {
    guildBadge.style.display = 'flex';
    document.getElementById('guildName').textContent = gameState.guild.name;
    document.getElementById('guildLevel').textContent = gameState.guild.level;
  } else {
    guildBadge.style.display = 'none';
  }
  
  // PvP ê¸°ë¡
  document.getElementById('p1Wins').textContent = gameState.pvp.p1Wins;
  document.getElementById('p2Wins').textContent = gameState.pvp.p2Wins;
  
  checkAchievements();
}

// --- ë¡œìŠ¤í„° ë Œë”ë§ ---
function renderRoster() {
  const grid = document.getElementById('rosterGrid');
  grid.innerHTML = '';
  
  gameState.roster.forEach(hero => {
    const card = createHeroCard(hero, () => {
      gameState.selectedHero = hero;
      openHeroModal(hero);
    });
    if (gameState.team.some(h => h.id === hero.id)) card.classList.add('selected');
    if (hero.evolved) card.classList.add('evolved');
    grid.appendChild(card);
  });
}

function renderTeam() {
  const grid = document.getElementById('teamGrid');
  grid.innerHTML = '';
  
  gameState.team.forEach(hero => {
    const card = createHeroCard(hero, () => {
      gameState.team = gameState.team.filter(h => h.id !== hero.id);
      renderRoster();
      renderTeam();
    });
    card.classList.add('selected');
    if (hero.evolved) card.classList.add('evolved');
    if (hero.isMercenary) card.classList.add('mercenary');
    grid.appendChild(card);
  });
}

function createHeroCard(hero, onClick) {
  const stats = getHeroStats(hero);
  const card = document.createElement('div');
  card.className = 'hero-card';
  card.onclick = onClick;
  
  const evolvedIcon = hero.evolved ? 'â­ ' : '';
  const mercIcon = hero.isMercenary ? '' : '';
  
  // ì¥ë¹„ ì•„ì´ì½˜ (ë“±ê¸‰ë³„ ìƒ‰ìƒ)
  let equipmentHTML = '<div class="equipment-icons">';
  ['weapon', 'armor', 'accessory'].forEach(slot => {
    const eq = hero.equipment[slot];
    if (eq) {
      const gradeClass = `eq-${eq.grade}`;
      const enhanceStr = eq.enhanceLevel > 0 ? `+${eq.enhanceLevel}` : '';
      equipmentHTML += `<span class="equipment-icon ${gradeClass}" title="${eq.name} ${enhanceStr}">${EQUIPMENT_TYPES[eq.type].icon}</span>`;
    }
  });
  equipmentHTML += '</div>';
  
  const className = hero.evolved ? `ì˜ì›… ${hero.class}` : hero.class;
  
  card.innerHTML = `
    <div class="hero-name">${mercIcon}${evolvedIcon}${hero.name}</div>
    <div class="hero-class">${hero.race} ${className}</div>
    <div class="hero-level">ë ˆë²¨ ${hero.level}/${hero.maxLevel}</div>
    ${equipmentHTML}
    <div class="hero-stats">
      HP: ${stats.maxHp} | ê³µê²©: ${Math.floor(stats.atk)}<br>
      ë°©ì–´: ${Math.floor(stats.def)} | ì†ë„: ${Math.floor(stats.spd)}<br>
      ${stats.crit > 0 ? `ì¹˜ëª…íƒ€: ${stats.crit}%<br>` : ''}
      ìŠ¤í‚¬: ${hero.skill}
      ${hero.ultimateSkill ? `<br>ê¶ê·¹ê¸°: ${hero.ultimateSkill.name}` : ''}
    </div>
  `;
  return card;
}

// --- ì˜ì›… ìƒì„¸ ëª¨ë‹¬ ---
function openHeroModal(hero) {
  const stats = getHeroStats(hero);
  const evolvedIcon = hero.evolved ? 'â­ ' : '';
  const className = hero.evolved ? `ì˜ì›… ${hero.class}` : hero.class;
  
  document.getElementById('modalHeroName').textContent = `${evolvedIcon}${hero.name} (ë ˆë²¨ ${hero.level})`;
  
  let effectsHTML = '';
  if (stats.effects.length > 0) {
    effectsHTML = `<p><strong>íš¨ê³¼:</strong> ${stats.effects.map(e => SPECIAL_EFFECTS[e]?.name || e).join(', ')}</p>`;
  }
  
  let detailsHTML = `
    <div style="font-size:14px; line-height:2; color:#d0e0f0;">
      <p><strong>í´ë˜ìŠ¤:</strong> ${hero.race} ${className}</p>
      <p><strong>HP:</strong> ${stats.maxHp} | <strong>ê³µê²©:</strong> ${Math.floor(stats.atk)}</p>
      <p><strong>ë°©ì–´:</strong> ${Math.floor(stats.def)} | <strong>ì†ë„:</strong> ${Math.floor(stats.spd)}</p>
      ${stats.crit > 0 ? `<p><strong>ì¹˜ëª…íƒ€:</strong> ${stats.crit}%</p>` : ''}
      <p><strong>ìŠ¤í‚¬:</strong> ${hero.skill}</p>
      ${hero.ultimateSkill ? `<p><strong>ê¶ê·¹ê¸°:</strong> ${hero.ultimateSkill.name} - ${hero.ultimateSkill.desc}</p>` : ''}
      ${effectsHTML}
    </div>
  `;
  
  document.getElementById('modalHeroDetails').innerHTML = detailsHTML;
  
  // ë²„íŠ¼ í‘œì‹œ
  document.getElementById('skillTreeBtn').style.display = hero.level >= 10 ? 'inline-block' : 'none';
  document.getElementById('evolveBtn').style.display = (hero.level >= 25 && !hero.evolved) ? 'inline-block' : 'none';
  
  document.getElementById('heroModal').classList.add('active');
}

function closeModal() {
  document.getElementById('heroModal').classList.remove('active');
  gameState.selectedHero = null;
}

// --- ì˜ì›… í›ˆë ¨ ---
function showTrainHero() {
  const hero = gameState.selectedHero;
  if (!hero) return;
  
  if (hero.level >= hero.maxLevel) {
    alert(`${hero.name}ì€(ëŠ”) ì´ë¯¸ ìµœëŒ€ ë ˆë²¨ì…ë‹ˆë‹¤!`);
    return;
  }
  
  let cost = 100 * hero.level;
  
  // ê¸¸ë“œ í• ì¸
  if (gameState.guild) {
    const discount = 0.2 * gameState.guild.level;
    cost = Math.floor(cost * (1 - discount));
  }
  
  if (gameState.gold < cost) {
    alert(`ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! ë¹„ìš©: ${cost}ê³¨ë“œ`);
    return;
  }
  
  if (confirm(`${hero.name}ì„(ë¥¼) ë ˆë²¨ ${hero.level + 1}ë¡œ í›ˆë ¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në¹„ìš©: ${cost}ê³¨ë“œ`)) {
    gameState.gold -= cost;
    hero.level++;
    
    hero.hp += 12;
    hero.maxHp = hero.hp;
    hero.atk += 2.5;
    hero.def += 1.2;
    hero.spd += 0.6;
    
    // ì• ë‹ˆë©”ì´ì…˜
    document.querySelector('.modal-content').classList.add('level-up-animation');
    setTimeout(() => document.querySelector('.modal-content').classList.remove('level-up-animation'), 500);
    
    updateUI();
    renderRoster();
    renderTeam();
    openHeroModal(hero);
    saveGame();
    
    playSound('levelup');
    
    if (hero.level > gameState.statistics.maxHeroLevel) {
      gameState.statistics.maxHeroLevel = hero.level;
    }
  }
}

// --- ìŠ¤í‚¬ íŠ¸ë¦¬ ---
function showSkillTree() {
  const hero = gameState.selectedHero;
  if (!hero || hero.level < 10) return;
  
  const tree = SKILL_TREES[hero.class];
  if (!tree) {
    alert('ì‚¬ìš© ê°€ëŠ¥í•œ ìŠ¤í‚¬ íŠ¸ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤!');
    return;
  }
  
  let html = '<div style="font-size:14px; color:#d0e0f0;">';
  html += '<h3 style="color:#f0c040; margin-bottom:15px; text-align:center;">ìŠ¤í‚¬ íŠ¸ë¦¬</h3>';
  
  [10, 20].forEach(level => {
    if (hero.level >= level && tree[level]) {
      html += `<h4 style="color:#a0b0c0; margin-top:20px;">ë ˆë²¨ ${level} ê²½ë¡œ:</h4>`;
      html += '<div class="skill-tree">';
      
      ['A', 'B'].forEach(path => {
        const skillData = tree[level][path];
        const selected = hero.skillPath[level] === path;
        const locked = hero.skillPath[level] && !selected;
        
        html += `<div class="skill-path ${selected ? 'selected' : ''} ${locked ? 'locked' : ''}" 
                      onclick="${!locked && !selected ? `selectSkillPath(${level}, '${path}')` : ''}">
          <strong>${skillData.name}</strong><br>
          <span style="font-size:12px;">${skillData.desc}</span>
          ${selected ? '<br><span style="color:#4ab58a;">âœ“ ì„ íƒë¨</span>' : ''}
        </div>`;
      });
      
      html += '</div>';
    }
  });
  
  html += '<p style="margin-top:20px; font-style:italic; font-size:12px; color:#8090a0;">ì„ íƒì€ ì˜êµ¬ì ì…ë‹ˆë‹¤!</p>';
  html += '</div>';
  
  document.getElementById('modalHeroDetails').innerHTML = html;
}

function selectSkillPath(level, path) {
  const hero = gameState.selectedHero;
  if (!hero || hero.skillPath[level]) return;
  
  const tree = SKILL_TREES[hero.class];
  const skillData = tree[level][path];
  
  if (confirm(`${skillData.name}ì„(ë¥¼) ì„ íƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n${skillData.desc}\n\nì´ê²ƒì€ ì˜êµ¬ì ì…ë‹ˆë‹¤!`)) {
    hero.skillPath[level] = path;
    renderRoster();
    renderTeam();
    showSkillTree();
    saveGame();
    playSound('skill');
    alert(`${hero.name}ì´(ê°€) ${skillData.name}ì„(ë¥¼) ìŠµë“í–ˆìŠµë‹ˆë‹¤!`);
  }
}

// --- ì˜ì›… ì§„í™” ---
function showEvolveHero() {
  const hero = gameState.selectedHero;
  if (!hero || hero.evolved || hero.level < 25) return;
  
  const cost = 1000;
  
  if (gameState.gold < cost) {
    alert(`ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! ë¹„ìš©: ${cost}ê³¨ë“œ`);
    return;
  }
  
  if (confirm(`${hero.name}ì„(ë¥¼) ì§„í™”ì‹œí‚¤ì‹œê² ìŠµë‹ˆê¹Œ?\n\në¹„ìš©: ${cost}ê³¨ë“œ\n\níš¨ê³¼:\n- ëª¨ë“  ëŠ¥ë ¥ì¹˜ +30%\n- ê¶ê·¹ê¸° ìŠ¤í‚¬ í•´ì œ`)) {
    gameState.gold -= cost;
    hero.evolved = true;
    hero.ultimateSkill = { ...ULTIMATE_SKILLS[hero.class] };
    
    document.querySelector('.modal-content').classList.add('evolve-animation');
    setTimeout(() => document.querySelector('.modal-content').classList.remove('evolve-animation'), 1000);
    
    updateUI();
    renderRoster();
    renderTeam();
    
    setTimeout(() => {
      openHeroModal(hero);
      playSound('evolve');
      alert(`${hero.name}ì´(ê°€) ì§„í™”í–ˆìŠµë‹ˆë‹¤!\n\nê¶ê·¹ê¸°: ${hero.ultimateSkill.name}`);
    }, 1000);
    
    saveGame();
  }
}

// --- ì˜ì›… ë§¤ê° ---
function showSellHero() {
  const hero = gameState.selectedHero;
  if (!hero) return;
  
  if (gameState.team.some(h => h.id === hero.id)) {
    alert('íŒ€ì— ìˆëŠ” ì˜ì›…ì€ ë§¤ê°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
    return;
  }
  
  const price = 50 * hero.level;
  
  if (confirm(`${hero.name}ì„(ë¥¼) ${price}ê³¨ë“œì— ë§¤ê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
    gameState.gold += price;
    gameState.roster = gameState.roster.filter(h => h.id !== hero.id);
    updateUI();
    renderRoster();
    closeModal();
    saveGame();
  }
}

// --- ì¥ë¹„ ê´€ë¦¬ ---
function showEquipmentManager() {
  const hero = gameState.selectedHero;
  if (!hero) return;
  
  let html = '<div style="font-size:14px; color:#d0e0f0;">';
  html += '<h3 style="color:#f0c040; margin-bottom:15px;">ì¥ì°© ì•„ì´í…œ</h3>';
  
  const slotNames = { weapon: 'ë¬´ê¸°', armor: 'ê°‘ì˜·', accessory: 'ì•…ì„¸ì„œë¦¬' };
  
  ['weapon', 'armor', 'accessory'].forEach(slot => {
    const eq = hero.equipment[slot];
    html += `<div class="equipment-slot ${eq ? '' : 'empty'}">`;
    html += `<strong>${slotNames[slot].toUpperCase()}:</strong> `;
    if (eq) {
      const gradeColor = EQUIPMENT_GRADES[eq.grade].color;
      const statsStr = Object.entries(eq.stats).map(([k, v]) => {
        const statNames = { atk: 'ê³µê²©', def: 'ë°©ì–´', hp: 'HP', spd: 'ì†ë„', crit: 'ì¹˜ëª…íƒ€' };
        return `${statNames[k] || k}+${v}`;
      }).join(', ');
      const effectStr = eq.effect ? ` [${SPECIAL_EFFECTS[eq.effect].name}]` : '';
      const enhanceStr = eq.enhanceLevel > 0 ? ` +${eq.enhanceLevel}` : '';
      
      html += `<span style="color:${gradeColor}">${eq.name}${enhanceStr}</span><br>`;
      html += `<span style="font-size:12px;">${statsStr}${effectStr}</span><br>`;
      html += `<button class="small danger" onclick="unequipItem('${slot}')">í•´ì œ</button> `;
      html += `<button class="small success" onclick="enhanceEquipment('${slot}')">ê°•í™” (${getEnhanceCost(eq)}ê³¨ë“œ)</button>`;
    } else {
      html += 'ë¹„ì–´ìˆìŒ';
    }
    html += '</div>';
  });
  
  html += '<h3 style="color:#f0c040; margin:20px 0 15px;">ì¸ë²¤í† ë¦¬</h3>';
  
  if (gameState.inventory.length === 0) {
    html += '<p style="opacity:0.7;">ë¹„ì–´ìˆìŒ</p>';
  } else {
    gameState.inventory.forEach(item => {
      const gradeColor = EQUIPMENT_GRADES[item.grade].color;
      const statsStr = Object.entries(item.stats).map(([k, v]) => {
        const statNames = { atk: 'ê³µê²©', def: 'ë°©ì–´', hp: 'HP', spd: 'ì†ë„', crit: 'ì¹˜ëª…íƒ€' };
        return `${statNames[k] || k}+${v}`;
      }).join(', ');
      const effectStr = item.effect ? ` [${SPECIAL_EFFECTS[item.effect].name}]` : '';
      
      html += `<div class="equipment-slot">`;
      html += `${EQUIPMENT_TYPES[item.type].icon} <span style="color:${gradeColor}"><strong>${item.name}</strong></span><br>`;
      html += `<span style="font-size:12px;">${statsStr}${effectStr}</span><br>`;
      html += `<button class="small success" onclick="equipItem(${item.id})">ì¥ì°©</button> `;
      html += `<button class="small" onclick="sellItem(${item.id})">íŒë§¤ (${item.price}ê³¨ë“œ)</button>`;
      html += '</div>';
    });
  }
  
  html += '</div>';
  document.getElementById('modalHeroDetails').innerHTML = html;
}

function getEnhanceCost(eq) {
  if (eq.enhanceLevel >= 5) return '(ìµœëŒ€)';
  const baseCost = 100 * (eq.enhanceLevel + 1);
  const gradeMultiplier = { common: 1, rare: 1.5, epic: 2, legendary: 3 };
  return Math.floor(baseCost * gradeMultiplier[eq.grade]);
}

function enhanceEquipment(slot) {
  const hero = gameState.selectedHero;
  if (!hero) return;
  
  const eq = hero.equipment[slot];
  if (!eq) return;
  
  if (eq.enhanceLevel >= 5) {
    alert('ì¥ë¹„ê°€ ì´ë¯¸ ìµœëŒ€ ê°•í™” ìƒíƒœì…ë‹ˆë‹¤!');
    return;
  }
  
  const cost = getEnhanceCost(eq);
  if (typeof cost === 'string') return;
  
  if (gameState.gold < cost) {
    alert('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
    return;
  }
  
  if (confirm(`${eq.name}ì„(ë¥¼) +${eq.enhanceLevel + 1}ë¡œ ê°•í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në¹„ìš©: ${cost}ê³¨ë“œ\n\nëª¨ë“  ëŠ¥ë ¥ì¹˜ +10%`)) {
    gameState.gold -= cost;
    eq.enhanceLevel++;
    
    updateUI();
    showEquipmentManager();
    saveGame();
    playSound('enhance');
  }
}

function equipItem(itemId) {
  const hero = gameState.selectedHero;
  if (!hero) return;
  
  const item = gameState.inventory.find(i => i.id === itemId);
  if (!item) return;
  
  const slotMap = { ë¬´ê¸°: 'weapon', ê°‘ì˜·: 'armor', ì•…ì„¸ì„œë¦¬: 'accessory' };
  const slot = slotMap[item.type];
  
  if (hero.equipment[slot]) {
    gameState.inventory.push(hero.equipment[slot]);
  }
  
  hero.equipment[slot] = item;
  gameState.inventory = gameState.inventory.filter(i => i.id !== itemId);
  
  renderRoster();
  renderTeam();
  showEquipmentManager();
  saveGame();
}

function unequipItem(slot) {
  const hero = gameState.selectedHero;
  if (!hero || !hero.equipment[slot]) return;
  
  gameState.inventory.push(hero.equipment[slot]);
  hero.equipment[slot] = null;
  
  renderRoster();
  renderTeam();
  showEquipmentManager();
  saveGame();
}

function sellItem(itemId) {
  const item = gameState.inventory.find(i => i.id === itemId);
  if (!item) return;
  
  if (confirm(`${item.name}ì„(ë¥¼) ${item.price}ê³¨ë“œì— íŒë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
    gameState.gold += item.price;
    gameState.inventory = gameState.inventory.filter(i => i.id !== itemId);
    updateUI();
    showEquipmentManager();
    saveGame();
  }
}

// --- íƒ­ ì „í™˜ ---
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  
  // í´ë¦­ëœ íƒ­ ì°¾ê¸°
  const clickedTab = Array.from(document.querySelectorAll('.tab')).find(t => 
    t.getAttribute('onclick').includes(tab)
  );
  if (clickedTab) clickedTab.classList.add('active');
  
  document.getElementById(tab).classList.add('active');
  
  if (tab === 'achievements') renderAchievements();
  if (tab === 'stats') updateStatistics();
  if (tab === 'pvp') renderPvPRosters();
}

// --- Market ---
function showMarket() {
  const cost = 200;
  if (gameState.gold < cost) {
    alert('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
    return;
  }
  if (gameState.roster.length >= 15) {
    alert('ë¡œìŠ¤í„°ê°€ ê½‰ ì°¼ìŠµë‹ˆë‹¤! (ìµœëŒ€ 15)');
    return;
  }
  
  gameState.gold -= cost;
  const newHero = generateHero(1);
  gameState.roster.push(newHero);
  gameState.statistics.heroesRecruited++;
  
  updateUI();
  renderRoster();
  saveGame();
  alert(`${newHero.name}ì„(ë¥¼) ëª¨ì§‘í–ˆìŠµë‹ˆë‹¤!`);
}

function autoSelectTeam() {
  const sorted = [...gameState.roster].sort((a, b) => {
    const sA = getHeroStats(a), sB = getHeroStats(b);
    const pA = sA.atk + sA.def + sA.maxHp / 10;
    const pB = sB.atk + sB.def + sB.maxHp / 10;
    return pB - pA;
  });
  gameState.team = sorted.slice(0, 5);
  renderRoster();
  renderTeam();
}

// --- Formation ì„ íƒ ---
function selectFormation(formation) {
  gameState.formation = formation;
  document.querySelectorAll('.formation-option').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.formation === formation);
  });
}

// --- AI íŒ€ ìƒì„± ---
function generateEnemyTeam(level, type = 'balanced') {
  const team = [];
  const enemyName = AI_TEAM_NAMES[Math.floor(Math.random() * AI_TEAM_NAMES.length)];
  
  let classDistribution = [];
  switch(type) {
    case 'aggressive': classDistribution = ['ì „ì‚¬', 'ì „ì‚¬', 'ë§ˆë²•ì‚¬', 'ë§ˆë²•ì‚¬', 'ê¶ìˆ˜']; break;
    case 'defensive': classDistribution = ['íƒ±ì»¤', 'íƒ±ì»¤', 'ì‚¬ì œ', 'ì‚¬ì œ', 'ì „ì‚¬']; break;
    default: classDistribution = ['ì „ì‚¬', 'ë§ˆë²•ì‚¬', 'ê¶ìˆ˜', 'ì‚¬ì œ', 'íƒ±ì»¤'];
  }
  
  // New Game+ ë‚œì´ë„ ì¦ê°€
  const ngPlusMultiplier = 1 + (gameState.ngPlusLevel * 0.5);
  
  classDistribution.forEach((cls, i) => {
    const hero = generateHero(level);
    hero.class = cls;
    hero.skill = CLASSES[cls].skill;
    hero.name = `${enemyName} ${i + 1}`;
    
    // NG+ ìŠ¤íƒ¯ ì¦ê°€
    if (gameState.ngPlusLevel > 0) {
      hero.hp = Math.floor(hero.hp * ngPlusMultiplier);
      hero.atk = Math.floor(hero.atk * ngPlusMultiplier);
      hero.def = Math.floor(hero.def * ngPlusMultiplier);
    }
    
    // ë†’ì€ ì‹œì¦Œì—ëŠ” ì ë„ ì¥ë¹„/ì§„í™”
    if (gameState.season >= 5 && Math.random() < 0.3) {
      hero.equipment.weapon = generateEquipment('rare');
    }
    if (gameState.season >= 10 && Math.random() < 0.2) {
      hero.equipment.armor = generateEquipment('rare');
    }
    if (gameState.season >= 15 && level >= 25 && Math.random() < 0.15) {
      hero.evolved = true;
      hero.ultimateSkill = { ...ULTIMATE_SKILLS[cls] };
    }
    
    team.push(hero);
  });
  
  // ì  ëŒ€í˜• ê²°ì •
  const enemyFormations = ['offensive', 'balanced', 'defensive'];
  const enemyFormation = enemyFormations[Math.floor(Math.random() * enemyFormations.length)];
  
  return { name: enemyName, team, formation: enemyFormation };
}

// --- ì „íˆ¬ ì‹œì‘ ---
function startBattle() {
  if (gameState.team.length !== 5) {
    alert('ì˜ì›… 5ëª…ì„ ì„ íƒí•˜ì„¸ìš”!');
    return;
  }
  if (gameState.matchesPlayed >= 10) {
    alert('ì‹œì¦Œ ì™„ë£Œ! ë¦¬ê·¸ì—ì„œ ë‹¤ìŒ ì‹œì¦Œìœ¼ë¡œ ì§„í–‰í•˜ì„¸ìš”.');
    return;
  }

  const isBoss = (gameState.matchesPlayed + 1) % 5 === 0;
  
  const teamTypes = ['balanced', 'aggressive', 'defensive'];
  const teamType = teamTypes[Math.floor(Math.random() * teamTypes.length)];
  
  const enemyLevel = gameState.season + Math.floor(gameState.matchesPlayed / 2);
  const enemyData = generateEnemyTeam(enemyLevel, teamType);
  gameState.enemyTeam = enemyData.team;
  
  // ë³´ìŠ¤ì „: HP/ATK 2ë°°
  if (isBoss) {
    gameState.enemyTeam.forEach(enemy => {
      enemy.hp *= 2;
      enemy.maxHp = enemy.hp;
      enemy.atk *= 2;
      enemy.name = 'ğŸ‘‘ ' + enemy.name;
    });
  }

  initBattleState();
  
  // ëŒ€í˜• ë³´ë„ˆìŠ¤ ë¡œê·¸
  const formationNames = { offensive: 'ê³µê²©í˜•', balanced: 'ê· í˜•í˜•', defensive: 'ìˆ˜ë¹„í˜•' };
  logBattle(`ğŸ“ ì•„êµ° ëŒ€í˜•: ${formationNames[gameState.formation].toUpperCase()}`, 'formation');
  logBattle(`ğŸ“ ì êµ° ëŒ€í˜•: ${formationNames[enemyData.formation].toUpperCase()}`, 'formation');
  logBattle(isBoss ? '=== âš ï¸ ë³´ìŠ¤ ì „íˆ¬! âš ï¸ ===' : `=== ${enemyData.name}ì™€(ê³¼)ì˜ ì „íˆ¬ ===`);
  
  battleState.isPvP = false;
  battleState.isTournament = false;
  battleState.enemyFormation = enemyData.formation;
}

function initBattleState() {
  battleState.effects = {};
  battleState.turnCount = 0;
  
  // ëŒ€í˜• ë³´ë„ˆìŠ¤ ì ìš©
  const formations = {
    offensive: { atk: 1.10, def: 0.95 },
    balanced: { atk: 1.0, def: 1.0 },
    defensive: { atk: 0.95, def: 1.10 }
  };
  
  const playerFormation = formations[gameState.formation];
  const enemyFormation = formations[battleState.enemyFormation || 'balanced'];
  
  gameState.team.forEach(hero => {
    const stats = getHeroStats(hero);
    hero.currentHp = stats.hp;
    hero.currentMaxHp = stats.maxHp;
    hero.currentAtk = Math.floor(stats.atk * playerFormation.atk);
    hero.currentDef = Math.floor(stats.def * playerFormation.def);
    hero.currentSpd = stats.spd;
    hero.crit = stats.crit;
    hero.effects = stats.effects;
    hero.ultimateCounter = 0;
    hero.phoenixUsed = false;
    battleState.effects[hero.id] = [];
  });
  
  gameState.enemyTeam.forEach(hero => {
    const stats = getHeroStats(hero);
    hero.currentHp = stats.hp || hero.hp;
    hero.currentMaxHp = stats.maxHp || hero.hp;
    hero.currentAtk = Math.floor((stats.atk || hero.atk) * enemyFormation.atk);
    hero.currentDef = Math.floor((stats.def || hero.def) * enemyFormation.def);
    hero.currentSpd = stats.spd || hero.spd;
    hero.crit = stats.crit || 0;
    hero.effects = stats.effects || [];
    hero.ultimateCounter = 0;
    hero.phoenixUsed = false;
    battleState.effects[hero.id] = [];
  });

  renderBattleUI();
  document.getElementById('startBattleBtn').style.display = 'none';
  document.getElementById('autoBattleBtn').style.display = 'inline-block';
  document.getElementById('formationSelect').style.display = 'none';
  gameState.battleInProgress = true;
  
  document.getElementById('battleLog').innerHTML = '';
}

function renderBattleUI() {
  const yourSide = document.getElementById('yourTeamBattle');
  const enemySide = document.getElementById('enemyTeamBattle');
  yourSide.innerHTML = '';
  enemySide.innerHTML = '';

  gameState.team.forEach(hero => yourSide.appendChild(createBattleHeroCard(hero)));
  gameState.enemyTeam.forEach(hero => enemySide.appendChild(createBattleHeroCard(hero)));
}

function createBattleHeroCard(hero) {
  const card = document.createElement('div');
  card.className = 'battle-hero';
  card.id = `hero-${hero.id}`;
  const evolvedIcon = hero.evolved ? 'â­ ' : '';
  card.innerHTML = `
    <div><strong>${evolvedIcon}${hero.name}</strong> (${hero.class})</div>
    <div style="font-size:11px; color:#a0b0c0;">
      HP: <span id="hp-${hero.id}">${Math.floor(hero.currentHp)}</span>/${hero.currentMaxHp}
    </div>
    <div class="hp-bar"><div class="hp-fill" id="hpbar-${hero.id}" style="width:100%;"></div></div>
    <div class="status-effects" id="status-${hero.id}"></div>
  `;
  return card;
}

function updateHpDisplay(hero) {
  const hpSpan = document.getElementById(`hp-${hero.id}`);
  const hpBar = document.getElementById(`hpbar-${hero.id}`);
  if (hpSpan) hpSpan.textContent = Math.max(0, Math.floor(hero.currentHp));
  if (hpBar) {
    const pct = Math.max(0, (hero.currentHp / hero.currentMaxHp) * 100);
    hpBar.style.width = pct + '%';
    hpBar.style.background = pct < 30 ? 'linear-gradient(90deg, #aa4a4a 0%, #cc6a6a 100%)' : '';
  }
  const card = document.getElementById(`hero-${hero.id}`);
  if (card && hero.currentHp <= 0) card.classList.add('dead');
}

function updateStatusDisplay(hero) {
  const statusDiv = document.getElementById(`status-${hero.id}`);
  if (!statusDiv) return;
  
  const effects = battleState.effects[hero.id] || [];
  statusDiv.innerHTML = effects.map(effect => {
    let icon = '';
    switch(effect.type) {
      case 'poison': icon = 'ğŸŸ¢'; break;
      case 'stun': icon = 'ğŸ’«'; break;
      case 'provoke': icon = 'ğŸ¯'; break;
      case 'defBuff': icon = 'ğŸ›¡ï¸'; break;
      case 'freeze': icon = 'â„ï¸'; break;
      case 'immunity': icon = 'âœ¨'; break;
    }
    return `<span class="status-icon" title="${effect.type} (${effect.duration})">${icon}</span>`;
  }).join('');
}

function logBattle(msg, type = '') {
  const log = document.getElementById('battleLog');
  const entry = document.createElement('div');
  entry.className = 'log-entry ' + type;
  entry.textContent = msg;
  log.appendChild(entry);
  log.scrollTop = log.scrollHeight;
}

// --- ì „íˆ¬ ì‹œìŠ¤í…œ ---
function autoBattle() {
  if (!gameState.battleInProgress) return;

  battleState.turnCount++;
  processStatusEffects();

  // SPD ìˆœì„œëŒ€ë¡œ í–‰ë™
  const allHeroes = [...gameState.team, ...gameState.enemyTeam].filter(h => h.currentHp > 0);
  allHeroes.sort((a, b) => b.currentSpd - a.currentSpd);

  for (const hero of allHeroes) {
    if (hero.currentHp <= 0) continue;

    const stunned = battleState.effects[hero.id]?.some(e => e.type === 'stun' || e.type === 'freeze');
    if (stunned) {
      logBattle(`${hero.name}ì€(ëŠ”) ê¸°ì ˆí–ˆìŠµë‹ˆë‹¤!`, 'attack');
      continue;
    }

    const isPlayer = gameState.team.includes(hero);
    let targets = isPlayer ? 
      gameState.enemyTeam.filter(h => h.currentHp > 0) : 
      gameState.team.filter(h => h.currentHp > 0);

    if (targets.length === 0) break;

    // AI ê°œì„ : íëŸ¬ ìš°ì„  íƒ€ê²Ÿ
    if (!isPlayer) {
      targets.sort((a, b) => {
        // íëŸ¬ ìš°ì„ 
        if (a.class === 'ì‚¬ì œ' && b.class !== 'ì‚¬ì œ') return -1;
        if (b.class === 'ì‚¬ì œ' && a.class !== 'ì‚¬ì œ') return 1;
        // ê·¸ ë‹¤ìŒ HP ë‚®ì€ ìˆœ
        return (a.currentHp / a.currentMaxHp) - (b.currentHp / b.currentMaxHp);
      });
    }

    // Provoke ì²´í¬
    const provokeTarget = targets.find(t => battleState.effects[t.id]?.some(e => e.type === 'provoke'));
    if (provokeTarget && !isPlayer) targets = [provokeTarget];

    // ê¶ê·¹ê¸° ì²´í¬
    if (hero.ultimateSkill && hero.ultimateCounter >= 5) {
      executeUltimate(hero, targets, isPlayer);
      hero.ultimateCounter = 0;
    } else {
      const useSkill = Math.random() < 0.4;
      if (useSkill) {
        executeSkill(hero, targets, isPlayer);
      } else {
        executeBasicAttack(hero, targets[0], isPlayer);
      }
    }

    if (hero.ultimateSkill) hero.ultimateCounter++;
    if (checkBattleEnd()) return;
  }

  const delay = 800 / gameState.settings.battleSpeed;
  setTimeout(autoBattle, delay);
}

function executeBasicAttack(attacker, target, isPlayer) {
  let dmg = Math.max(1, attacker.currentAtk - target.currentDef / 2);
  
  // Berserk íš¨ê³¼
  if (attacker.effects?.includes('berserk') && attacker.currentHp < attacker.currentMaxHp * 0.5) {
    dmg *= 1.3;
  }
  
  // í¬ë¦¬í‹°ì»¬
  let isCrit = false;
  if (attacker.crit && Math.random() * 100 < attacker.crit) {
    dmg *= 2;
    isCrit = true;
  }
  
  // Guardian íš¨ê³¼ (í”¼í•´ ê°ì†Œ)
  if (target.effects?.includes('guardian')) {
    dmg *= 0.85;
  }
  
  // Immunity ì²´í¬
  if (battleState.effects[target.id]?.some(e => e.type === 'immunity')) {
    logBattle(`${target.name}ì€(ëŠ”) ë¬´ì ì…ë‹ˆë‹¤!`, 'skill');
    return;
  }
  
  target.currentHp -= dmg;
  logBattle(`${attacker.name}ì´(ê°€) ${target.name}ì—ê²Œ ${Math.floor(dmg)} í”¼í•´${isCrit ? ' (ì¹˜ëª…íƒ€!)' : ''}`, 'attack');
  
  // Vampire íš¨ê³¼
  if (attacker.effects?.includes('vampire')) {
    const heal = Math.floor(dmg * 0.2);
    attacker.currentHp = Math.min(attacker.currentMaxHp, attacker.currentHp + heal);
    logBattle(`  â†’ ${attacker.name}ì´(ê°€) ${heal} HP ì¹˜ìœ  (í¡í˜ˆ)`, 'special');
    updateHpDisplay(attacker);
  }
  
  // Lightning íš¨ê³¼
  if (attacker.effects?.includes('lightning')) {
    const others = (isPlayer ? gameState.enemyTeam : gameState.team)
      .filter(h => h.currentHp > 0 && h.id !== target.id);
    if (others.length > 0) {
      const chainDmg = Math.floor(dmg * 0.3);
      const chainTarget = others[0];
      chainTarget.currentHp -= chainDmg;
      logBattle(`  â†’ âš¡ ì—°ì‡„ ë²ˆê°œê°€ ${chainTarget.name}ì—ê²Œ ${chainDmg} í”¼í•´!`, 'special');
      updateHpDisplay(chainTarget);
    }
  }
  
  // Frost íš¨ê³¼ (30% ë¹™ê²°)
  if (attacker.effects?.includes('frost') && Math.random() < 0.3) {
    addEffect(target.id, 'freeze', 1);
    logBattle(`  â†’ â„ï¸ ${target.name}ì´(ê°€) ì–¼ì–´ë¶™ì—ˆìŠµë‹ˆë‹¤!`, 'special');
    updateStatusDisplay(target);
  }
  
  updateHpDisplay(target);
  
  // Phoenix íš¨ê³¼ (ì‚¬ë§ ì‹œ ë¶€í™œ)
  checkPhoenix(target);
}

function checkPhoenix(hero) {
  if (hero.currentHp <= 0 && hero.effects?.includes('phoenix') && !hero.phoenixUsed) {
    hero.currentHp = Math.floor(hero.currentMaxHp * 0.5);
    hero.phoenixUsed = true;
    logBattle(`ğŸ”¥ ${hero.name}ì´(ê°€) ë¶ˆì‚¬ì¡°ë¡œ ë¶€í™œí–ˆìŠµë‹ˆë‹¤!`, 'special');
    updateHpDisplay(hero);
    const card = document.getElementById(`hero-${hero.id}`);
    if (card) card.classList.remove('dead');
  }
}

function executeSkill(hero, targets, isPlayer) {
  const skill = hero.skill;
  logBattle(`âš¡ ${hero.name}ì´(ê°€) ${skill}ì„(ë¥¼) ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤!`, 'skill');
  
  switch(skill) {
    case 'ë°©íŒ¨ ê°•íƒ€': {
      const target = targets[0];
      let dmg = Math.max(1, hero.currentAtk * 1.2 - target.currentDef * 0.3);
      target.currentHp -= dmg;
      logBattle(`  â†’ ${target.name}ì´(ê°€) ${Math.floor(dmg)} í”¼í•´!`, 'skill');
      updateHpDisplay(target);
      checkPhoenix(target);
      if (Math.random() < 0.3) {
        addEffect(target.id, 'stun', 1);
        logBattle(`  â†’ ${target.name}ì´(ê°€) ê¸°ì ˆí–ˆìŠµë‹ˆë‹¤!`, 'skill');
        updateStatusDisplay(target);
      }
      break;
    }
    
    case 'í™”ì—¼êµ¬': {
      let dmg = hero.currentAtk * 0.8;
      if (hero.skillPath[10] === 'A' || hero.skillPath[20] === 'A') dmg *= 1.5;
      
      const hitCount = (hero.skillPath[10] === 'A' || hero.skillPath[20] === 'A') ? 3 : 2;
      targets.slice(0, hitCount).forEach(t => {
        t.currentHp -= dmg;
        logBattle(`  â†’ ${t.name}ì´(ê°€) ${Math.floor(dmg)} í™”ì—¼ í”¼í•´!`, 'skill');
        updateHpDisplay(t);
        checkPhoenix(t);
      });
      break;
    }
    
    case 'ë…í™”ì‚´': {
      const target = targets[0];
      let dmg = hero.currentAtk * 0.7;
      const poisonBonus = (hero.skillPath[10] === 'A' || hero.skillPath[20] === 'A') ? 1.5 : 1.0;
      
      target.currentHp -= dmg;
      logBattle(`  â†’ ${target.name}ì´(ê°€) ${Math.floor(dmg)} í”¼í•´!`, 'skill');
      updateHpDisplay(target);
      checkPhoenix(target);
      
      addEffect(target.id, 'poison', 3, hero.currentAtk * 0.3 * poisonBonus);
      logBattle(`  â†’ ${target.name}ì´(ê°€) ì¤‘ë…ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'skill');
      updateStatusDisplay(target);
      break;
    }
    
    case 'ì¹˜ìœ ': {
      const allies = isPlayer ? gameState.team.filter(h => h.currentHp > 0) : gameState.enemyTeam.filter(h => h.currentHp > 0);
      if (allies.length === 0) break;
      
      let healAmount = hero.currentAtk * 1.5;
      if (hero.skillPath[10] === 'A' || hero.skillPath[20] === 'A') {
        healAmount *= 1.5;
        allies.slice(0, 3).forEach(ally => {
          ally.currentHp = Math.min(ally.currentMaxHp, ally.currentHp + healAmount);
          logBattle(`  â†’ ${ally.name}ì´(ê°€) ${Math.floor(healAmount)} ì¹˜ìœ !`, 'heal');
          updateHpDisplay(ally);
        });
      } else {
        const target = allies.reduce((min, h) => h.currentHp < min.currentHp ? h : min);
        target.currentHp = Math.min(target.currentMaxHp, target.currentHp + healAmount);
        logBattle(`  â†’ ${target.name}ì´(ê°€) ${Math.floor(healAmount)} ì¹˜ìœ !`, 'heal');
        updateHpDisplay(target);
      }
      break;
    }
    
    case 'ë„ë°œ': {
      addEffect(hero.id, 'provoke', 2);
      addEffect(hero.id, 'defBuff', 2, hero.currentDef * 0.5);
      hero.currentDef += hero.currentDef * 0.5;
      logBattle(`  â†’ ${hero.name}ì´(ê°€) ë„ë°œí•˜ê³  ë°©ì–´ë ¥ ìƒìŠ¹!`, 'skill');
      updateStatusDisplay(hero);
      break;
    }
  }
}


function executeUltimate(hero, targets, isPlayer) {
  const ultimate = hero.ultimateSkill;
  logBattle(`ğŸŒŸ ${hero.name}: ${ultimate.name}! ğŸŒŸ`, 'ultimate');
  playSound('ultimate');
  
  switch(hero.class) {
    case 'ì „ì‚¬': {
      const dmg = hero.currentAtk * 2.5;
      targets.forEach(target => {
        target.currentHp -= dmg;
        logBattle(`  ğŸ’¥ ${target.name}ì´(ê°€) ${Math.floor(dmg)} í”¼í•´!`, 'ultimate');
        updateHpDisplay(target);
        checkPhoenix(target);
      });
      break;
    }
    
    case 'ë§ˆë²•ì‚¬': {
      const dmg = hero.currentAtk * 1.2;
      for (let i = 0; i < 3; i++) {
        const target = targets[i % targets.length];
        target.currentHp -= dmg;
        logBattle(`  ğŸ’¥ ë©”í…Œì˜¤ê°€ ${target.name}ì—ê²Œ ${Math.floor(dmg)} í”¼í•´!`, 'ultimate');
        updateHpDisplay(target);
        checkPhoenix(target);
      }
      break;
    }
    
    case 'ê¶ìˆ˜': {
      const target = targets.reduce((min, h) => h.currentHp < min.currentHp ? h : min);
      if (target.currentHp < target.currentMaxHp * 0.3) {
        target.currentHp = 0;
        logBattle(`  ğŸ’€ ${target.name}ì´(ê°€) ì¦‰ì‚¬í–ˆìŠµë‹ˆë‹¤!`, 'ultimate');
      } else {
        const dmg = hero.currentAtk * 3;
        target.currentHp -= dmg;
        logBattle(`  ğŸ¯ ${target.name}ì´(ê°€) ${Math.floor(dmg)} í”¼í•´!`, 'ultimate');
      }
      updateHpDisplay(target);
      checkPhoenix(target);
      break;
    }
    
    case 'ì‚¬ì œ': {
      const allies = isPlayer ? gameState.team.filter(h => h.currentHp > 0) : gameState.enemyTeam.filter(h => h.currentHp > 0);
      const healAmount = hero.currentAtk * 2;
      allies.forEach(ally => {
        ally.currentHp = Math.min(ally.currentMaxHp, ally.currentHp + healAmount);
        logBattle(`  âœ¨ ${ally.name}ì´(ê°€) ${Math.floor(healAmount)} ì¹˜ìœ !`, 'ultimate');
        updateHpDisplay(ally);
      });
      break;
    }
    
    case 'íƒ±ì»¤': {
      addEffect(hero.id, 'immunity', 2);
      logBattle(`  ğŸ›¡ï¸ ${hero.name}ì´(ê°€) ë¬´ì  ìƒíƒœ!`, 'ultimate');
      updateStatusDisplay(hero);
      break;
    }
  }
}

// --- ìƒíƒœ íš¨ê³¼ ì‹œìŠ¤í…œ ---
function addEffect(heroId, type, duration, value = 0) {
  if (!battleState.effects[heroId]) battleState.effects[heroId] = [];
  battleState.effects[heroId].push({ type, duration, value });
}

function processStatusEffects() {
  [...gameState.team, ...gameState.enemyTeam].forEach(hero => {
    if (hero.currentHp <= 0) return;
    
    const effects = battleState.effects[hero.id] || [];
    
    effects.forEach(effect => {
      if (effect.type === 'poison' && effect.duration > 0) {
        hero.currentHp -= effect.value;
        logBattle(`${hero.name}ì´(ê°€) ë… í”¼í•´ ${Math.floor(effect.value)}!`, 'special');
        updateHpDisplay(hero);
        checkPhoenix(hero);
      }
    });
    
    battleState.effects[hero.id] = effects
      .map(e => ({ ...e, duration: e.duration - 1 }))
      .filter(e => e.duration > 0);
    
    updateStatusDisplay(hero);
  });
}

function checkBattleEnd() {
  const playerAlive = gameState.team.some(h => h.currentHp > 0);
  const enemyAlive = gameState.enemyTeam.some(h => h.currentHp > 0);
  
  if (!playerAlive || !enemyAlive) {
    gameState.battleInProgress = false;
    document.getElementById('startBattleBtn').style.display = 'inline-block';
    document.getElementById('autoBattleBtn').style.display = 'none';
    document.getElementById('formationSelect').style.display = 'flex';
    
    // ìš©ë³‘ ì œê±°
    gameState.team = gameState.team.filter(h => !h.isMercenary);
    renderTeam();
    
    if (playerAlive) {
      handleVictory();
    } else {
      handleDefeat();
    }
    return true;
  }
  return false;
}

function handleVictory() {
  logBattle('=== ğŸ‰ ìŠ¹ë¦¬! ğŸ‰ ===', 'skill');
  playSound('victory');
  
  gameState.wins++;
  gameState.matchesPlayed++;
  gameState.statistics.totalWins++;
  gameState.statistics.totalBattles++;
  gameState.statistics.currentWinStreak++;
  
  if (gameState.statistics.currentWinStreak > gameState.statistics.bestWinStreak) {
    gameState.statistics.bestWinStreak = gameState.statistics.currentWinStreak;
  }
  
  // ë³´ìƒ
  let goldReward = 100 + gameState.season * 20;
  let gloryReward = 10 + gameState.season * 2;
  
  // ê¸¸ë“œ ë³´ë„ˆìŠ¤
  if (gameState.guild) {
    const bonus = 0.1 * gameState.guild.level;
    goldReward = Math.floor(goldReward * (1 + bonus));
  }
  
  // í† ë„ˆë¨¼íŠ¸ ë³´ë„ˆìŠ¤
  if (battleState.isTournament) {
    goldReward *= 2;
    gloryReward *= 2;
  }
  
  // PvPëŠ” ë³´ìƒ ì—†ìŒ
  if (!battleState.isPvP) {
    gameState.gold += goldReward;
    gameState.glory += gloryReward;
    gameState.statistics.totalGoldEarned += goldReward;
    
    logBattle(`ë³´ìƒ: ${goldReward}ê³¨ë“œ, ${gloryReward}ëª…ì˜ˆ`, 'heal');
    
    // ì¥ë¹„ ë“œë¡­ (30% í™•ë¥ )
    if (Math.random() < 0.3) {
      const newEq = generateEquipment();
      gameState.inventory.push(newEq);
      const gradeColor = EQUIPMENT_GRADES[newEq.grade].color;
      logBattle(`âš”ï¸ ì¥ë¹„ íšë“: ${newEq.name}!`, 'special');
      
      if (newEq.grade === 'legendary') {
        gameState.statistics.legendaryItemsFound++;
      }
    }
  }
  
  // PvP ìŠ¹ë¦¬ ì²˜ë¦¬
  if (battleState.isPvP) {
    if (battleState.isPvPPlayer1) {
      gameState.pvp.p1Wins++;
    } else {
      gameState.pvp.p2Wins++;
    }
    
    if (gameState.pvp.p1Wins + gameState.pvp.p2Wins >= 10) {
      unlockAchievement('pvpChampion');
    }
  }
  
  // í† ë„ˆë¨¼íŠ¸ ì§„í–‰
  if (battleState.isTournament) {
    advanceTournament(true);
  }
  
  updateUI();
  saveGame();
  checkStoryProgress();
}

function handleDefeat() {
  logBattle('=== ğŸ’€ íŒ¨ë°°... ===', 'attack');
  playSound('defeat');
  
  gameState.losses++;
  gameState.matchesPlayed++;
  gameState.statistics.totalBattles++;
  gameState.statistics.currentWinStreak = 0;
  
  // PvP íŒ¨ë°°
  if (battleState.isPvP) {
    if (battleState.isPvPPlayer1) {
      gameState.pvp.p2Wins++;
    } else {
      gameState.pvp.p1Wins++;
    }
  }
  
  // í† ë„ˆë¨¼íŠ¸ íŒ¨ë°°
  if (battleState.isTournament) {
    advanceTournament(false);
  }
  
  updateUI();
  saveGame();
}

// --- ì‹œì¦Œ ê´€ë¦¬ ---
function nextSeason() {
  if (gameState.matchesPlayed < 10) {
    alert('ì‹œì¦Œì„ ì™„ë£Œí•˜ë ¤ë©´ 10ê²½ê¸°ë¥¼ ëª¨ë‘ í”Œë ˆì´í•´ì•¼ í•©ë‹ˆë‹¤!');
    return;
  }
  
  if (gameState.wins === 10) {
    unlockAchievement('perfectSeason');
  }
  
  gameState.season++;
  gameState.matchesPlayed = 0;
  gameState.wins = 0;
  gameState.losses = 0;
  gameState.tournament.enteredThisSeason = false;
  
  if (gameState.season > gameState.statistics.highestSeason) {
    gameState.statistics.highestSeason = gameState.season;
  }
  
  // ì‹œì¦Œ 20 í´ë¦¬ì–´ ì²´í¬
  if (gameState.season > 20) {
    showEnding();
  }
  
  updateUI();
  saveGame();
  checkStoryProgress();
  
  alert(`ì‹œì¦Œ ${gameState.season} ì‹œì‘!`);
}

// --- í† ë„ˆë¨¼íŠ¸ ì‹œìŠ¤í…œ ---
function showTournament() {
  if (gameState.tournament.enteredThisSeason) {
    alert('ì´ë²ˆ ì‹œì¦Œì— ì´ë¯¸ í† ë„ˆë¨¼íŠ¸ì— ì°¸ê°€í–ˆìŠµë‹ˆë‹¤!');
    return;
  }
  
  if (gameState.gold < 500) {
    alert('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! 500ê³¨ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }
  
  if (gameState.team.length !== 5) {
    alert('ì˜ì›… 5ëª…ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!');
    return;
  }
  
  if (confirm('í† ë„ˆë¨¼íŠ¸ì— ì°¸ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në¹„ìš©: 500ê³¨ë“œ\n\n8ê°• í† ë„ˆë¨¼íŠ¸\nìš°ìŠ¹ ì‹œ ë§‰ëŒ€í•œ ë³´ìƒ!')) {
    gameState.gold -= 500;
    startTournament();
  }
}

function startTournament() {
  gameState.tournament.active = true;
  gameState.tournament.enteredThisSeason = true;
  gameState.tournament.round = 0;
  
  // 8íŒ€ ìƒì„±
  const teams = [];
  for (let i = 0; i < 7; i++) {
    const level = gameState.season + 2;
    teams.push(generateEnemyTeam(level));
  }
  
  gameState.tournament.bracket = teams;
  
  updateUI();
  saveGame();
  
  document.getElementById('tournamentContent').innerHTML = `
    <h3 style="color:#f0c040; text-align:center;">8ê°• í† ë„ˆë¨¼íŠ¸</h3>
    <p style="text-align:center; margin:20px 0;">
      8íŒ€ì´ ì°¸ê°€í•œ í† ë„ˆë¨¼íŠ¸ì…ë‹ˆë‹¤!<br>
      í˜„ì¬ ë¼ìš´ë“œ: ì¤€ê²°ìŠ¹
    </p>
    <div class="actions">
      <button class="success" onclick="startTournamentBattle()">ë‹¤ìŒ ì „íˆ¬ ì‹œì‘</button>
    </div>
  `;
  
  document.getElementById('tournamentModal').classList.add('active');
}

function startTournamentBattle() {
  if (!gameState.tournament.active) return;
  
  const round = gameState.tournament.round;
  const opponent = gameState.tournament.bracket[round];
  
  if (!opponent) {
    alert('í† ë„ˆë¨¼íŠ¸ ì™„ë£Œ!');
    return;
  }
  
  gameState.enemyTeam = opponent.team;
  battleState.isTournament = true;
  battleState.isPvP = false;
  battleState.enemyFormation = opponent.formation;
  
  closeTournamentModal();
  switchTab('battle');
  initBattleState();
  
  logBattle(`=== í† ë„ˆë¨¼íŠ¸: ${opponent.name}ì™€(ê³¼)ì˜ ì „íˆ¬ ===`);
}

function advanceTournament(won) {
  if (!gameState.tournament.active) return;
  
  if (won) {
    gameState.tournament.round++;
    
    if (gameState.tournament.round >= gameState.tournament.bracket.length) {
      // ìš°ìŠ¹!
      gameState.tournament.active = false;
      unlockAchievement('tournamentChamp');
      
      const prize = 2000 + gameState.season * 100;
      const gloryPrize = 500;
      
      gameState.gold += prize;
      gameState.glory += gloryPrize;
      
      alert(`ğŸ† í† ë„ˆë¨¼íŠ¸ ìš°ìŠ¹!\n\në³´ìƒ: ${prize}ê³¨ë“œ, ${gloryPrize}ëª…ì˜ˆ`);
      saveGame();
    } else {
      setTimeout(() => {
        document.getElementById('tournamentContent').innerHTML = `
          <h3 style="color:#f0c040; text-align:center;">í† ë„ˆë¨¼íŠ¸ ì§„í–‰ ì¤‘</h3>
          <p style="text-align:center; margin:20px 0; color:#4ab58a;">
            ìŠ¹ë¦¬!<br><br>
            ë¼ìš´ë“œ ${gameState.tournament.round + 1} / ${gameState.tournament.bracket.length}
          </p>
          <div class="actions">
            <button class="success" onclick="startTournamentBattle()">ë‹¤ìŒ ì „íˆ¬</button>
            <button onclick="closeTournamentModal()">ë‚˜ì¤‘ì—</button>
          </div>
        `;
        document.getElementById('tournamentModal').classList.add('active');
      }, 1000);
    }
  } else {
    // íŒ¨ë°°
    gameState.tournament.active = false;
    alert('í† ë„ˆë¨¼íŠ¸ì—ì„œ íƒˆë½í–ˆìŠµë‹ˆë‹¤...');
  }
}

function closeTournamentModal() {
  document.getElementById('tournamentModal').classList.remove('active');
}

// --- PvP ì‹œìŠ¤í…œ ---
function renderPvPRosters() {
  const p1Div = document.getElementById('pvpPlayer1Roster');
  const p2Div = document.getElementById('pvpPlayer2Roster');
  
  p1Div.innerHTML = '';
  p2Div.innerHTML = '';
  
  gameState.roster.forEach(hero => {
    const card1 = createSimpleHeroCard(hero, () => togglePvPSelection(hero, 1));
    const card2 = createSimpleHeroCard(hero, () => togglePvPSelection(hero, 2));
    
    if (gameState.pvp.p1Team.some(h => h.id === hero.id)) card1.classList.add('selected');
    if (gameState.pvp.p2Team.some(h => h.id === hero.id)) card2.classList.add('selected');
    
    p1Div.appendChild(card1);
    p2Div.appendChild(card2);
  });
  
  document.getElementById('pvpP1Count').textContent = gameState.pvp.p1Team.length;
  document.getElementById('pvpP2Count').textContent = gameState.pvp.p2Team.length;
}

function createSimpleHeroCard(hero, onClick) {
  const card = document.createElement('div');
  card.className = 'hero-card';
  card.onclick = onClick;
  card.style.cursor = 'pointer';
  card.style.minHeight = '100px';
  
  card.innerHTML = `
    <div class="hero-name">${hero.name}</div>
    <div class="hero-class">${hero.race} ${hero.class}</div>
    <div class="hero-level">Lv ${hero.level}</div>
  `;
  return card;
}

function togglePvPSelection(hero, player) {
  const team = player === 1 ? gameState.pvp.p1Team : gameState.pvp.p2Team;
  const idx = team.findIndex(h => h.id === hero.id);
  
  if (idx >= 0) {
    team.splice(idx, 1);
  } else {
    if (team.length < 5) {
      team.push(hero);
    } else {
      alert('ìµœëŒ€ 5ëª…ê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
    }
  }
  
  renderPvPRosters();
}

function startPvPBattle() {
  if (gameState.pvp.p1Team.length !== 5 || gameState.pvp.p2Team.length !== 5) {
    alert('ê° í”Œë ˆì´ì–´ëŠ” ì˜ì›… 5ëª…ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤!');
    return;
  }
  
  // P1 vs P2 ì „íˆ¬
  gameState.team = [...gameState.pvp.p1Team];
  gameState.enemyTeam = [...gameState.pvp.p2Team];
  
  battleState.isPvP = true;
  battleState.isTournament = false;
  battleState.isPvPPlayer1 = true;
  battleState.enemyFormation = 'balanced';
  
  switchTab('battle');
  initBattleState();
  
  logBattle('=== PvP: í”Œë ˆì´ì–´ 1 vs í”Œë ˆì´ì–´ 2 ===');
}

// --- ì—…ì  ì‹œìŠ¤í…œ ---
function renderAchievements() {
  const grid = document.getElementById('achievementGrid');
  grid.innerHTML = '';
  
  ACHIEVEMENTS.forEach(ach => {
    const unlocked = gameState.achievements[ach.id] || false;
    const card = document.createElement('div');
    card.className = 'achievement-card' + (unlocked ? ' unlocked' : '');
    
    card.innerHTML = `
      <div class="achievement-title">${unlocked ? 'âœ“ ' : ''}${ach.name}</div>
      <div class="achievement-desc">${ach.desc}</div>
      <div class="achievement-progress">
        ${unlocked ? 'ë‹¬ì„±!' : 'ë¯¸ë‹¬ì„±'}
        ${ach.reward.gold ? ` | ${ach.reward.gold}ê³¨ë“œ` : ''}
        ${ach.reward.glory ? ` | ${ach.reward.glory}ëª…ì˜ˆ` : ''}
      </div>
    `;
    
    grid.appendChild(card);
  });
}

function unlockAchievement(id) {
  if (gameState.achievements[id]) return;
  
  const ach = ACHIEVEMENTS.find(a => a.id === id);
  if (!ach) return;
  
  gameState.achievements[id] = true;
  
  if (ach.reward.gold) gameState.gold += ach.reward.gold;
  if (ach.reward.glory) gameState.glory += ach.reward.glory;
  
  updateUI();
  renderAchievements();
  saveGame();
  
  alert(`ğŸ–ï¸ ì—…ì  ë‹¬ì„±!\n\n${ach.name}\n${ach.desc}\n\në³´ìƒ: ${ach.reward.gold || 0}ê³¨ë“œ, ${ach.reward.glory || 0}ëª…ì˜ˆ`);
}

function checkAchievements() {
  // ì²´í¬ ë¡œì§
  if (gameState.wins > 0 && !gameState.achievements.firstVictory) {
    unlockAchievement('firstVictory');
  }
  
  if (gameState.season >= 10) unlockAchievement('seasonMaster');
  if (gameState.roster.length >= 15) unlockAchievement('collector');
  if (gameState.gold >= 5000) unlockAchievement('rich');
  if (gameState.glory >= 1000) unlockAchievement('gloryHunter');
  
  if (gameState.roster.some(h => h.level >= 30)) unlockAchievement('legendaryHero');
  if (gameState.roster.some(h => h.evolved)) unlockAchievement('evolved');
  
  if (gameState.inventory.some(eq => eq.grade === 'legendary')) {
    unlockAchievement('equipmentMaster');
  }
}

// --- í†µê³„ ---
function updateStatistics() {
  const stats = gameState.statistics;
  const playTimeSec = Math.floor((Date.now() - stats.playStartTime + stats.playTimeMs) / 1000);
  const hours = Math.floor(playTimeSec / 3600);
  const minutes = Math.floor((playTimeSec % 3600) / 60);
  
  document.getElementById('statPlayTime').textContent = `${hours}h ${minutes}m`;
  document.getElementById('statTotalBattles').textContent = stats.totalBattles;
  
  const winRate = stats.totalBattles > 0 ? Math.floor((stats.totalWins / stats.totalBattles) * 100) : 0;
  document.getElementById('statWinRate').textContent = winRate + '%';
  
  document.getElementById('statWinStreak').textContent = stats.bestWinStreak;
  document.getElementById('statTotalGold').textContent = stats.totalGoldEarned;
  document.getElementById('statHighestSeason').textContent = stats.highestSeason;
  document.getElementById('statHeroesRecruited').textContent = stats.heroesRecruited;
  document.getElementById('statMaxLevel').textContent = stats.maxHeroLevel;
  document.getElementById('statLegendaryItems').textContent = stats.legendaryItemsFound;
  document.getElementById('statAchievements').textContent = Object.keys(gameState.achievements).length;
  
  // Hall of Fame
  document.getElementById('hofGlory').textContent = gameState.glory;
  document.getElementById('hofWinStreak').textContent = stats.bestWinStreak;
  document.getElementById('hofFastestS20').textContent = stats.fastestSeason20 ? `${Math.floor(stats.fastestSeason20 / 60)}ë¶„` : '-';
  document.getElementById('hofNGPlus').textContent = stats.ngPlusClears;
}

function updatePlayTime() {
  const elapsed = Date.now() - gameState.statistics.playStartTime;
  gameState.statistics.playTimeMs += 60000;
  saveGame();
}

// --- ìŠ¤í† ë¦¬ ---
function checkStoryProgress() {
  const chapter = STORY_CHAPTERS[gameState.season];
  if (chapter && !gameState.storyProgress.includes(gameState.season)) {
    gameState.storyProgress.push(gameState.season);
    showStory(chapter);
  }
}

function showStory(chapter) {
  document.getElementById('storyChapter').textContent = chapter.title;
  document.getElementById('storyText').textContent = chapter.text;
  document.getElementById('storyModal').classList.add('active');
}

function closeStoryModal() {
  document.getElementById('storyModal').classList.remove('active');
}

// --- ì—”ë”© ---
function showEnding() {
  const playTime = Math.floor((Date.now() - gameState.statistics.playStartTime + gameState.statistics.playTimeMs) / 1000 / 60);
  
  if (!gameState.statistics.fastestSeason20 || playTime < gameState.statistics.fastestSeason20) {
    gameState.statistics.fastestSeason20 = playTime;
  }
  
  unlockAchievement('storyComplete');
  
  const content = `
    <h2 style="color:#f0c040; margin-bottom:20px;">ì‹œì¦Œ 20 í´ë¦¬ì–´!</h2>
    <p style="font-size:18px; line-height:2; color:#d0e0f0;">
      ë‹¹ì‹ ì€ ìµœê³ ì˜ ë§¤ë‹ˆì €ì…ë‹ˆë‹¤!<br>
      ëª¨ë“  ë„ì „ì„ ê·¹ë³µí•˜ê³  ì „ì„¤ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!<br><br>
      
      í”Œë ˆì´ ì‹œê°„: ${Math.floor(playTime / 60)}ì‹œê°„ ${playTime % 60}ë¶„<br>
      ì´ ìŠ¹ë¦¬: ${gameState.statistics.totalWins}<br>
      ìµœê³  ì—°ìŠ¹: ${gameState.statistics.bestWinStreak}<br>
      ëª…ì˜ˆ: ${gameState.glory}<br><br>
      
      ë‰´ê²Œì„+ë¡œ ë” ê°•ë ¥í•œ ì ë“¤ì— ë„ì „í•˜ì„¸ìš”!
    </p>
  `;
  
  document.getElementById('endingContent').innerHTML = content;
  document.getElementById('endingModal').classList.add('active');
}

function closeEndingModal() {
  document.getElementById('endingModal').classList.remove('active');
}

function startNewGamePlus() {
  if (!confirm('ë‰´ê²Œì„+ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n- ì˜ì›…ê³¼ ì¥ë¹„ëŠ” ìœ ì§€ë©ë‹ˆë‹¤\n- ì ì˜ ë‚œì´ë„ê°€ 50% ì¦ê°€í•©ë‹ˆë‹¤\n- ì‹œì¦Œ 1ë¶€í„° ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤')) {
    return;
  }
  
  gameState.ngPlusLevel++;
  gameState.season = 1;
  gameState.matchesPlayed = 0;
  gameState.wins = 0;
  gameState.losses = 0;
  gameState.storyProgress = [];
  gameState.statistics.ngPlusClears++;
  
  updateUI();
  saveGame();
  closeEndingModal();
  
  unlockAchievement('newGamePlus');
  
  alert(`ë‰´ê²Œì„+ ë ˆë²¨ ${gameState.ngPlusLevel} ì‹œì‘!\në‚œì´ë„ +${gameState.ngPlusLevel * 50}%`);
}

// --- íŠœí† ë¦¬ì–¼ ---
function showTutorial() {
  const content = `
    <div class="tutorial-step">
      <h4>1. ì˜ì›… ëª¨ì§‘</h4>
      <p>ì‹œì¥ì—ì„œ ê³¨ë“œë¥¼ ì‚¬ìš©í•´ ìƒˆë¡œìš´ ì˜ì›…ì„ ëª¨ì§‘í•˜ì„¸ìš”.</p>
    </div>
    <div class="tutorial-step">
      <h4>2. íŒ€ êµ¬ì„±</h4>
      <p>ë¡œìŠ¤í„°ì—ì„œ ì˜ì›…ì„ í´ë¦­í•˜ì—¬ ì „íˆ¬ íŒ€ì— ì¶”ê°€í•˜ì„¸ìš” (ìµœëŒ€ 5ëª…).</p>
    </div>
    <div class="tutorial-step">
      <h4>3. ì˜ì›… ê°•í™”</h4>
      <p>ì˜ì›…ì„ í´ë¦­í•˜ì—¬ í›ˆë ¨, ì¥ë¹„ ì°©ìš©, ìŠ¤í‚¬ íŠ¸ë¦¬ ì„ íƒì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
    <div class="tutorial-step">
      <h4>4. ì „íˆ¬</h4>
      <p>ëŒ€í˜•ì„ ì„ íƒí•˜ê³  ì „íˆ¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”. ìë™ ì „íˆ¬ê°€ ì§„í–‰ë©ë‹ˆë‹¤.</p>
    </div>
    <div class="tutorial-step">
      <h4>5. ì‹œì¦Œ ì§„í–‰</h4>
      <p>10ê²½ê¸°ë¥¼ ì™„ë£Œí•˜ë©´ ë‹¤ìŒ ì‹œì¦Œìœ¼ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
  `;
  
  document.getElementById('tutorialContent').innerHTML = content;
  document.getElementById('tutorialModal').classList.add('active');
}

function closeTutorialModal() {
  document.getElementById('tutorialModal').classList.remove('active');
}

// --- ë„ì›€ë§ ---
function showHelp() {
  const content = `
    <div class="help-section">
      <h4>ğŸ’ª ì˜ì›… ì‹œìŠ¤í…œ</h4>
      <p>â€¢ 5ê°œì˜ í´ë˜ìŠ¤: ì „ì‚¬, ë§ˆë²•ì‚¬, ê¶ìˆ˜, ì‚¬ì œ, íƒ±ì»¤</p>
      <p>â€¢ ë ˆë²¨ 10ê³¼ 20ì— ìŠ¤í‚¬ íŠ¸ë¦¬ ì„ íƒ</p>
      <p>â€¢ ë ˆë²¨ 25ì— ì§„í™” ê°€ëŠ¥ (ëª¨ë“  ëŠ¥ë ¥ì¹˜ +30%)</p>
    </div>
    
    <div class="help-section">
      <h4>âš”ï¸ ì¥ë¹„ ì‹œìŠ¤í…œ</h4>
      <p>â€¢ 4ë“±ê¸‰: ì¼ë°˜, í¬ê·€, ì˜ì›…, ì „ì„¤</p>
      <p>â€¢ íŠ¹ìˆ˜ íš¨ê³¼: í¡í˜ˆ, ë²ˆê°œ, ë¶ˆì‚¬ì¡° ë“±</p>
      <p>â€¢ ê°•í™” ì‹œìŠ¤í…œ: ìµœëŒ€ +5ê¹Œì§€ ê°•í™”</p>
    </div>
    
    <div class="help-section">
      <h4>ğŸ›ï¸ ê¸¸ë“œ</h4>
      <p>â€¢ í›ˆë ¨ ë¹„ìš© ê°ì†Œ, ì „íˆ¬ ë³´ìƒ ì¦ê°€</p>
      <p>â€¢ ëª…ì˜ˆë¥¼ íˆ¬ìí•˜ì—¬ ë ˆë²¨ì—…</p>
    </div>
    
    <div class="help-section">
      <h4>ğŸ¯ ëŒ€í˜• ì‹œìŠ¤í…œ</h4>
      <p>â€¢ ê³µê²©í˜•: ê³µê²© +10%, ë°©ì–´ -5%</p>
      <p>â€¢ ê· í˜•í˜•: ë³´ë„ˆìŠ¤/í˜ë„í‹° ì—†ìŒ</p>
      <p>â€¢ ìˆ˜ë¹„í˜•: ë°©ì–´ +10%, ê³µê²© -5%</p>
    </div>
    
    <div class="help-section">
      <h4>ğŸ… ê²Œì„ ëª¨ë“œ</h4>
      <p>â€¢ ë¦¬ê·¸: ì‹œì¦Œ ì§„í–‰ (10ê²½ê¸°)</p>
      <p>â€¢ í† ë„ˆë¨¼íŠ¸: 8ê°• í† ë„ˆë¨¼íŠ¸ (ì‹œì¦Œë‹¹ 1íšŒ)</p>
      <p>â€¢ PvP: ë¡œì»¬ ëŒ€ì „ ëª¨ë“œ</p>
    </div>
    
    <div class="help-section">
      <h4>ğŸ’¡ íŒ</h4>
      <p>â€¢ ìš©ë³‘ì€ ê°•ë ¥í•˜ì§€ë§Œ í•œ ë²ˆë§Œ ì‚¬ìš© ê°€ëŠ¥</p>
      <p>â€¢ ê¶ê·¹ê¸°ëŠ” 5í„´ë§ˆë‹¤ ë°œë™</p>
      <p>â€¢ ì „ì„¤ ì¥ë¹„ì˜ íŠ¹ìˆ˜ íš¨ê³¼ë¥¼ í™œìš©í•˜ì„¸ìš”</p>
      <p>â€¢ ì‹œì¦Œ 20ì„ í´ë¦¬ì–´í•˜ë©´ ë‰´ê²Œì„+ ë„ì „!</p>
    </div>
  `;
  
  document.getElementById('helpContent').innerHTML = content;
  document.getElementById('helpModal').classList.add('active');
}

function closeHelpModal() {
  document.getElementById('helpModal').classList.remove('active');
}

// --- ì „íˆ¬ ì„¤ì • ---
function setBattleSpeed(speed) {
  gameState.settings.battleSpeed = speed;
  document.querySelectorAll('.battle-controls .small').forEach(btn => {
    btn.style.background = '';
  });
  document.getElementById(`speed${speed}x`).style.background = 'linear-gradient(135deg, #3a6a9a 0%, #2a5a8a 100%)';
  saveGame();
}

function toggleMusic() {
  gameState.settings.musicEnabled = !gameState.settings.musicEnabled;
  document.getElementById('musicBtn').textContent = gameState.settings.musicEnabled ? 'ğŸµ ì¼¬' : 'ğŸµ ë”';
  saveGame();
}

function toggleSound() {
  gameState.settings.soundEnabled = !gameState.settings.soundEnabled;
  document.getElementById('soundBtn').textContent = gameState.settings.soundEnabled ? 'ğŸ”Š ì¼¬' : 'ğŸ”Š ë”';
  saveGame();
}

// --- ì˜¤ë””ì˜¤ (í”Œë ˆì´ìŠ¤í™€ë”) ---
function initAudio() {
  // ì‹¤ì œ ê²Œì„ì—ì„œëŠ” Audio ê°ì²´ë¡œ êµ¬í˜„
}

function playSound(type) {
  if (!gameState.settings.soundEnabled) return;
  // ì‚¬ìš´ë“œ ì¬ìƒ ë¡œì§ (í”Œë ˆì´ìŠ¤í™€ë”)
  console.log(`Playing sound: ${type}`);
}

// --- ì €ì¥/ë¡œë“œ ---
function saveGame() {
  try {
    localStorage.setItem('fantasyManager_v4', JSON.stringify(gameState));
  } catch (e) {
    console.error('Save failed:', e);
  }
}

function loadGame() {
  try {
    const saved = localStorage.getItem('fantasyManager_v4');
    if (saved) {
      const loaded = JSON.parse(saved);
      Object.assign(gameState, loaded);
    }
  } catch (e) {
    console.error('Load failed:', e);
  }
}

// --- ì´ˆê¸°í™” ì‹¤í–‰ ---
init();
</script>
</body>
</html>
