<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space War - Pixel Art</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: #000; color: #fff; overflow: hidden;
        }
        #ui {
            position: fixed; top: 0; left: 0; width: 100%;
            padding: 20px; pointer-events: none; z-index: 10;
        }
        .stat-bar {
            background: rgba(0,0,0,0.8); border: 2px solid #00ffff;
            border-radius: 10px; padding: 10px;
            display: inline-block; margin-right: 20px;
            box-shadow: 0 0 15px rgba(0,255,255,0.3);
        }
        .stat-label { color: #00ffff; font-size: 14px; margin-bottom: 5px; }
        .bar {
            width: 200px; height: 20px; background: #333;
            border-radius: 5px; overflow: hidden; border: 1px solid #666;
        }
        .bar-fill {
            height: 100%; transition: width 0.3s;
            background: linear-gradient(90deg, #00ff00, #00cc00);
            box-shadow: 0 0 10px rgba(0,255,0,0.5);
        }
        .exp-bar .bar-fill {
            background: linear-gradient(90deg, #ffff00, #ff9900);
            box-shadow: 0 0 10px rgba(255,255,0,0.5);
        }
        #levelUpModal {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); border: 3px solid #00ffff;
            border-radius: 15px; padding: 30px; display: none;
            z-index: 100; max-width: 1000px; pointer-events: auto;
            box-shadow: 0 0 40px rgba(0,255,255,0.6);
        }
        .upgrade-grid {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 15px; margin-top: 20px;
        }
        .upgrade-card {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #00ffff; border-radius: 10px;
            padding: 15px; cursor: pointer; transition: all 0.3s;
        }
        .upgrade-card:hover {
            transform: scale(1.05); border-color: #00ff00;
            box-shadow: 0 0 20px rgba(0,255,255,0.5);
        }
        .upgrade-icon { font-size: 32px; margin-bottom: 8px; }
        .upgrade-name {
            color: #00ffff; font-size: 15px;
            font-weight: bold; margin-bottom: 8px;
        }
        .upgrade-desc { color: #aaa; font-size: 12px; }
        .level-display { color: #ffff00; font-size: 13px; margin-top: 8px; }
        #gameOver {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); border: 3px solid #ff0000;
            border-radius: 15px; padding: 40px; display: none;
            z-index: 100; text-align: center;
            box-shadow: 0 0 40px rgba(255,0,0,0.6);
        }
        .btn {
            background: linear-gradient(135deg, #00ffff, #0099ff);
            border: none; color: #000; padding: 15px 30px;
            font-size: 18px; font-weight: bold; border-radius: 10px;
            cursor: pointer; margin: 10px; transition: all 0.3s;
        }
        .btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0,255,255,0.8);
        }
        #stats {
            position: fixed; top: 80px; left: 20px;
            background: rgba(0,0,0,0.8); border: 2px solid #00ffff;
            border-radius: 10px; padding: 15px; font-size: 14px; color: #0ff;
            box-shadow: 0 0 15px rgba(0,255,255,0.3);
        }
        canvas {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    
    <div id="ui">
        <div class="stat-bar">
            <div class="stat-label">HP: <span id="hpText">150/150</span></div>
            <div class="bar"><div class="bar-fill" id="hpBar" style="width: 100%"></div></div>
        </div>
        <div class="stat-bar exp-bar">
            <div class="stat-label">Í≤ΩÌóòÏπò: <span id="expText">0/100</span></div>
            <div class="bar"><div class="bar-fill" id="expBar" style="width: 0%"></div></div>
        </div>
    </div>
    
    <div id="stats">
        <div>Î†àÎ≤®: <span id="levelText">1</span></div>
        <div>ÏãúÍ∞Ñ: <span id="timeText">00:00</span></div>
        <div>Ï≤òÏπò: <span id="killText">0</span></div>
    </div>
    
    <div id="levelUpModal">
        <h2 style="color: #00ffff; text-align: center; margin-bottom: 20px;">‚¨ÜÔ∏è Î†àÎ≤® UP! ÏóÖÍ∑∏Î†àÏù¥Îìú ÏÑ†ÌÉù</h2>
        <div class="upgrade-grid" id="upgradeOptions"></div>
    </div>
    
    <div id="gameOver">
        <h1 style="color: #ff0000; margin-bottom: 20px;">üí• Ï†ÑÌï® ÌååÍ¥¥!</h1>
        <div style="font-size: 24px; margin-bottom: 20px;">
            <div>ÏÉùÏ°¥ ÏãúÍ∞Ñ: <span id="finalTime" style="color: #ffff00;">00:00</span></div>
            <div>Ï¥ù Ï≤òÏπò: <span id="finalKills" style="color: #00ff00;">0</span></div>
            <div>ÏµúÏ¢Ö Î†àÎ≤®: <span id="finalLevel" style="color: #00ffff;">1</span></div>
        </div>
        <button class="btn" onclick="location.reload()">üîÑ Îã§Ïãú ÏãúÏûë</button>
    </div>

    <script>
        // ÌîΩÏÖÄ ÏïÑÌä∏ Îç∞Ïù¥ÌÑ∞ (Raptor Ïä§ÌÉÄÏùº)
        const PIXEL_ART = {
            // ÌîåÎ†àÏù¥Ïñ¥ Ïö∞Ï£ºÏÑ† (32x32)
            player: {
                width: 32, height: 32,
                data: [
                    "................................",
                    "............####................",
                    "...........#2222#...............",
                    "..........#223322#..............",
                    ".........#22333322#.............",
                    "........#2233##3322#............",
                    ".......#22##5555##22#...........",
                    "......#22#55666655#22#..........",
                    ".....#33#5566bb6655#33#.........",
                    "....#333#566bbbb665#333#........",
                    "...#3333#66bbbbbb66#3333#.......",
                    "..#33333#6bbbbbbbb6#33333#......",
                    ".#333333##bbbbbbbb##333333#.....",
                    "#3333333#2bbbbbbbb2#3333333#....",
                    "#3333333#2bbbbbbbb2#3333333#....",
                    "#3333333#2bbbbbbbb2#3333333#....",
                    "################bbbbbbbb########",
                    "#3333333#2bbbbbbbb2#3333333#....",
                    "#3333333#2bbbbbbbb2#3333333#....",
                    ".#333333##bbbbbbbb##333333#.....",
                    "..#33333#6bbbbbbbb6#33333#......",
                    "...#3333#66bbbbbb66#3333#.......",
                    "....#333#566bbbb665#333#........",
                    ".....#33#5566bb6655#33#.........",
                    "......#22#55666655#22#..........",
                    ".......#22##5555##22#...........",
                    "........#2233##3322#............",
                    ".........#ff####ff#.............",
                    "..........#ffffff#..............",
                    "...........#ffff#...............",
                    "............####................",
                    "................................"
                ],
                colors: {
                    '#': 0x1a1a1a, // Í≤ÄÏ†ï
                    '2': 0x3366aa, // ÏßÑÌïú ÌååÎûë
                    '3': 0x5599dd, // ÌååÎûë
                    '5': 0x667788, // ÌöåÏÉâ
                    '6': 0x99aabb, // Î∞ùÏùÄ ÌöåÏÉâ
                    'b': 0x66ccff, // ÌïòÎäòÏÉâ (Ï°∞Ï¢ÖÏÑù)
                    'f': 0xff6600  // Ï£ºÌô© (ÏóîÏßÑ)
                }
            },
            // Ï†Å ÌÉÄÏûÖ 1 (24x24)
            enemy1: {
                width: 24, height: 24,
                data: [
                    "........########........",
                    ".......#11111111#.......",
                    "......#1111221111#......",
                    ".....#111122221111#.....",
                    "....#11112222221111#....",
                    "...#1111222222221111#...",
                    "..#111122222222221111#..",
                    ".#11112222222222221111#.",
                    "#1111222222##22222221111",
                    "#1111222222##22222221111",
                    "#111122222####2222221111",
                    "##11222222####22222211##",
                    "##11222222####22222211##",
                    "#111122222####2222221111",
                    "#1111222222##22222221111",
                    "#1111222222##22222221111",
                    ".#11112222222222221111#.",
                    "..#111122222222221111#..",
                    "...#1111222222221111#...",
                    "....#11112222221111#....",
                    ".....#111122221111#.....",
                    "......#1111221111#......",
                    ".......#11111111#.......",
                    "........########........"
                ],
                colors: {
                    '#': 0x330000,
                    '1': 0xaa0000,
                    '2': 0xff3333
                }
            },
            // Ï†Å ÌÉÄÏûÖ 2 (28x28)
            enemy2: {
                width: 28, height: 28,
                data: [
                    "..........######..........",
                    ".........#333333#.........",
                    "........#33344433#........",
                    ".......#3334444433#.......",
                    "......#333444444333#......",
                    ".....#33344444444333#.....",
                    "....#3334444##444433#.....",
                    "...#333444##55##44433#....",
                    "..#33344##5555555##433#...",
                    ".#3334##55555555555##433#.",
                    "#333##55555555555555##333#",
                    "#33##5555555555555555##33#",
                    "#3##555555555555555555##3#",
                    "####555555555555555555####",
                    "####555555555555555555####",
                    "#3##555555555555555555##3#",
                    "#33##5555555555555555##33#",
                    "#333##55555555555555##333#",
                    ".#3334##55555555555##433#.",
                    "..#33344##5555555##443#...",
                    "...#333444##555##44433#...",
                    "....#3334444##444433#.....",
                    ".....#33344444444333#.....",
                    "......#333444444333#......",
                    ".......#3334444433#.......",
                    "........#33344433#........",
                    ".........#333333#.........",
                    "..........######..........",
                ],
                colors: {
                    '#': 0x331100,
                    '3': 0xaa4400,
                    '4': 0xff8800,
                    '5': 0xffaa44
                }
            },
            // Ï†Å ÌÉÄÏûÖ 3 (32x32) - ÎåÄÌòï
            enemy3: {
                width: 32, height: 32,
                data: [
                    "............########............",
                    "...........#55555555#...........",
                    "..........#5566666655#..........",
                    ".........#556677776655#.........",
                    "........#55667788776655#........",
                    ".......#5566778aa877665#........",
                    "......#556677##aa##7766#........",
                    ".....#55667#aaaaaaa#766#........",
                    "....#55667#aaaaccaaa#66#........",
                    "...#55667#aaccccccaa#66#........",
                    "..#55667#aaccccccccaa#6#........",
                    ".#55667#aacccccccccaa##.........",
                    "#55667#aaccccccccccca#..........",
                    "#5567#aacccc####cccca#..........",
                    "#567#aaccc##8888##cca#..........",
                    "#67#aacc##88aaaa88##a#..........",
                    "#67#aacc##88aaaa88##a#..........",
                    "#567#aaccc##8888##cca#..........",
                    "#5567#aacccc####cccca#..........",
                    "#55667#aaccccccccccca#..........",
                    ".#55667#aacccccccccaa##.........",
                    "..#55667#aaccccccccaa#6#........",
                    "...#55667#aaccccccaa#66#........",
                    "....#55667#aaaaccaaa#66#........",
                    ".....#55667#aaaaaaa#766#........",
                    "......#556677##aa##7766#........",
                    ".......#5566778aa877665#........",
                    "........#55667788776655#........",
                    ".........#556677776655#.........",
                    "..........#5566666655#..........",
                    "...........#55555555#...........",
                    "............########............"
                ],
                colors: {
                    '#': 0x220022,
                    '5': 0x660066,
                    '6': 0xaa00aa,
                    '7': 0xdd00dd,
                    '8': 0xff44ff,
                    'a': 0xff88ff,
                    'c': 0xffccff
                }
            }
        };

        // Phaser Scene
        class GameScene extends Phaser.Scene {
            constructor() {
                super('GameScene');
            }

            preload() {
                this.createPixelSprites();
            }

            createPixelSprites() {
                // Í∞Å Ïä§ÌîÑÎùºÏù¥Ìä∏Î•º ÌîΩÏÖÄ Îç∞Ïù¥ÌÑ∞Î°ú ÏÉùÏÑ±
                Object.keys(PIXEL_ART).forEach(key => {
                    const sprite = PIXEL_ART[key];
                    const g = this.add.graphics();
                    
                    for (let y = 0; y < sprite.height; y++) {
                        for (let x = 0; x < sprite.width; x++) {
                            const char = sprite.data[y][x];
                            if (char !== '.' && sprite.colors[char]) {
                                g.fillStyle(sprite.colors[char]);
                                g.fillRect(x * 2, y * 2, 2, 2); // 2x ÌôïÎåÄ
                            }
                        }
                    }
                    
                    g.generateTexture(key, sprite.width * 2, sprite.height * 2);
                    g.destroy();
                });

                // ÌååÌã∞ÌÅ¥
                const g = this.add.graphics();
                g.fillStyle(0xffffff);
                g.fillCircle(4, 4, 4);
                g.generateTexture('particle', 8, 8);
                g.destroy();
            }

            create() {
                this.initGame();
                
                // Î∞∞Í≤Ω Î≥Ñ
                this.stars = [];
                for (let i = 0; i < 200; i++) {
                    const star = this.add.circle(
                        Phaser.Math.Between(0, config.width),
                        Phaser.Math.Between(0, config.height),
                        Phaser.Math.Between(1, 2),
                        0xffffff,
                        Phaser.Math.FloatBetween(0.3, 0.8)
                    );
                    star.setData('speed', Phaser.Math.Between(20, 100));
                    this.stars.push(star);
                }
                
                // ÌîåÎ†àÏù¥Ïñ¥
                this.player = this.add.sprite(config.width / 2, config.height / 2, 'player');
                
                // ÏóîÏßÑ ÌååÌã∞ÌÅ¥
                this.engineFire = this.add.particles(0, 0, 'particle', {
                    speed: { min: 50, max: 100 },
                    scale: { start: 0.4, end: 0 },
                    tint: [0xff4400, 0xff8844],
                    lifespan: 200,
                    frequency: 20,
                    x: config.width / 2,
                    y: config.height / 2 + 35
                });
                
                this.enemies = this.add.group();
                this.projectiles = this.add.group();
                
                this.time.addEvent({
                    delay: 1000,
                    callback: () => {
                        if (!this.gamePaused) {
                            this.gameTime++;
                            updateUI();
                        }
                    },
                    loop: true
                });
                
                this.spawnTimer = 0;
            }

            initGame() {
                this.gameRunning = true;
                this.gamePaused = false;
                this.gameTime = 0;
                this.kills = 0;
                
                this.playerData = {
                    hp: 150,
                    maxHp: 150,
                    level: 1,
                    exp: 0,
                    expToNext: 100
                };
                
                this.weapons = [{ type: 'laser', lastShot: 0 }];
                this.weaponTypes = createWeaponTypes(this);
            }

            update(time, delta) {
                if (!this.gameRunning || this.gamePaused) return;
                
                const deltaTime = delta / 1000;
                
                // Î≥Ñ Ïä§ÌÅ¨Î°§
                this.stars.forEach(star => {
                    star.y += star.getData('speed') * deltaTime;
                    if (star.y > config.height) {
                        star.y = 0;
                        star.x = Phaser.Math.Between(0, config.width);
                    }
                });
                
                // Î¨¥Í∏∞ Î∞úÏÇ¨
                this.weapons.forEach(weapon => {
                    const wData = this.weaponTypes[weapon.type];
                    if (wData.shoot && time - weapon.lastShot > wData.cooldown) {
                        wData.shoot(this, time);
                        weapon.lastShot = time;
                    }
                });
                
                // Î∞úÏÇ¨Ï≤¥ ÏóÖÎç∞Ïù¥Ìä∏
                this.projectiles.getChildren().forEach(proj => {
                    if (proj.y < -50 || proj.y > config.height + 50) {
                        proj.destroy();
                    }
                });
                
                // Ï†Å ÏóÖÎç∞Ïù¥Ìä∏
                this.enemies.getChildren().forEach(enemy => {
                    const data = enemy.getData('data');
                    this.physics.moveToObject(enemy, this.player, data.speed);
                    
                    const dist = Phaser.Math.Distance.Between(
                        enemy.x, enemy.y, this.player.x, this.player.y
                    );
                    if (dist < 40) {
                        this.playerData.hp -= data.damage;
                        this.cameras.main.shake(100, 0.01);
                        enemy.destroy();
                        if (this.playerData.hp <= 0) this.gameOver();
                    }
                    
                    this.projectiles.getChildren().forEach(proj => {
                        const pdist = Phaser.Math.Distance.Between(
                            proj.x, proj.y, enemy.x, enemy.y
                        );
                        if (pdist < 25) {
                            const projData = proj.getData('data');
                            const damage = projData.damage * (1 + this.weaponTypes.damage.level * 0.1);
                            data.hp -= damage;
                            proj.destroy();
                            
                            if (data.hp <= 0) {
                                this.kills++;
                                enemy.destroy();
                                this.playerData.exp += 10;
                                if (this.playerData.exp >= this.playerData.expToNext) {
                                    this.levelUp();
                                }
                            }
                        }
                    });
                });
                
                // Ï†Å Ïä§Ìè∞
                const spawnRate = Math.max(300 - this.gameTime * 8, 100);
                this.spawnTimer += delta;
                if (this.spawnTimer > spawnRate) {
                    this.spawnEnemy();
                    this.spawnTimer = 0;
                }
                
                updateUI();
            }

            spawnEnemy() {
                const side = Phaser.Math.Between(0, 3);
                let x, y;
                
                switch(side) {
                    case 0: x = Phaser.Math.Between(0, config.width); y = -50; break;
                    case 1: x = config.width + 50; y = Phaser.Math.Between(0, config.height); break;
                    case 2: x = Phaser.Math.Between(0, config.width); y = config.height + 50; break;
                    case 3: x = -50; y = Phaser.Math.Between(0, config.height); break;
                }
                
                const difficulty = 1 + this.gameTime / 60;
                const type = Phaser.Math.Between(0, 2);
                const textures = ['enemy1', 'enemy2', 'enemy3'];
                
                const enemy = this.add.sprite(x, y, textures[type]);
                this.physics.add.existing(enemy);
                this.enemies.add(enemy);
                
                const hpMult = type === 0 ? 1 : type === 1 ? 1.5 : 2.5;
                const speedMult = type === 0 ? 1.2 : type === 1 ? 1 : 0.7;
                
                enemy.setData('data', {
                    hp: 25 * difficulty * hpMult,
                    maxHp: 25 * difficulty * hpMult,
                    speed: 80 * Math.min(difficulty, 2) * speedMult,
                    damage: 3 + type
                });
            }

            levelUp() {
                this.playerData.level++;
                this.playerData.exp -= this.playerData.expToNext;
                this.playerData.expToNext = Math.floor(this.playerData.expToNext * 1.2);
                this.gamePaused = true;
                showLevelUp(this);
            }

            gameOver() {
                this.gameRunning = false;
                const minutes = Math.floor(this.gameTime / 60);
                const seconds = this.gameTime % 60;
                document.getElementById('finalTime').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('finalKills').textContent = this.kills;
                document.getElementById('finalLevel').textContent = this.playerData.level;
                document.getElementById('gameOver').style.display = 'block';
            }
        }

        const config = {
            type: Phaser.WEBGL,
            width: window.innerWidth,
            height: window.innerHeight,
            parent: 'game-container',
            backgroundColor: '#0a0a1a',
            pixelArt: true,
            physics: {
                default: 'arcade',
                arcade: { gravity: { y: 0 }, debug: false }
            },
            scene: GameScene
        };

        const phaserGame = new Phaser.Game(config);
        let currentScene;

        function createWeaponTypes(scene) {
            return {
                laser: {
                    name: 'Î†àÏù¥Ï†Ä Ìè¨', icon: 'üî´', desc: 'Ï†ÑÎ∞©ÏúÑ Î†àÏù¥Ï†Ä',
                    damage: 10, cooldown: 250, level: 1, maxLevel: 8,
                    shoot: (scene, time) => {
                        const count = 2 + scene.weaponTypes.laser.level;
                        for (let i = 0; i < count; i++) {
                            const angle = Math.random() * Math.PI * 2;
                            const proj = scene.add.rectangle(scene.player.x, scene.player.y, 4, 12, 0x00ffff);
                            scene.physics.add.existing(proj);
                            proj.body.setVelocity(Math.cos(angle) * 400, Math.sin(angle) * 400);
                            proj.setRotation(angle);
                            proj.setData('data', {
                                damage: scene.weaponTypes.laser.damage * (1 + scene.weaponTypes.laser.level * 0.5)
                            });
                            scene.projectiles.add(proj);
                        }
                    }
                },
                missile: {
                    name: 'Ïú†ÎèÑ ÎØ∏ÏÇ¨Ïùº', icon: 'üöÄ', desc: 'Ï†Å Ï∂îÏ†Å ÎØ∏ÏÇ¨Ïùº',
                    damage: 25, cooldown: 1000, level: 0, maxLevel: 6,
                    shoot: (scene, time) => {
                        if (scene.enemies.getLength() === 0) return;
                        const count = 1 + Math.floor(scene.weaponTypes.missile.level / 2);
                        const enemies = scene.enemies.getChildren();
                        for (let i = 0; i < Math.min(count, enemies.length); i++) {
                            const target = enemies[i];
                            const angle = Phaser.Math.Angle.Between(scene.player.x, scene.player.y, target.x, target.y);
                            const proj = scene.add.rectangle(scene.player.x, scene.player.y, 6, 14, 0xff6600);
                            scene.physics.add.existing(proj);
                            proj.body.setVelocity(Math.cos(angle) * 300, Math.sin(angle) * 300);
                            proj.setRotation(angle + Math.PI/2);
                            proj.setData('data', {
                                damage: scene.weaponTypes.missile.damage * (1 + scene.weaponTypes.missile.level * 0.4)
                            });
                            scene.projectiles.add(proj);
                        }
                    }
                },
                plasma: {
                    name: 'ÌîåÎùºÏ¶àÎßà Î≥º', icon: 'üí•', desc: 'Î∞©ÏÇ¨Ìòï ÌîåÎùºÏ¶àÎßà',
                    damage: 15, cooldown: 800, level: 0, maxLevel: 6,
                    shoot: (scene, time) => {
                        const count = 4 + scene.weaponTypes.plasma.level * 2;
                        for (let i = 0; i < count; i++) {
                            const angle = (Math.PI * 2 / count) * i;
                            const proj = scene.add.circle(scene.player.x, scene.player.y, 10, 0xff00ff);
                            scene.physics.add.existing(proj);
                            proj.body.setVelocity(Math.cos(angle) * 300, Math.sin(angle) * 300);
                            proj.setData('data', {
                                damage: scene.weaponTypes.plasma.damage * (1 + scene.weaponTypes.plasma.level * 0.3)
                            });
                            scene.projectiles.add(proj);
                        }
                    }
                },
                shield: {
                    name: 'ÏóêÎÑàÏßÄ Ïã§Îìú', icon: 'üõ°Ô∏è', desc: 'ÏµúÎåÄ Ï≤¥Î†• +30',
                    level: 0, maxLevel: 8,
                    apply: (scene) => {
                        scene.playerData.maxHp += 30;
                        scene.playerData.hp = Math.min(scene.playerData.hp + 30, scene.playerData.maxHp);
                    }
                },
                regen: {
                    name: 'Ïû¨ÏÉù', icon: 'üíö', desc: 'Ï≤¥Î†• ÌöåÎ≥µ +20',
                    level: 0, maxLevel: 10,
                    apply: (scene) => {
                        scene.playerData.hp = Math.min(scene.playerData.hp + 20, scene.playerData.maxHp);
                    }
                },
                damage: {
                    name: 'ÌôîÎ†• Ï¶ùÍ∞ï', icon: 'üí™', desc: 'Î™®Îì† Î¨¥Í∏∞ +10%',
                    level: 0, maxLevel: 15,
                    apply: (scene) => {}
                }
            };
        }

        function showLevelUp(scene) {
            if (!currentScene) currentScene = scene;
            const modal = document.getElementById('levelUpModal');
            const options = document.getElementById('upgradeOptions');
            options.innerHTML = '';
            
            const available = Object.keys(scene.weaponTypes).filter(k => {
                const w = scene.weaponTypes[k];
                return !w.maxLevel || w.level < w.maxLevel;
            });
            
            const selected = [];
            while (selected.length < Math.min(5, available.length)) {
                const idx = Math.floor(Math.random() * available.length);
                selected.push(available[idx]);
                available.splice(idx, 1);
            }
            
            selected.forEach(key => {
                const weapon = scene.weaponTypes[key];
                const card = document.createElement('div');
                card.className = 'upgrade-card';
                card.innerHTML = `
                    <div class="upgrade-icon">${weapon.icon}</div>
                    <div class="upgrade-name">${weapon.name}</div>
                    <div class="upgrade-desc">${weapon.desc}</div>
                    <div class="level-display">Lv ${weapon.level} ‚Üí ${weapon.level + 1}</div>
                `;
                card.onclick = () => selectUpgrade(scene, key);
                options.appendChild(card);
            });
            
            modal.style.display = 'block';
        }

        function selectUpgrade(scene, key) {
            const weapon = scene.weaponTypes[key];
            weapon.level++;
            
            if (weapon.shoot && !scene.weapons.find(w => w.type === key)) {
                scene.weapons.push({ type: key, lastShot: 0 });
            }
            
            if (weapon.apply) weapon.apply(scene);
            
            document.getElementById('levelUpModal').style.display = 'none';
            scene.gamePaused = false;
        }

        function updateUI() {
            if (!currentScene) currentScene = phaserGame.scene.scenes[0];
            const p = currentScene.playerData;
            
            document.getElementById('hpText').textContent = `${Math.ceil(p.hp)}/${p.maxHp}`;
            document.getElementById('hpBar').style.width = (p.hp / p.maxHp * 100) + '%';
            document.getElementById('expText').textContent = `${p.exp}/${p.expToNext}`;
            document.getElementById('expBar').style.width = (p.exp / p.expToNext * 100) + '%';
            document.getElementById('levelText').textContent = p.level;
            document.getElementById('killText').textContent = currentScene.kills;
            
            const minutes = Math.floor(currentScene.gameTime / 60);
            const seconds = currentScene.gameTime % 60;
            document.getElementById('timeText').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        window.addEventListener('resize', () => {
            phaserGame.scale.resize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>